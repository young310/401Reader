{% extends "base.html" %}

{% block title %}支援工單列表{% endblock %}

{% block content %}
<div class="right_col" role="main" style="margin-top: -30px;">
  <div class="">
    <div class="page-title">
      <div class="title_left">
        <h3>支援工單列表</h3>
      </div>
      <div class="title_right">
        <button class="btn btn-primary" data-toggle="modal" data-target="#createTicketModal">
          <i class="fa fa-plus"></i> 建立新工單
        </button>
        {% if is_admin %}
        <a href="{{ url_for('support.admin_tickets') }}" class="btn btn-info">
          <i class="fa fa-dashboard"></i> 管理員控制台
        </a>
        {% endif %}
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
      <div class="col-md-12">
        <div class="x_panel">
          <div class="x_title">
            <h2><i class="fa fa-list"></i> 我的工單</h2>
            <div class="clearfix"></div>
          </div>

          <div class="x_content">
            <style>
              #ticketsTable td {
                white-space: nowrap;
              }
              #ticketsTable td:nth-child(2) {
                white-space: normal;
                max-width: 300px;
              }
            </style>
            <table id="ticketsTable" class="table table-striped table-bordered" style="width:100%">
              <thead>
                <tr>
                  <th>工單編號</th>
                  <th>主旨</th>
                  <th>類型</th>
                  <th>優先級</th>
                  <th>狀態</th>
                  <th>建立時間</th>
                  <th>最後更新</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                {% if tickets %}
                  {% for ticket in tickets %}
                  <tr>
                    <td><strong>{{ ticket.ticket_number }}</strong></td>
                    <td>{{ ticket.subject }}</td>
                    <td>
                      {% if ticket.category == 'system_error' %}系統錯誤
                      {% elif ticket.category == 'feature_request' %}功能請求
                      {% elif ticket.category == 'data_issue' %}資料問題
                      {% else %}其他{% endif %}
                    </td>
                    <td>
                      <span class="badge
                        {% if ticket.priority == 'urgent' %}badge-dark
                        {% elif ticket.priority == 'high' %}badge-danger
                        {% elif ticket.priority == 'medium' %}badge-warning
                        {% else %}badge-info{% endif %}">
                        {% if ticket.priority == 'urgent' %}緊急
                        {% elif ticket.priority == 'high' %}高
                        {% elif ticket.priority == 'medium' %}中
                        {% else %}低{% endif %}
                      </span>
                    </td>
                    <td>
                      <span class="badge
                        {% if ticket.status == 'new' %}badge-primary
                        {% elif ticket.status == 'in_progress' %}badge-warning
                        {% elif ticket.status == 'resolved' %}badge-success
                        {% else %}badge-secondary{% endif %}">
                        {% if ticket.status == 'new' %}新建
                        {% elif ticket.status == 'in_progress' %}處理中
                        {% elif ticket.status == 'resolved' %}已解決
                        {% else %}已關閉{% endif %}
                      </span>
                    </td>
                    <td><span class="local-time" data-utc="{{ ticket.created_at.isoformat() }}Z">{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</span></td>
                    <td>{% if ticket.updated_at %}<span class="local-time" data-utc="{{ ticket.updated_at.isoformat() }}Z">{{ ticket.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>{% else %}-{% endif %}</td>
                    <td>
                      <a href="{{ url_for('support.ticket_detail', ticket_id=ticket.id) }}" class="btn btn-sm btn-info">
                        <i class="fa fa-eye"></i> 查看
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8" class="text-center" style="padding: 40px;">
                      <i class="fa fa-inbox" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                      <p style="font-size: 16px; color: #999;">目前沒有工單資料</p>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include "support/create_ticket_modal.html" %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='build/js/pdfmake.min.js') }}"></script>
<script src="{{ url_for('static', filename='build/js/vfs_fonts.js') }}"></script>
<script src="{{ url_for('static', filename='build/js/datatables.min.js') }}"></script>
<script src="{{ url_for('static', filename='build/js/elvis_shd.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/dropzone/dist/dropzone-min.js') }}"></script>
<script>
$(document).ready(function() {
  // Convert UTC times to local timezone
  convertToLocalTime();
  
  update_office_dropdown('office', 'OfficeAddress', null, '{{ current_user.locale }}');
  $('#ticketsTable').DataTable({
    "order": [[5, "desc"]],
    "pageLength": 25,
    "autoWidth": false,
    "columnDefs": [
      { "width": "120px", "targets": 0 },  // 工單編號
      { "width": "auto", "targets": 1 },   // 主旨 (自動寬度)
      { "width": "80px", "targets": 2 },   // 類型
      { "width": "60px", "targets": 3 },   // 優先級
      { "width": "60px", "targets": 4 },   // 狀態
      { "width": "130px", "targets": 5 },  // 建立時間
      { "width": "130px", "targets": 6 },  // 最後更新
      { "width": "60px", "targets": 7 }    // 操作
    ],
    "language": {
      "emptyTable": "目前沒有工單資料",
      "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
      "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
      "infoFiltered": "(從 _MAX_ 項結果中過濾)",
      "lengthMenu": "顯示 _MENU_ 項結果",
      "loadingRecords": "載入中...",
      "processing": "處理中...",
      "search": "搜尋:",
      "zeroRecords": "沒有符合的工單記錄",
      "paginate": {
        "first": "第一頁",
        "last": "最後一頁",
        "next": "下一頁",
        "previous": "上一頁"
      },
      "aria": {
        "sortAscending": ": 升冪排列",
        "sortDescending": ": 降冪排列"
      }
    }
  });
});

function convertToLocalTime() {
  $('.local-time').each(function() {
    const utcTime = $(this).data('utc');
    if (utcTime) {
      try {
        const date = new Date(utcTime);
        const localTime = date.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        });
        $(this).text(localTime);
      } catch (e) {
        console.error('Error converting time:', e);
      }
    }
  });
}
</script>
{% endblock %}
