{% extends "base.html" %}

{% block title %}ç´€éŒ„èˆ‡ä¸‹è¼‰ - ç¨…å‹™è³‡æ–™è‡ªå‹•åŒ–å¹³å°{% endblock %}

{% block content %}
<div class="page-header-section">
    <h1>ç´€éŒ„èˆ‡ä¸‹è¼‰</h1>
    <p>æŸ¥çœ‹ç•¶å‰æ¡ˆä»¶çš„æ­·å²æ“ä½œè¨˜éŒ„ä¸¦ä¸‹è¼‰åŒ¯å‡ºæª”æ¡ˆ</p>
</div>

<!-- Case Info -->
<div class="alert alert-info" id="case-info-section" style="display: none;">
    <div class="row">
        <div class="col-md-4">
            <strong>ç•¶å‰æ¡ˆä»¶ï¼š</strong> <span id="case-client-name"></span>
        </div>
        <div class="col-md-4">
            <strong>å¹´åº¦ï¼š</strong> <span id="case-year"></span>
        </div>
        <div class="col-md-4">
            <strong>çµ±ç·¨ï¼š</strong> <span id="case-tax-id"></span>
        </div>
    </div>
</div>

<!-- Export History Table -->
<div class="card">
    <div class="card-header">
        <div class="clearfix">
            <div class="pull-left">
                <h3>åŒ¯å‡ºæ­·å²ç´€éŒ„</h3>
                <small class="text-muted">ğŸ’¡ æç¤ºï¼šå‹¾é¸ä¸‹æ–¹è¡¨æ ¼æœ€å·¦å´çš„æ–¹æ¡†ï¼Œå¯æ‰¹æ¬¡ä¸‹è¼‰æˆ–åˆªé™¤å¤šå€‹åŒ¯å‡ºç´€éŒ„</small>
            </div>
            <div class="pull-right">
                <span class="badge badge-info" id="selected-records-count" style="display: none; margin-right: 10px;">å·²é¸æ“‡ 0 ç­†</span>
                <button class="btn btn-default btn-sm" id="batch-download-btn" style="display: none; margin-right: 5px;">
                    <i class="fa fa-download"></i> æ‰¹æ¬¡ä¸‹è¼‰
                </button>
                <button class="btn btn-danger btn-sm" id="batch-delete-records-btn" style="display: none;">
                    <i class="fa fa-trash"></i> æ‰¹æ¬¡åˆªé™¤
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 50px; white-space: nowrap;">
                            <input type="checkbox" id="select-all-records">
                        </th>
                        <th class="text-center" style="width: 120px; white-space: nowrap;">åŒ¯å‡ºæ—¥æœŸ</th>
                        <th class="text-center" style="min-width: 200px; white-space: nowrap;">æª”æ¡ˆåç¨±</th>
                        <th class="text-center" style="min-width: 180px; white-space: nowrap;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>ç”³å ±æ›¸é¡å‹</span>
                                <select class="form-control input-sm" id="filter-doctype" style="width: 120px;">
                                    <option value="all">å…¨éƒ¨é¡å‹</option>
                                    <option value="401">401</option>
                                    <option value="403">403</option>
                                    <option value="withholding_income">æ‰£ç¹³(æ”¶å…¥)</option>
                                    <option value="withholding_expense">æ‰£ç¹³(æ”¯å‡º)</option>
                                </select>
                            </div>
                        </th>
                        <th class="text-center" style="width: 100px; white-space: nowrap;">åŒ¯å‡ºäººå“¡</th>
                        <th class="text-center" style="width: 80px; white-space: nowrap;">ç­†æ•¸</th>
                        <th class="text-center" style="width: 200px;">å‚™è¨»</th>
                        <th class="text-center" style="width: 120px; white-space: nowrap;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="records-table">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="clearfix" style="margin-top: 30px;">
    <div class="pull-left">
        <button class="btn btn-default" id="back-to-verification-btn" style="display: none;">
            <i class="fa fa-arrow-left"></i> è¿”å›æ ¡å°é é¢
        </button>
        <button class="btn btn-default" id="back-to-database-btn">
            <i class="fa fa-arrow-left"></i> è¿”å›è³‡æ–™åº«
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// API Base URL - FastAPI å¾Œç«¯æœå‹™
var API_BASE_URL = '/api';
var allVersions = [];  // æ‰€æœ‰ç‰ˆæœ¬è¨˜éŒ„
var selectedRecords = [];
var currentCaseId = null;  // ç•¶å‰æ¡ˆä»¶ ID
var currentCase = null;    // ç•¶å‰æ¡ˆä»¶è³‡è¨Š

// ç”³å ±æ›¸é¡å‹æ˜ å°„ï¼ˆtable_type â†’ ä¸­æ–‡åç¨±ï¼‰
var tableTypeLabels = {
    '401': 'ç‡Ÿæ¥­äººéŠ·å”®é¡èˆ‡ç¨…é¡ç”³å ±æ›¸ï¼ˆ401ï¼‰',
    '403': 'ç‡Ÿæ¥­äººéŠ·å”®é¡èˆ‡ç¨…é¡ç”³å ±æ›¸ï¼ˆ403ï¼‰',
    'withholding_income': 'å„é¡æ‰€å¾—æ‰£ç¹³æ†‘å–®ï¼ˆæ”¶å…¥ï¼‰',
    'withholding_expense': 'å„é¡æ‰€å¾—æ‰£ç¹³æ†‘å–®ï¼ˆæ”¯å‡ºï¼‰'
};

$(document).ready(function() {
    // å–å¾—ç•¶å‰æ¡ˆä»¶ ID
    currentCaseId = getCurrentCaseId();
    
    if (!currentCaseId) {
        showNotification('è«‹å…ˆå¾æ¡ˆä»¶ç¸½è¦½é¸æ“‡ä¸€å€‹æ¡ˆä»¶', 'warning');
        setTimeout(function() {
            window.location.href = '/dashboard';
        }, 2000);
        return;
    }

    // è¼‰å…¥æ¡ˆä»¶è³‡è¨Šå’Œç‰ˆæœ¬è¨˜éŒ„
    loadCaseInfo();
    loadVersions();

    // ç¯©é¸å™¨äº‹ä»¶
    $('#filter-doctype').on('change', function() {
        renderRecords();
    });

    // å…¨é¸
    $('#select-all-records').change(function() {
        var checked = $(this).prop('checked');
        if (checked) {
            selectedRecords = getFilteredRecords().map(function(r) { return r.id; });
        } else {
            selectedRecords = [];
        }
        renderRecords();
    });

    // æ‰¹æ¬¡ä¸‹è¼‰
    $('#batch-download-btn').click(function() {
        batchDownloadVersions();
    });

    // æ‰¹æ¬¡åˆªé™¤
    $('#batch-delete-records-btn').click(function() {
        batchDeleteVersions();
    });

    // è¿”å›æŒ‰éˆ•
    $('#back-to-database-btn').click(function() {
        if (currentCaseId) {
            window.location.href = '/database?case_id=' + currentCaseId;
        } else {
            window.location.href = '/dashboard';
        }
    });
});

// å–å¾—ç•¶å‰æ¡ˆä»¶ IDï¼ˆå¾ URL åƒæ•¸æˆ– localStorageï¼‰
function getCurrentCaseId() {
    var urlParams = new URLSearchParams(window.location.search);
    var caseId = urlParams.get('case_id');
    
    if (!caseId) {
        // å¾ localStorage è®€å–
        var storedCase = localStorage.getItem('selectedCase');
        if (storedCase) {
            try {
                var caseData = JSON.parse(storedCase);
                caseId = caseData.id;
            } catch (e) {
                console.warn('localStorage ä¸­çš„æ¡ˆä»¶è³‡æ–™æ ¼å¼éŒ¯èª¤');
                localStorage.removeItem('selectedCase');
            }
        }
    }
    
    return caseId;
}

// ============ API èª¿ç”¨å‡½æ•¸ ============

function loadCaseInfo() {
    if (!currentCaseId) return;
    
    $.ajax({
        url: API_BASE_URL + '/cases/' + currentCaseId,
        method: 'GET',
        success: function(caseData) {
            currentCase = caseData;
            showCaseInfo();
        },
        error: function(xhr, status, error) {
            console.error('è¼‰å…¥æ¡ˆä»¶è³‡è¨Šå¤±æ•—:', error);
            showNotification('è¼‰å…¥æ¡ˆä»¶è³‡è¨Šå¤±æ•—', 'danger');
        }
    });
}

function showCaseInfo() {
    if (!currentCase) return;
    
    $('#case-client-name').text(currentCase.client_name);
    $('#case-year').text(currentCase.year + ' å¹´åº¦');
    $('#case-tax-id').text(currentCase.tax_id);
    $('#case-info-section').show();
}

// ============ API èª¿ç”¨å‡½æ•¸ ============

function loadVersions() {
    if (!currentCaseId) return;
    
    showLoading();
    $.ajax({
        url: API_BASE_URL + '/versions/' + currentCaseId,
        method: 'GET',
        success: function(data) {
            allVersions = data;
            console.log('å·²è¼‰å…¥ ' + allVersions.length + ' ç­†ç‰ˆæœ¬è¨˜éŒ„');
            
            // ğŸ†• æª¢æŸ¥æ¯å€‹ç‰ˆæœ¬çš„ job_ids æ˜¯å¦æœ‰æ•ˆ
            checkVersionJobsValidity(function() {
                hideLoading();
                renderRecords();
            });
        },
        error: function(xhr, status, error) {
            hideLoading();
            console.error('è¼‰å…¥ç‰ˆæœ¬è¨˜éŒ„å¤±æ•—:', error);
            showNotification('è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—', 'danger');
            allVersions = [];
            renderRecords();
        }
    });
}

// ğŸ†• æª¢æŸ¥ç‰ˆæœ¬çš„ job_ids æ˜¯å¦æœ‰æ•ˆ
function checkVersionJobsValidity(callback) {
    var checkPromises = [];
    
    allVersions.forEach(function(version) {
        if (version.job_ids && version.job_ids.length > 0) {
            // æª¢æŸ¥é€™äº› job_ids æ˜¯å¦é‚„å­˜åœ¨
            var promise = $.ajax({
                url: API_BASE_URL + '/jobs?ids=' + version.job_ids.join(','),
                method: 'GET'
            }).then(function(jobs) {
                // å¦‚æœæ‰¾åˆ°çš„ jobs æ•¸é‡å°‘æ–¼ job_ids æ•¸é‡ï¼Œè¡¨ç¤ºæœ‰æª”æ¡ˆè¢«åˆªé™¤
                version.hasInvalidJobs = jobs.length < version.job_ids.length;
            }).catch(function() {
                version.hasInvalidJobs = true;
            });
            
            checkPromises.push(promise);
        } else {
            version.hasInvalidJobs = false;
        }
    });
    
    // ç­‰å¾…æ‰€æœ‰æª¢æŸ¥å®Œæˆ
    $.when.apply($, checkPromises).always(function() {
        callback();
    });
}

function deleteVersion(versionId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç‰ˆæœ¬è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
    }

    showLoading();
    $.ajax({
        url: API_BASE_URL + '/versions/' + versionId,
        method: 'DELETE',
        success: function(response) {
            hideLoading();
            showNotification('å·²åˆªé™¤ç‰ˆæœ¬è¨˜éŒ„', 'success');
            loadVersions();  // é‡æ–°è¼‰å…¥
        },
        error: function(xhr, status, error) {
            hideLoading();
            console.error('åˆªé™¤ç‰ˆæœ¬è¨˜éŒ„å¤±æ•—:', error);
            showNotification('åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
        }
    });
}

function batchDeleteVersions() {
    if (selectedRecords.length === 0) {
        showNotification('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è¨˜éŒ„', 'warning');
        return;
    }

    if (!confirm('ç¢ºå®šè¦åˆªé™¤é¸æ“‡çš„ ' + selectedRecords.length + ' ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
    }

    showLoading();
    var deletePromises = selectedRecords.map(function(versionId) {
        return $.ajax({
            url: API_BASE_URL + '/versions/' + versionId,
            method: 'DELETE'
        });
    });

    $.when.apply($, deletePromises).done(function() {
        hideLoading();
        showNotification('å·²åˆªé™¤ ' + selectedRecords.length + ' ç­†è¨˜éŒ„', 'success');
        selectedRecords = [];
        loadVersions();
    }).fail(function() {
        hideLoading();
        showNotification('éƒ¨åˆ†è¨˜éŒ„åˆªé™¤å¤±æ•—', 'danger');
        loadVersions();
    });
}

function downloadVersion(versionId) {
    var version = allVersions.find(function(v) { return v.id === versionId; });
    if (!version) {
        showNotification('æ‰¾ä¸åˆ°è©²ç‰ˆæœ¬è¨˜éŒ„', 'danger');
        return;
    }

    showLoading();
    // ä¸‹è¼‰ Excel æª”æ¡ˆ
    window.location.href = API_BASE_URL + '/versions/' + versionId + '/download';
    setTimeout(function() {
        hideLoading();
        showNotification('å·²ä¸‹è¼‰ï¼š' + version.file_name, 'success');
    }, 1000);
}

function batchDownloadVersions() {
    if (selectedRecords.length === 0) {
        showNotification('è«‹å…ˆé¸æ“‡è¦ä¸‹è¼‰çš„è¨˜éŒ„', 'warning');
        return;
    }

    showNotification('æ­£åœ¨æ‰¹æ¬¡ä¸‹è¼‰ ' + selectedRecords.length + ' å€‹æª”æ¡ˆ...', 'info');

    selectedRecords.forEach(function(versionId, index) {
        setTimeout(function() {
            downloadVersion(versionId);
        }, index * 500);  // å»¶é²ä¸‹è¼‰é¿å…åŒæ™‚è§¸ç™¼
    });

    selectedRecords = [];
    renderRecords();
}

// ============ æ¸²æŸ“èˆ‡ç¯©é¸å‡½æ•¸ ============

function getFilteredRecords() {
    var docTypeFilter = $('#filter-doctype').val();

    return allVersions.filter(function(v) {
        // ç”³å ±æ›¸é¡å‹ç¯©é¸ï¼ˆä½¿ç”¨ table_typeï¼‰
        return docTypeFilter === 'all' || v.table_type === docTypeFilter;
    });
}

function renderRecords() {
    var filtered = getFilteredRecords();

    // æ›´æ–° UI æŒ‰éˆ•é¡¯ç¤º
    if (selectedRecords.length > 0) {
        $('#selected-records-count').show().text('å·²é¸æ“‡ ' + selectedRecords.length + ' ç­†');
        $('#batch-download-btn, #batch-delete-records-btn').show();
    } else {
        $('#selected-records-count').hide();
        $('#batch-download-btn, #batch-delete-records-btn').hide();
    }

    if (filtered.length === 0) {
        $('#records-table').html(
            '<tr><td colspan="8" class="text-center" style="padding: 60px 0;">' +
            '<i class="fa fa-file-o" style="font-size: 48px; color: #ccc;"></i>' +
            '<p class="text-muted" style="margin-top: 15px;">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p>' +
            '</td></tr>'
        );
        return;
    }

    var html = '';
    filtered.forEach(function(v) {
        var isSelected = selectedRecords.includes(v.id);

        // æ ¼å¼åŒ–æ—¥æœŸ
        var exportDate = v.created_at ? v.created_at.substring(0, 10) : '';

        // ç”³å ±æ›¸é¡å‹æ¨™ç±¤ï¼ˆä½¿ç”¨ table_typeï¼‰
        var tableTypeLabel = tableTypeLabels[v.table_type] || v.table_type || 'æœªçŸ¥é¡å‹';

        // ğŸ†• æª¢æŸ¥ç‰ˆæœ¬æ˜¯å¦æœ‰ job_idsï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯å¦å¯ä»¥é‡æ–°é–‹å•Ÿæ ¡å°é é¢ï¼‰
        var hasJobIds = v.job_ids && v.job_ids.length > 0;
        var hasInvalidJobs = v.hasInvalidJobs === true;
        
        // å¦‚æœæœ‰ç„¡æ•ˆçš„ jobsï¼Œç¦ç”¨æŸ¥çœ‹æŒ‰éˆ• - æ”¹ç‚ºå°åœ–ç¤ºæŒ‰éˆ•
        var viewButtonHtml = hasJobIds && !hasInvalidJobs
            ? '<button class="btn btn-default btn-xs" onclick="viewVersion(' + v.id + ')" style="margin-right: 3px; padding: 2px 6px;" title="è¿”å›æ ¡å°é é¢ç·¨è¼¯èˆ‡æŸ¥çœ‹">' +
              '<i class="fa fa-pencil"></i></button>'
            : '<button class="btn btn-default btn-xs" disabled title="æ­¤ç‰ˆæœ¬ç„¡æ³•é‡æ–°é–‹å•Ÿï¼ˆåŸå§‹æª”æ¡ˆå·²åˆªé™¤ï¼‰" style="margin-right: 3px; padding: 2px 6px;">' +
              '<i class="fa fa-pencil"></i></button>';

        // ğŸ†• åªæœ‰åœ¨æª”æ¡ˆçœŸçš„è¢«åˆªé™¤æ™‚æ‰é¡¯ç¤ºè­¦å‘Šåœ–ç¤º
        var warningIcon = hasInvalidJobs
            ? '<i class="fa fa-exclamation-triangle text-warning" title="æ­¤ç‰ˆæœ¬çš„åŸå§‹æª”æ¡ˆå·²è¢«åˆªé™¤ï¼Œç„¡æ³•æŸ¥çœ‹é é¢" style="margin-left: 5px; cursor: help;" data-toggle="tooltip" data-placement="top"></i>'
            : '';

        html += '<tr>' +
                '<td class="text-center" style="white-space: nowrap;">' +
                '<input type="checkbox" class="record-checkbox" data-id="' + v.id + '" ' +
                (isSelected ? 'checked' : '') + '>' +
                '</td>' +
                '<td class="text-center" style="white-space: nowrap;">' +
                '<i class="fa fa-clock-o" style="margin-right: 5px; color: #7f8c8d;"></i>' +
                exportDate +
                '</td>' +
                '<td class="text-center" style="white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="' + (v.file_name || 'æœªå‘½å') + '">' +
                '<i class="fa fa-file-text-o" style="margin-right: 5px; color: #3498db;"></i>' +
                (v.file_name || 'æœªå‘½å') + warningIcon +
                '</td>' +
                '<td class="text-center" style="white-space: nowrap;">' +
                '<span class="badge badge-default">' + tableTypeLabel + '</span>' +
                '</td>' +
                '<td class="text-center" style="white-space: nowrap;">' + (v.creator_name || 'æœªçŸ¥') + '</td>' +
                '<td class="text-center" style="white-space: nowrap;">' +
                '<span class="badge badge-info">' + (v.record_count || 0) + '</span>' +
                '</td>' +
                '<td class="text-center text-muted" style="word-wrap: break-word; max-width: 200px;">' + (v.notes || '') + '</td>' +
                '<td class="text-center" style="white-space: nowrap;">' +
                viewButtonHtml +
                '<button class="btn btn-primary btn-xs" onclick="downloadVersion(' + v.id + ')" style="margin-right: 3px; padding: 2px 6px;" title="ä¸‹è¼‰">' +
                '<i class="fa fa-download"></i>' +
                '</button>' +
                '<button class="btn btn-danger btn-xs" onclick="deleteVersion(' + v.id + ')" style="padding: 2px 6px;" title="åˆªé™¤">' +
                '<i class="fa fa-trash"></i>' +
                '</button>' +
                '</td>' +
                '</tr>';
    });

    $('#records-table').html(html);

    // åˆå§‹åŒ– tooltip
    $('[data-toggle="tooltip"]').tooltip();

    // ç¶å®š checkbox äº‹ä»¶
    $('.record-checkbox').change(function() {
        var id = parseInt($(this).data('id'));
        if ($(this).prop('checked')) {
            if (!selectedRecords.includes(id)) {
                selectedRecords.push(id);
            }
        } else {
            selectedRecords = selectedRecords.filter(function(recordId) { return recordId !== id; });
        }
        renderRecords();
    });
}

function viewVersion(versionId) {
    var version = allVersions.find(function(v) { return v.id === versionId; });

    if (!version) {
        showNotification('æ‰¾ä¸åˆ°è©²ç‰ˆæœ¬è¨˜éŒ„', 'danger');
        return;
    }

    showNotification('è·³è½‰åˆ°æ ¡å°é é¢', 'info');

    // ä½¿ç”¨ job_ids é‡æ–°é–‹å•Ÿæ ¡å°é é¢
    if (version.job_ids && version.job_ids.length > 0) {
        // æœ‰ job_idsï¼Œä½¿ç”¨ jobIds åƒæ•¸é–‹å•Ÿï¼ˆå¯ç·¨è¼¯æ¨¡å¼ï¼‰
        var jobIdsParam = version.job_ids.join(',');
        window.location.href = '/verification?case_id=' + version.case_id + '&jobIds=' + jobIdsParam + '&from_version=true';
    } else {
        // æ²’æœ‰ job_idsï¼Œä½¿ç”¨ version_id åƒæ•¸é–‹å•Ÿï¼ˆå”¯è®€æ¨¡å¼ï¼‰
        window.location.href = '/verification?case_id=' + version.case_id + '&version_id=' + versionId;
    }
}
</script>
{% endblock %}
