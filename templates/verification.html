{% extends "base.html" %}

{% block title %}ç¨…å‹™è³‡æ–™ - è‡ªå‹•åŒ–å¹³å°{% endblock %}

{% block extra_css %}
<style>
    /* ğŸ†• é ç¢¼æ¬„ä½æ¨£å¼ */
    .page-number-column {
        font-weight: 500;
        color: #555;
    }

    /* ğŸ”§ æ–°å¢æŒ‰éˆ•åˆ—æ¨£å¼ */
    .add-record-row {
        background: #f9f9f9 !important;
    }

    .add-record-row td {
        padding: 8px !important;
        text-align: left !important;
    }

    /* å°è¨ˆåˆ—æ¨£å¼ */
    .subtotal-row {
        background: #e8f4f8 !important;
        font-weight: bold;
        border-top: 2px solid #3498db;
    }

    .subtotal-row td {
        background: #e8f4f8 !important;
    }

    /* ç¨…ç‡æ¬„ä½æ¨£å¼ */
    .tax-rate-column {
        width: 80px;
        text-align: center;
    }

    /* ğŸ†• é …ç›®ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    .item-name-cell {
        padding: 4px !important;
        vertical-align: middle !important;
    }

    .item-name-select {
        border: 1px solid #f39c12 !important;
        background: #fff9e6 !important;
        font-size: 13px;
        height: 30px;
        padding: 4px 8px;
    }

    .item-name-select:focus {
        border-color: #e67e22 !important;
        box-shadow: 0 0 5px rgba(230, 126, 34, 0.3) !important;
    }

    /* ğŸ†• è­¦å‘Šåœ–ç¤ºæ¨£å¼ */
    .warning-icon {
        animation: pulse 2s infinite;
        transition: transform 0.2s;
    }

    .warning-icon:hover {
        transform: scale(1.2);
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.6;
        }
    }

    /* ğŸ†• è­¦å‘Š Modal æ¨£å¼ */
    #warningModal .modal-content {
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    #warningModal .modal-header {
        border-radius: 8px 8px 0 0;
    }

    #warningModal .modal-body {
        font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header-section">
    <h1>AIè¾¨è­˜æ ¡å°</h1>
    <p>æŸ¥æ ¸ä¸¦ç·¨è¼¯OCRè¾¨è­˜çµæœ</p>
</div>

<!-- Case Info -->
<div class="alert alert-info" id="case-info-section" style="display: none;">
    <div class="row">
        <div class="col-md-3">
            <strong>ç•¶å‰æ¡ˆä»¶ï¼š</strong> <span id="case-client-name"></span>
        </div>
        <div class="col-md-3">
            <strong>å¹´åº¦ï¼š</strong> <span id="case-year"></span>
        </div>
        <div class="col-md-3">
            <strong>çµ±ç·¨ï¼š</strong> <span id="case-tax-id"></span>
        </div>
    </div>
</div>
<div class="alert alert-warning" id="no-case-warning" style="display: none;">
    <i class="fa fa-exclamation-triangle"></i> è«‹å…ˆå¾æ¡ˆä»¶ç¸½è¦½é¸æ“‡ä¸€å€‹æ¡ˆä»¶
</div>

<!-- Recognition Results -->
<div class="card">
    <div class="card-header">
        <!-- ç¬¬ä¸€è¡Œï¼šæ¨™é¡Œå’Œæ“ä½œæŒ‰éˆ• -->
        <div class="clearfix" style="margin-bottom: 10px;">
            <div class="pull-left">
                <h3 id="doc-title" style="margin: 0; line-height: 34px;">ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸</h3>
            </div>
            <div class="pull-right">
                <button class="btn btn-default btn-sm" id="edit-btn">
                    <i class="fa fa-edit"></i> ç·¨è¼¯
                </button>
                <button class="btn btn-success btn-sm" id="save-btn" style="display: none;">
                    <i class="fa fa-save"></i> å„²å­˜
                </button>
                <button class="btn btn-primary btn-sm" id="create-version-btn" data-toggle="modal"
                    data-target="#versionModal">
                    <i class="fa fa-code-fork"></i> å»ºç«‹ç‰ˆæœ¬
                </button>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šç­†æ•¸ã€ç¯©é¸å™¨å’Œæª”æ¡ˆä¾†æºæŒ‰éˆ• -->
        <div class="clearfix" style="margin-bottom: 10px;">
            <div class="pull-left" style="display: flex; align-items: center; gap: 15px;">
                <p class="text-muted" style="margin: 0;">
                    <span id="record-count">3</span> ç­†è³‡æ–™
                </p>
                <select class="form-control input-sm" id="file-filter" style="display: none; width: 250px;">
                    <option value="all">å…¨éƒ¨æª”æ¡ˆ</option>
                </select>
                <button class="btn btn-info btn-sm" id="toggle-file-source-btn" style="display: none;">
                    <i class="fa fa-file-text-o"></i> é¡¯ç¤ºæª”æ¡ˆä¾†æº
                </button>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šé‡è¦æé†’ -->
        <div class="alert alert-warning" id="edit-mode-alert" style="margin: 0; padding: 10px 15px;">
            âš ï¸ <strong>é‡è¦æé†’ï¼š</strong>æ­¤é é¢ä¸æœƒè‡ªå‹•å„²å­˜ï¼Œç·¨è¼¯å¾Œè«‹å‹™å¿…æŒ‰ä¸‹ã€Œå„²å­˜ã€æŒ‰éˆ•ï¼Œä¸¦ä½¿ç”¨ã€Œå»ºç«‹ç‰ˆæœ¬ã€åŠŸèƒ½ï¼Œä¹‹å¾Œå¯åœ¨ç´€éŒ„èˆ‡ä¸‹è¼‰é é¢æŸ¥çœ‹èˆ‡ä¸‹è¼‰ã€‚
        </div>
        <div class="alert alert-info" id="view-from-version-alert"
            style="margin: 0; padding: 10px 15px; display: none;">
            â„¹ï¸ <strong>é‡è¦æé†’ï¼š</strong>ç·¨è¼¯å¾Œè«‹é»æ“Šã€Œå„²å­˜ã€æ›´æ–°è³‡æ–™ï¼Œä¸¦æŒ‰ä¸‹ã€Œå»ºç«‹ç‰ˆæœ¬ã€å»ºç«‹æ–°ç‰ˆæœ¬ï¼Œæ­¤æ›´å‹•ä¸æœƒå½±éŸ¿èˆŠæœ‰ç‰ˆæœ¬ã€‚
        </div>
    </div>
    <div class="card-body">
        <!-- ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸è¡¨æ ¼ (401) -->
        <div id="table-401" class="table-container">
            <!-- éŠ·é …è³‡æ–™ -->
            <div style="margin-bottom: 30px;">
                <h4
                    style="background: #f8f9fa; padding: 10px 15px; border-left: 4px solid #3498db; margin-bottom: 15px;">
                    éŠ·é …è³‡æ–™</h4>
                <div class="table-responsive">
                    <table class="table table-bordered" id="sales-table">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 100px;">æœˆä»½
                                </th>
                                <th colspan="5" class="text-center" style="border-right: 2px solid #dee2e6;">ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    ç‰¹ç¨®ç¨…é¡<br>éŠ·å”®é¡</th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 100px;">å…¶ä»–
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    éŠ·å”®é¡åˆè¨ˆ</th>
                                <th colspan="3" class="text-center" style="border-left: 2px solid #dee2e6;">éŠ·è²¨é€€å›åŠæŠ˜è®“
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    éŠ·è²¨é€€å›<br>åŠæŠ˜è®“åˆè¨ˆ</th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">æ·¨é¡
                                </th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th colspan="2" class="text-center">æ‡‰ç¨…</th>
                                <th colspan="2" class="text-center">é›¶ç¨…ç‡</th>
                                <th rowspan="2" class="text-center"
                                    style="vertical-align: middle; border-right: 2px solid #dee2e6;">å…ç¨…</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px; border-left: 2px solid #dee2e6;">ä¸€èˆ¬</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">é›¶ç¨…ç‡</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">ç‰¹ç¨®</th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th class="text-center" style="min-width: 120px;">ä¸‰è¯å¼</th>
                                <th class="text-center" style="min-width: 120px;">äºŒè¯å¼</th>
                                <th class="text-center" style="min-width: 120px;">éç¶“æµ·é—œ</th>
                                <th class="text-center" style="min-width: 120px;">ç¶“æµ·é—œ</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- é€²é …è³‡æ–™ -->
            <div>
                <h4
                    style="background: #f8f9fa; padding: 10px 15px; border-left: 4px solid #27ae60; margin-bottom: 15px;">
                    é€²é …è³‡æ–™</h4>
                <div class="table-responsive">
                    <table class="table table-bordered" id="purchase-table">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">æœˆä»½
                                </th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">
                                    å¾—æ‰£æŠµè¼‰æœ‰é€²é …ç¨…é¡ä¹‹æ†‘è­‰</th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">é€€å›æŠ˜è®“</th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">åˆè¨ˆ</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    é€²å£è²¨ç‰©é‡‘é¡</th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                            </tr>
                        </thead>
                        <tbody id="purchase-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸è¡¨æ ¼ (403) -->
        <div id="table-403" class="table-container" style="display: none;">
            <!-- éŠ·é …è³‡æ–™ -->
            <div style="margin-bottom: 30px;">
                <h4
                    style="background: #f8f9fa; padding: 10px 15px; border-left: 4px solid #3498db; margin-bottom: 15px;">
                    éŠ·é …è³‡æ–™</h4>
                <div class="table-responsive">
                    <table class="table table-bordered" id="sales-table-403">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 100px;">æœˆä»½
                                </th>
                                <th colspan="5" class="text-center" style="border-right: 2px solid #dee2e6;">ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    ç‰¹ç¨®ç¨…é¡<br>éŠ·å”®é¡</th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 100px;">å…¶ä»–
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    éŠ·å”®é¡åˆè¨ˆ</th>
                                <th colspan="3" class="text-center" style="border-left: 2px solid #dee2e6;">éŠ·è²¨é€€å›åŠæŠ˜è®“
                                </th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    éŠ·è²¨é€€å›<br>åŠæŠ˜è®“åˆè¨ˆ</th>
                                <th rowspan="3" class="text-center" style="vertical-align: middle; min-width: 120px;">æ·¨é¡
                                </th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th colspan="2" class="text-center">æ‡‰ç¨…</th>
                                <th colspan="2" class="text-center">é›¶ç¨…ç‡</th>
                                <th rowspan="2" class="text-center"
                                    style="vertical-align: middle; border-right: 2px solid #dee2e6;">å…ç¨…</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px; border-left: 2px solid #dee2e6;">ä¸€èˆ¬</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">é›¶ç¨…ç‡</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">ç‰¹ç¨®</th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th class="text-center" style="min-width: 120px;">ä¸‰è¯å¼</th>
                                <th class="text-center" style="min-width: 120px;">äºŒè¯å¼</th>
                                <th class="text-center" style="min-width: 120px;">éç¶“æµ·é—œ</th>
                                <th class="text-center" style="min-width: 120px;">ç¶“æµ·é—œ</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody-403">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- é€²é …è³‡æ–™ -->
            <div>
                <h4
                    style="background: #f8f9fa; padding: 10px 15px; border-left: 4px solid #27ae60; margin-bottom: 15px;">
                    é€²é …è³‡æ–™</h4>
                <div class="table-responsive">
                    <table class="table table-bordered" id="purchase-table-403">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 100px;">æœˆä»½
                                </th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">
                                    å¾—æ‰£æŠµè¼‰æœ‰é€²é …ç¨…é¡ä¹‹æ†‘è­‰</th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">é€€å›æŠ˜è®“</th>
                                <th colspan="2" class="text-center" style="border-right: 2px solid #dee2e6;">åˆè¨ˆ</th>
                                <th rowspan="2" class="text-center" style="vertical-align: middle; min-width: 120px;">
                                    é€²å£å…ç¨…è²¨ç‰©é‡‘é¡</th>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                                <th class="text-center" style="min-width: 120px;">é€²è²¨åŠè²»ç”¨</th>
                                <th class="text-center" style="min-width: 120px; border-right: 2px solid #dee2e6;">å›ºå®šè³‡ç”¢
                                </th>
                            </tr>
                        </thead>
                        <tbody id="purchase-tbody-403">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ‰£ç¹³æ†‘å–®è¡¨æ ¼ (æ”¯å‡ºé¢/æ”¶å…¥é¢) -->
        <div id="table-withholding" class="table-container" style="display: none;">
            <!-- Tab åˆ‡æ›ï¼ˆå·²ç§»é™¤ï¼Œå› ç‚ºä¸æœƒåŒæ™‚æœ‰æ”¯å‡ºå’Œæ”¶å…¥ï¼‰ -->

            <div class="table-responsive">
                <table class="table table-bordered" id="withholding-table">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th class="text-center file-source-column" style="min-width: 180px; display: none;">æª”æ¡ˆä¾†æº
                            </th>
                            <th class="text-center page-number-column" style="min-width: 80px; display: none;">é ç¢¼</th>
                            <th class="text-center" style="min-width: 140px;">é …ç›®</th>
                            <th class="text-center" style="min-width: 120px;">åº•ç¨¿ç´¢å¼•</th>
                            <th class="text-center" style="min-width: 260px;">æ‰£ç¹³å–®ä½åç¨±</th>
                            <th class="text-center" style="min-width: 180px;">æ‰€å¾—é¡åˆ¥</th>
                            <th class="text-center" style="min-width: 160px;" id="amount-header">å„é¡çµ¦ä»˜ç¸½é¡</th>
                            <th class="text-center" style="min-width: 140px;">æ‰£ç¹³ç¨…é¡</th>
                            <th class="text-center tax-rate-column" style="width: 80px;">ç¨…ç‡</th>
                            <th class="text-center action-column" style="width: 80px; display: none;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="withholding-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ†• éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
<div id="error-container" style="margin-top: 20px; display: none;"></div>

<!-- Navigation -->
<div class="clearfix" style="margin-top: 30px;">
    <div class="pull-left">
        <button class="btn btn-default" id="back-to-database-btn" style="display: none;">
            <i class="fa fa-arrow-left"></i> è¿”å›è³‡æ–™åº«
        </button>
        <button class="btn btn-default" id="back-to-dashboard-btn" style="display: none;">
            <i class="fa fa-arrow-left"></i> è¿”å›æ¡ˆä»¶ç¸½è¦½
        </button>
    </div>
    <div class="pull-right">
        <button class="btn btn-primary" id="goto-history-btn">
            æŸ¥çœ‹æ“ä½œç´€éŒ„ <i class="fa fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Version Modal -->
<div class="modal fade" id="versionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">å»ºç«‹æ–°ç‰ˆæœ¬</h4>
            </div>
            <div class="modal-body">
                <form id="version-form">
                    <div class="form-group">
                        <label>æ–‡ä»¶é¡å‹</label>
                        <input type="text" class="form-control" id="modal-doc-type" disabled>
                    </div>
                    <div class="form-group">
                        <label>æ¡ˆä»¶åç¨±</label>
                        <input type="text" class="form-control" id="modal-case-name" value="æœªé¸æ“‡æ¡ˆä»¶" disabled>
                    </div>
                    <div class="form-group">
                        <label>è³‡æ–™ç­†æ•¸</label>
                        <input type="text" class="form-control" id="modal-record-count" disabled>
                    </div>
                    <div class="form-group">
                        <label>æª”æ¡ˆåç¨± <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="version-filename"
                            placeholder="è«‹è¼¸å…¥æª”æ¡ˆåç¨±ï¼Œä¾‹å¦‚ï¼š2024Q1ç‡Ÿæ¥­ç¨…ç”³å ±è³‡æ–™">
                    </div>
                    <div class="form-group">
                        <label>ç‰ˆæœ¬å‚™è¨»</label>
                        <textarea class="form-control" id="version-notes" rows="3" style="resize: none; overflow: hidden;"
                            placeholder="è«‹è¼¸å…¥ç‰ˆæœ¬å‚™è¨»ï¼Œä¾‹å¦‚ï¼šä¿®æ­£ç¬¬ä¸€å­£åº¦è³‡æ–™ã€æ›´æ–°æ‰£ç¹³ç¨…é¡ç­‰..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <label>
                            <input type="checkbox" id="amount-confirm">
                            ç¢ºèªé‡‘é¡ç„¡èª¤ <span class="text-danger">*</span>
                        </label>
                        <p class="small" style="margin: 5px 0 0 20px;">æˆ‘å·²ä»”ç´°æª¢æŸ¥ä¸¦ç¢ºèªè¡¨æ ¼ä¸­çš„æ¯ä¸€æ ¼é‡‘é¡æ•¸æ“šéƒ½æ­£ç¢ºç„¡èª¤ï¼Œå¯ä»¥å»ºç«‹æ­¤ç‰ˆæœ¬ã€‚</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirm-create-version-btn">ç¢ºå®šå»ºç«‹</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ†• æ–°å¢è¨˜éŒ„å°è©±æ¡† -->
<div class="modal fade" id="addRecordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">æ–°å¢è¨˜éŒ„</h4>
            </div>
            <div class="modal-body">
                <form id="add-record-form">
                    <div class="form-group">
                        <label>é …ç›® <span class="text-danger">*</span></label>
                        <select class="form-control" id="new-record-item-name" required>
                            <option value="">è«‹é¸æ“‡é …ç›®</option>
                            <option value="è–ªè³‡">è–ªè³‡</option>
                            <option value="åŸ·è¡Œæ¥­å‹™å ±é…¬">åŸ·è¡Œæ¥­å‹™å ±é…¬</option>
                            <option value="åˆ©æ¯">åˆ©æ¯</option>
                            <option value="ç§Ÿè³ƒ">ç§Ÿè³ƒ</option>
                            <option value="æ¬Šåˆ©é‡‘">æ¬Šåˆ©é‡‘</option>
                            <option value="è‚¡åˆ©">è‚¡åˆ©</option>
                            <option value="ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç">ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç</option>
                            <option value="é€€è·æ‰€å¾—">é€€è·æ‰€å¾—</option>
                            <option value="è²¡ç”¢äº¤æ˜“">è²¡ç”¢äº¤æ˜“</option>
                            <option value="å…¶ä»–æ‰€å¾—">å…¶ä»–æ‰€å¾—</option>
                            <option value="é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸">é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æª”æ¡ˆåç¨± <span class="text-danger">*</span></label>
                        <select class="form-control" id="new-record-file-name" required>
                            <option value="">è«‹é¸æ“‡æª”æ¡ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é ç¢¼ <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="new-record-page-number" 
                               min="1" placeholder="è«‹è¼¸å…¥é ç¢¼" required>
                        <small class="text-muted" id="page-number-hint"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirm-add-record-btn">ç¢ºå®šæ–°å¢</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Base URL - FastAPI å¾Œç«¯æœå‹™
    var API_BASE_URL = '/api';

    // å…¨åŸŸè®Šæ•¸
    var currentCase = null;
    var caseId = null;
    var jobIds = [];  // å¾ URL åƒæ•¸è®€å–çš„ job IDs
    var allJobs = [];  // å¾ API è¼‰å…¥çš„æ‰€æœ‰ Jobs
    var currentTableData = [];  // ç•¶å‰é¡¯ç¤ºçš„è¡¨æ ¼è³‡æ–™
    var currentDocType = null;  // ç•¶å‰æ–‡ä»¶é¡å‹
    var isEditMode = false;
    var isViewMode = false;  // æ˜¯å¦ç‚ºæŸ¥çœ‹æ¨¡å¼ï¼ˆå¾ç‰ˆæœ¬è¼‰å…¥ï¼‰
    var withholdingView = 'expense';  // 'expense' or 'income'
    var viewMode = 'all';  // 'all' or 'single'
    var selectedJobId = null;  // ç•¶å‰é¸æ“‡çš„å–®ä¸€ Job IDï¼ˆç”¨æ–¼ single æ¨¡å¼ï¼‰

    // ============ ğŸ†• è­¦å‘Šå°è©±æ¡†å‡½æ•¸ ============
    
    // é¡¯ç¤ºè­¦å‘Šå°è©±æ¡†
    function showWarningDialog(month, warnings) {
        var modalHtml = `
            <div class="modal fade" id="warningModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header" style="background-color: #f39c12; color: white;">
                            <button type="button" class="close" data-dismiss="modal">
                                <span style="color: white;">&times;</span>
                            </button>
                            <h4 class="modal-title">
                                <i class="fa fa-exclamation-triangle"></i> è«‹æª¢æŸ¥
                            </h4>
                        </div>
                        <div class="modal-body" style="padding: 30px; text-align: center;">
                            <p style="font-size: 16px; margin-bottom: 20px; color: #666;">
                                <strong>${month}</strong> çš„ä»¥ä¸‹é …ç›®å¯èƒ½æœ‰èª¤ï¼š
                            </p>
                            <p style="font-size: 24px; color: #f39c12; font-weight: bold; margin: 20px 0;">
                                ${warnings}
                            </p>
                            <p style="margin-top: 20px; color: #999; font-size: 14px;">
                                å»ºè­°é‡æ–°ç¢ºèªè¡¨å–®æ•¸å€¼
                            </p>
                        </div>
                        <div class="modal-footer" style="text-align: center; border-top: none;">
                            <button type="button" class="btn btn-primary btn-lg" id="acknowledge-warning-btn" style="min-width: 150px;">
                                æˆ‘çŸ¥é“äº†
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        $('#warningModal').remove();
        $('body').append(modalHtml);
        $('#warningModal').modal('show');
        
        $('#acknowledge-warning-btn').click(function() {
            acknowledgeWarning(month);
            $('#warningModal').modal('hide');
        });
    }

    // ç¢ºèªè­¦å‘Š
    function acknowledgeWarning(month) {
        var record = currentTableData.find(r => r.month === month);
        if (!record) return;
        
        record.warnings_acknowledged = true;
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        if ($('#table-401').is(':visible')) {
            render401Table();
        } else if ($('#table-403').is(':visible')) {
            render403Table();
        }
        
        // ç™¼é€ API æ›´æ–°è³‡æ–™åº«
        updateWarningAcknowledgement(record);
    }

    // æ›´æ–°è­¦å‘Šç¢ºèªç‹€æ…‹åˆ°è³‡æ–™åº«
    function updateWarningAcknowledgement(record) {
        // æ‰¾åˆ°å°æ‡‰çš„ Job
        var job = allJobs.find(j => {
            var json = j.result_json;
            if (json.é é¢è³‡æ–™) {
                return json.é é¢è³‡æ–™.some(p => extractMonthPeriod(p.æ‰€å±¬å¹´æœˆä»½)?.display === record.month);
            } else {
                return extractMonthPeriod(json.æ‰€å±¬å¹´æœˆä»½)?.display === record.month;
            }
        });
        
        if (!job) {
            console.warn('æ‰¾ä¸åˆ°å°æ‡‰çš„ Job:', record.month);
            return;
        }
        
        var updatedJson = JSON.parse(JSON.stringify(job.result_json));
        
        if (updatedJson.é é¢è³‡æ–™) {
            updatedJson.é é¢è³‡æ–™.forEach(function(pageData) {
                var monthPeriod = extractMonthPeriod(pageData.æ‰€å±¬å¹´æœˆä»½);
                if (monthPeriod?.display === record.month) {
                    pageData.warnings_acknowledged = true;
                }
            });
        } else {
            updatedJson.warnings_acknowledged = true;
        }
        
        $.ajax({
            url: API_BASE_URL + '/jobs/' + job.id + '/result',
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({
                ocr_result: updatedJson,
                status: 'COMPLETED',
                save_as_new_version: false
            }),
            success: function() {
                console.log('âœ… è­¦å‘Šç¢ºèªç‹€æ…‹å·²æ›´æ–°');
                showNotification('å·²ç¢ºèªè­¦å‘Š', 'success');
            },
            error: function(xhr, status, error) {
                console.error('âŒ æ›´æ–°è­¦å‘Šç¢ºèªç‹€æ…‹å¤±æ•—:', error);
                showNotification('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
            }
        });
    }

    $(document).ready(function () {
        // å¾ URL åƒæ•¸è®€å– case_idã€jobIdsã€version_idã€from_version å’Œ view_mode
        var urlParams = new URLSearchParams(window.location.search);
        caseId = urlParams.get('case_id');
        var jobIdsParam = urlParams.get('jobIds');
        var versionId = urlParams.get('version_id');
        var fromVersion = urlParams.get('from_version') === 'true';
        viewMode = urlParams.get('view_mode') || 'all';

        if (!caseId) {
            // å˜—è©¦å¾ localStorage è®€å–
            var storedCase = localStorage.getItem('selectedCase');
            if (storedCase) {
                currentCase = JSON.parse(storedCase);
                caseId = currentCase.id;
            }
        }

        if (jobIdsParam) {
            jobIds = jobIdsParam.split(',').map(function (id) { return parseInt(id); });
        }

        // å¦‚æœæ˜¯ single æ¨¡å¼ï¼Œè¨­å®š selectedJobId
        if (viewMode === 'single' && jobIds.length > 0) {
            selectedJobId = jobIds[0];
        }

        // æ ¹æ“š viewMode æ§åˆ¶å»ºç«‹ç‰ˆæœ¬æŒ‰éˆ•çš„é¡¯ç¤º
        if (viewMode === 'single') {
            $('#create-version-btn').hide();
        } else {
            $('#create-version-btn').show();
        }

        // å¦‚æœæ˜¯å¾ç‰ˆæœ¬æŸ¥çœ‹é€²å…¥ï¼Œé¡¯ç¤ºç‰¹æ®Šæé†’
        if (fromVersion && jobIds.length > 0) {
            $('#edit-mode-alert').hide();
            $('#view-from-version-alert').show();
        }

        // è¨­ç½®å°èˆªæŒ‰éˆ•
        setupNavigationButtons();

        // è¼‰å…¥è³‡æ–™
        if (caseId) {
            loadCaseInfo();
        } else if (jobIds.length > 0) {
            // å¦‚æœæœ‰ jobIds ä½†æ²’æœ‰ caseIdï¼Œå˜—è©¦å¾ç¬¬ä¸€å€‹ Job å–å¾—æ¡ˆä»¶è³‡è¨Š
            console.log('æ²’æœ‰ case_idï¼Œä½†æœ‰ jobIdsï¼Œå˜—è©¦å¾ Job å–å¾—æ¡ˆä»¶è³‡è¨Š');
            // å…ˆè¼‰å…¥ Jobs è³‡æ–™ï¼ŒloadJobsData æœƒè™•ç†æ¡ˆä»¶è³‡è¨Š
        } else {
            // æ—¢æ²’æœ‰æ¡ˆä»¶ ID ä¹Ÿæ²’æœ‰ jobIdsï¼Œå¼·åˆ¶é‡å°å‘åˆ°æ¡ˆä»¶ç¸½è¦½
            showNotification('è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä»¶', 'warning');
            setTimeout(function () {
                window.location.href = '/dashboard';
            }, 1500);
            return;
        }

        // å¦‚æœæœ‰ version_idï¼Œè¼‰å…¥ç‰ˆæœ¬è³‡æ–™ï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰
        if (versionId) {
            loadVersionData(versionId);
        } else if (jobIds.length > 0) {
            // å¦å‰‡è¼‰å…¥ Jobs è³‡æ–™ï¼ˆç·¨è¼¯æ¨¡å¼ï¼‰
            loadJobsData();
        } else {
            showNotification('æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ', 'warning');
            setTimeout(function () {
                window.location.href = '/database?case_id=' + caseId;
            }, 1500);
            return;
        }

        // Edit mode toggle
        $('#edit-btn').click(function () {
            if (!isEditMode) {
                // é€²å…¥ç·¨è¼¯æ¨¡å¼
                isEditMode = true;
                $(this).hide();

                // åªæœ‰åœ¨éæŸ¥çœ‹æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºå„²å­˜æŒ‰éˆ•
                if (!isViewMode) {
                    $('#save-btn').show();
                }

                makeTableEditable();

                // æ›´æ–°æé†’æ–‡å­—
                if (isViewMode) {
                    $('#view-mode-alert').html(
                        'â„¹ï¸ <strong>ç·¨è¼¯ä¸­ï¼š</strong>æ‚¨æ­£åœ¨ç·¨è¼¯æ­·å²ç‰ˆæœ¬ã€‚å®Œæˆå¾Œè«‹é»æ“Šã€Œå»ºç«‹ç‰ˆæœ¬ã€ä»¥å„²å­˜ç‚ºæ–°ç‰ˆæœ¬ã€‚'
                    );
                }
            }
        });

        // Save button
        $('#save-btn').click(function () {
            // å„²å­˜ç·¨è¼¯ï¼ˆåªåœ¨éæŸ¥çœ‹æ¨¡å¼ä¸‹å¯ç”¨ï¼‰
            if (!isViewMode) {
                saveTableEdits();
            }
        });

        // Withholding tab switch - å·²ç§»é™¤ï¼ˆä¸æœƒåŒæ™‚æœ‰æ”¯å‡ºå’Œæ”¶å…¥ï¼‰

        // Create version (modal å…§çš„ç¢ºèªæŒ‰éˆ•)
        $('#confirm-create-version-btn').click(function () {
            createVersion();
        });

        // Toggle file source column
        $('#toggle-file-source-btn').click(function () {
            var $fileSourceColumns = $('.file-source-column');
            var isVisible = $fileSourceColumns.is(':visible');

            if (isVisible) {
                // éš±è—æª”æ¡ˆä¾†æºæ¬„ä½
                $fileSourceColumns.hide();
                $(this).html('<i class="fa fa-file-text-o"></i> é¡¯ç¤ºæª”æ¡ˆä¾†æº');
            } else {
                // é¡¯ç¤ºæª”æ¡ˆä¾†æºæ¬„ä½
                $fileSourceColumns.show();
                $(this).html('<i class="fa fa-eye-slash"></i> éš±è—æª”æ¡ˆä¾†æº');
            }

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            if ($('#table-withholding').is(':visible')) {
                renderWithholdingTable();
            }
        });

        // File filter change
        $('#file-filter').change(function () {
            var selectedValue = $(this).val();

            if (selectedValue === 'all') {
                // åˆ‡æ›åˆ°å…¨éƒ¨æª”æ¡ˆæ¨¡å¼
                viewMode = 'all';
                selectedJobId = null;
                $('#create-version-btn').show();
            } else {
                // åˆ‡æ›åˆ°å–®ä¸€æª”æ¡ˆæ¨¡å¼
                viewMode = 'single';
                selectedJobId = parseInt(selectedValue);
                $('#create-version-btn').hide();
            }

            // é‡æ–°è™•ç†è³‡æ–™ä¸¦æ¸²æŸ“
            processJobsData();
        });

        // ğŸ†• ç‰ˆæœ¬å‚™è¨»è‡ªå‹•èª¿æ•´é«˜åº¦åŠŸèƒ½
        $('#version-notes').on('input', function() {
            autoResizeTextarea(this);
        });

        // åˆå§‹åŒ–æ™‚ä¹Ÿèª¿æ•´ä¸€æ¬¡é«˜åº¦
        setTimeout(function() {
            autoResizeTextarea(document.getElementById('version-notes'));
        }, 100);

        // ğŸ†• æ–°å¢è¨˜éŒ„ Modal äº‹ä»¶è™•ç†
        // æª”æ¡ˆé¸æ“‡æ™‚æ›´æ–°é ç¢¼æç¤ºå’Œé©—è­‰
        $('#new-record-file-name').change(function() {
            var totalPages = $(this).find(':selected').data('total-pages');
            var $pageInput = $('#new-record-page-number');
            
            if (totalPages) {
                $('#page-number-hint').text('æ­¤æª”æ¡ˆå…± ' + totalPages + ' é ï¼ˆå¯è¼¸å…¥ä»»æ„é ç¢¼ï¼‰');
                $pageInput.val(''); // æ¸…ç©ºé ç¢¼è¼¸å…¥
            } else {
                $('#page-number-hint').text('');
            }
        });

        // ç¢ºèªæ–°å¢è¨˜éŒ„
        $('#confirm-add-record-btn').click(function() {
            var itemName = $('#new-record-item-name').val();
            var jobId = $('#new-record-file-name').val();
            var pageNumber = parseInt($('#new-record-page-number').val());
            
            // é©—è­‰
            if (!itemName) {
                showNotification('è«‹é¸æ“‡é …ç›®', 'warning');
                return;
            }
            
            if (!jobId) {
                showNotification('è«‹é¸æ“‡æª”æ¡ˆ', 'warning');
                return;
            }
            
            if (!pageNumber || isNaN(pageNumber) || pageNumber < 1) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç¢¼ï¼ˆå¿…é ˆå¤§æ–¼ 0ï¼‰', 'warning');
                return;
            }
            
            // æ–°å¢è¨˜éŒ„
            addNewRecordWithFileInfo(itemName, parseInt(jobId), pageNumber);
            
            // é—œé–‰ Modal
            $('#addRecordModal').modal('hide');
            
            // æ¸…ç©ºè¡¨å–®
            $('#new-record-item-name').val('');
            $('#new-record-file-name').val('');
            $('#new-record-page-number').val('');
            $('#page-number-hint').text('');
        });
    });

    // ============ API èª¿ç”¨å‡½æ•¸ ============

    function loadVersionData(versionId) {
        showLoading();
        $.ajax({
            url: API_BASE_URL + '/versions/' + versionId,
            method: 'GET',
            success: function (version) {
                hideLoading();
                console.log('å·²è¼‰å…¥ç‰ˆæœ¬è³‡æ–™:', version);

                // è¨­å®šæ–‡ä»¶é¡å‹
                currentDocType = version.document_type;

                // è¼‰å…¥è¡¨æ ¼è³‡æ–™
                currentTableData = version.table_data || [];

                console.log('æ–‡ä»¶é¡å‹:', currentDocType);
                console.log('è¡¨æ ¼è³‡æ–™ç­†æ•¸:', currentTableData.length);
                console.log('è¡¨æ ¼è³‡æ–™ç¯„ä¾‹:', currentTableData[0]);

                // æ ¹æ“šæ–‡ä»¶é¡å‹é¡¯ç¤ºå°æ‡‰çš„è¡¨æ ¼
                // åˆ¤æ–·é‚è¼¯ï¼šæª¢æŸ¥ document_type å­—ä¸²å…§å®¹
                var is401or403 = currentDocType.includes('401') ||
                    currentDocType.includes('403') ||
                    currentDocType.includes('ç‡Ÿæ¥­ç¨…') ||
                    currentDocType.includes('ç‡Ÿæ¥­äººéŠ·å”®é¡');

                if (is401or403) {
                    // åˆ¤æ–·æ˜¯401é‚„æ˜¯403è¡¨æ ¼
                    if (currentDocType.includes('403')) {
                        console.log('é¡¯ç¤º 403 è¡¨æ ¼');
                        $('#table-401').hide();
                        $('#table-403').show();
                        $('#table-withholding').hide();
                        $('#doc-title').text(currentDocType);
                        render403Table();
                    } else {
                        console.log('é¡¯ç¤º 401 è¡¨æ ¼');
                        $('#table-401').show();
                        $('#table-403').hide();
                        $('#table-withholding').hide();
                        $('#doc-title').text(currentDocType);
                        render401Table();
                    }
                } else {
                    // æ‰£ç¹³æ†‘å–®è¡¨æ ¼
                    console.log('é¡¯ç¤ºæ‰£ç¹³æ†‘å–®è¡¨æ ¼');
                    $('#table-401').hide();
                    $('#table-withholding').show();

                    // åˆ¤æ–·æ”¶æ”¯æ–¹å‘
                    if (currentDocType.includes('æ”¯å‡º')) {
                        withholdingView = 'expense';
                        $('#doc-title').text(currentDocType);
                        $('#amount-header').text('å„é¡çµ¦ä»˜ç¸½é¡');
                    } else if (currentDocType.includes('æ”¶å…¥')) {
                        withholdingView = 'income';
                        $('#doc-title').text(currentDocType);
                        $('#amount-header').text('å„é¡æ”¶ç›Šç¸½é¡');
                    } else {
                        // é è¨­ç‚ºæ”¯å‡º
                        withholdingView = 'expense';
                        $('#doc-title').text(currentDocType);
                        $('#amount-header').text('å„é¡çµ¦ä»˜ç¸½é¡');
                    }

                    renderWithholdingTable();
                }

                $('#record-count').text(currentTableData.length);
                $('#modal-record-count').val(currentTableData.length + ' ç­†');
                $('#modal-doc-type').val(currentDocType);

                // ğŸ†• æª¢æŸ¥ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                showJobErrors();

                // å¦‚æœæœ‰ case_idï¼Œæ›´æ–°æ¡ˆä»¶åç¨±åˆ° modal
                if (currentCase) {
                    $('#modal-case-name').val(currentCase.client_name || 'æœªé¸æ“‡æ¡ˆä»¶');
                }

                // è¨­å®šç‚ºæŸ¥çœ‹æ¨¡å¼
                isViewMode = true;

                // æŸ¥çœ‹æ¨¡å¼ï¼šé¡¯ç¤ºç·¨è¼¯æŒ‰éˆ•ï¼ˆå…è¨±ç·¨è¼¯ä¸¦å»ºç«‹æ–°ç‰ˆæœ¬ï¼‰
                $('#edit-btn').show();
                $('#save-btn').hide();

                // é¡¯ç¤ºæŸ¥çœ‹æ¨¡å¼æé†’ï¼Œéš±è—ç·¨è¼¯æ¨¡å¼æé†’
                $('#edit-mode-alert').hide();
                $('#view-mode-alert').show();

                showNotification('å·²è¼‰å…¥ç‰ˆæœ¬è³‡æ–™ï¼Œå¯é€²è¡Œç·¨è¼¯ä¸¦å»ºç«‹æ–°ç‰ˆæœ¬', 'success');
            },
            error: function (xhr, status, error) {
                hideLoading();
                console.error('è¼‰å…¥ç‰ˆæœ¬è³‡æ–™å¤±æ•—:', error);
                showNotification('è¼‰å…¥ç‰ˆæœ¬è³‡æ–™å¤±æ•—', 'danger');
            }
        });
    }

    function setupNavigationButtons() {
        if (caseId) {
            $('#back-to-database-btn').show().click(function () {
                window.location.href = '/database?case_id=' + caseId;
            });
        } else {
            $('#back-to-dashboard-btn').show().click(function () {
                window.location.href = '/dashboard';
            });
        }

        $('#goto-history-btn').click(function () {
            if (caseId) {
                window.location.href = '/history?case_id=' + caseId;
            } else {
                window.location.href = '/history';
            }
        });
    }

    function loadCaseInfo() {
        if (currentCase) {
            showCaseInfo(currentCase);
            return;
        }

        if (!caseId) return;

        $.ajax({
            url: API_BASE_URL + '/cases/' + caseId,
            method: 'GET',
            success: function (caseData) {
                currentCase = caseData;
                localStorage.setItem('selectedCase', JSON.stringify(caseData));
                showCaseInfo(caseData);
            },
            error: function (xhr, status, error) {
                console.error('è¼‰å…¥æ¡ˆä»¶è³‡è¨Šå¤±æ•—:', error);
            }
        });
    }

    function showCaseInfo(caseData) {
        $('#case-client-name').text(caseData.client_name || '');
        $('#case-year').text(caseData.year || '');
        $('#case-tax-id').text(caseData.tax_id || '');
        $('#case-info-section').show();
        $('#modal-case-name').val(caseData.client_name || 'æœªé¸æ“‡æ¡ˆä»¶');
    }

    function loadJobsData() {
        if (jobIds.length === 0) {
            showNotification('æœªé¸æ“‡ä»»ä½•æª”æ¡ˆ', 'warning');
            return;
        }

        showLoading();
        $.ajax({
            url: API_BASE_URL + '/jobs?ids=' + jobIds.join(','),
            method: 'GET',
            success: function (jobs) {
                hideLoading();
                allJobs = jobs;
                console.log('å·²è¼‰å…¥ ' + allJobs.length + ' å€‹ Jobs');

                // ğŸ†• æª¢æŸ¥æ˜¯å¦å¾ç‰ˆæœ¬é€²å…¥ä½†æ‰¾ä¸åˆ°ä»»ä½• Jobs
                var urlParams = new URLSearchParams(window.location.search);
                var fromVersion = urlParams.get('from_version') === 'true';
                
                if (allJobs.length === 0 && fromVersion) {
                    // å¾ç‰ˆæœ¬é€²å…¥ä½†æ‰¾ä¸åˆ°æª”æ¡ˆï¼Œé¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
                    showNotification('æ­¤ç‰ˆæœ¬è¨˜éŒ„çš„æª”æ¡ˆå·²è¢«åˆªé™¤ï¼Œç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚è«‹åˆªé™¤æ­¤ç‰ˆæœ¬è¨˜éŒ„æˆ–é‡æ–°å»ºç«‹ç‰ˆæœ¬ã€‚', 'danger');
                    setTimeout(function() {
                        window.location.href = '/history?case_id=' + caseId;
                    }, 3000);
                    return;
                }

                // å¦‚æœæ²’æœ‰ caseIdï¼Œå¾ç¬¬ä¸€å€‹ Job å–å¾—æ¡ˆä»¶è³‡è¨Š
                if (!caseId && jobs.length > 0) {
                    caseId = jobs[0].case_id;
                    console.log('å¾ Job å–å¾— case_id:', caseId);
                    // è¼‰å…¥æ¡ˆä»¶è³‡è¨Š
                    loadCaseInfo();
                }

                processJobsData();
            },
            error: function (xhr, status, error) {
                hideLoading();
                console.error('è¼‰å…¥ Jobs è³‡æ–™å¤±æ•—:', error);
                showNotification('è¼‰å…¥æª”æ¡ˆè³‡æ–™å¤±æ•—', 'danger');
            }
        });
    }

    function processJobsData() {
        if (allJobs.length === 0) {
            showNotification('æ²’æœ‰å¯é¡¯ç¤ºçš„è³‡æ–™', 'warning');
            return;
        }

        // æ ¹æ“š viewMode ç¯©é¸è¦è™•ç†çš„ Jobs
        var jobsToProcess = allJobs;
        if (viewMode === 'single' && selectedJobId) {
            jobsToProcess = allJobs.filter(function (job) { return job.id === selectedJobId; });
        }

        // åˆ¤æ–·æ–‡ä»¶é¡å‹ï¼ˆå–ç¬¬ä¸€å€‹ job çš„é¡å‹ï¼‰
        var firstJob = jobsToProcess[0];
        currentDocType = firstJob.document_type;

        // æ ¹æ“šé¡å‹æ¸²æŸ“ä¸åŒçš„è¡¨æ ¼
        if (currentDocType === '401' || currentDocType === '403') {
            // ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸ï¼ˆä¸æ”¯æ´æª”æ¡ˆç¯©é¸ï¼‰
            if (currentDocType === '403') {
                currentTableData = mapJobsTo403Data(allJobs);
                $('#doc-title').text('ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸(403)');
                $('#modal-doc-type').val('ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸(403)');
                $('#table-401').hide();
                $('#table-403').show();
                $('#table-withholding').hide();
                $('#file-filter').hide();
                $('#toggle-file-source-btn').hide();
                render403Table();
            } else {
                currentTableData = mapJobsTo401Data(allJobs);
                $('#doc-title').text('ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸(401)');
                $('#modal-doc-type').val('ç‡Ÿæ¥­ç¨…ç”³å ±æ›¸(401)');
                $('#table-401').show();
                $('#table-403').hide();
                $('#table-withholding').hide();
                $('#file-filter').hide();
                $('#toggle-file-source-btn').hide();
                render401Table();
            }
        } else if (currentDocType === 'withholding-slip' || currentDocType === 'withholding-statement' || currentDocType === 'dividend-slip') {
            // æ‰£ç¹³æ†‘å–®ï¼ˆåŒ…æ‹¬è‚¡åˆ©æ†‘å–®ï¼‰
            currentTableData = mapJobsToWithholdingData(jobsToProcess);
            $('#table-401').hide();
            $('#table-withholding').show();

            // åˆå§‹åŒ–æª”æ¡ˆç¯©é¸å™¨
            initializeFileFilter();

            // æ ¹æ“š detected_stream å’Œ document_type è¨­å®šæ¨™é¡Œå’Œæ¬„ä½åç¨±
            var docTypeDisplayName = '';
            if (currentDocType === 'dividend-slip') {
                docTypeDisplayName = 'è‚¡åˆ©æ†‘å–®';
            } else {
                docTypeDisplayName = 'æ‰£ç¹³æ†‘å–®';
            }

            if (firstJob.detected_stream === 'æ”¯å‡º') {
                withholdingView = 'expense';
                $('#doc-title').text(docTypeDisplayName + 'ï¼ˆæ”¯å‡ºï¼‰');
                $('#modal-doc-type').val(docTypeDisplayName + 'ï¼ˆæ”¯å‡ºï¼‰');
                $('#amount-header').text('å„é¡çµ¦ä»˜ç¸½é¡');
            } else if (firstJob.detected_stream === 'æ”¶å…¥') {
                withholdingView = 'income';
                $('#doc-title').text(docTypeDisplayName + 'ï¼ˆæ”¶å…¥ï¼‰');
                $('#modal-doc-type').val(docTypeDisplayName + 'ï¼ˆæ”¶å…¥ï¼‰');
                $('#amount-header').text('å„é¡æ”¶ç›Šç¸½é¡');
            } else {
                // é è¨­ç‚ºæ”¯å‡º
                withholdingView = 'expense';
                $('#doc-title').text(docTypeDisplayName);
                $('#modal-doc-type').val(docTypeDisplayName);
                $('#amount-header').text('å„é¡çµ¦ä»˜ç¸½é¡');
            }

            // é¡¯ç¤º/éš±è—æŒ‰éˆ•
            if (allJobs.length > 1) {
                $('#toggle-file-source-btn').show();
            } else {
                $('#toggle-file-source-btn').hide();
            }

            // æ§åˆ¶å»ºç«‹ç‰ˆæœ¬æŒ‰éˆ•çš„é¡¯ç¤º
            if (viewMode === 'single') {
                $('#create-version-btn').hide();
            } else {
                $('#create-version-btn').show();
            }

            renderWithholdingTable();
        }

        $('#record-count').text(currentTableData.length);
        $('#modal-record-count').val(currentTableData.length + ' ç­†');

        // ğŸ†• æª¢æŸ¥ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        showJobErrors();

        // ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºç·¨è¼¯æ¨¡å¼æé†’ï¼ˆé™¤éæ˜¯å¾ç‰ˆæœ¬æŸ¥çœ‹é€²å…¥ï¼‰
        var urlParams = new URLSearchParams(window.location.search);
        var fromVersion = urlParams.get('from_version') === 'true';

        if (!fromVersion) {
            $('#edit-mode-alert').show();
            $('#view-from-version-alert').hide();
        }
        // å¦‚æœæ˜¯å¾ç‰ˆæœ¬é€²å…¥ï¼Œä¿æŒ view-from-version-alert é¡¯ç¤º
    }

    function initializeFileFilter() {
        var $filter = $('#file-filter');
        $filter.empty();

        // æ–°å¢ã€Œå…¨éƒ¨æª”æ¡ˆã€é¸é …
        $filter.append('<option value="all">å…¨éƒ¨æª”æ¡ˆ (' + allJobs.length + ' å€‹)</option>');

        // æ–°å¢æ¯å€‹æª”æ¡ˆçš„é¸é …
        allJobs.forEach(function (job) {
            var fileName = job.original_filename || 'æœªå‘½åæª”æ¡ˆ';
            $filter.append('<option value="' + job.id + '">' + fileName + '</option>');
        });

        // è¨­å®šç•¶å‰é¸æ“‡çš„å€¼
        if (viewMode === 'single' && selectedJobId) {
            $filter.val(selectedJobId);
        } else {
            $filter.val('all');
        }

        $filter.show();
    }

    // ============ JSON æ˜ å°„å‡½æ•¸ ============

    function mapJobsTo401Data(jobs) {
        // å°‡ Job çš„ result_json æ˜ å°„åˆ° 401 è¡¨æ ¼è³‡æ–™çµæ§‹
        console.log('æ˜ å°„ 401 è³‡æ–™:', jobs);

        var records = [];

        jobs.forEach(function (job) {
            // æª¢æŸ¥ Job æ˜¯å¦æœ‰ result_json
            if (!job.result_json) {
                console.warn('Job', job.id, 'æ²’æœ‰ result_jsonï¼Œè·³é');
                return;
            }

            var json = job.result_json;

            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šé æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                console.log('Job', job.id, 'æ˜¯å¤šé æ ¼å¼ï¼Œå…±', json.é é¢è³‡æ–™.length, 'é ');
                
                // å¤šé æª”æ¡ˆï¼šè¿­ä»£æ¯ä¸€é 
                json.é é¢è³‡æ–™.forEach(function (pageData, pageIndex) {
                    console.log('è™•ç†ç¬¬', pageIndex + 1, 'é ');
                    processPage(pageData, job.id);
                });
            } else {
                // å–®é æ ¼å¼
                console.log('Job', job.id, 'æ˜¯å–®é æ ¼å¼');
                processPage(json, job.id);
            }
        });

        // è™•ç†å–®é è³‡æ–™çš„è¼”åŠ©å‡½æ•¸
        function processPage(json, jobId) {
            // æå–æœˆä»½å€é–“ï¼ˆå¾ã€Œæ‰€å±¬å¹´æœˆä»½ã€æ¬„ä½ï¼‰
            var monthPeriod = extractMonthPeriod(json.æ‰€å±¬å¹´æœˆä»½);

            // å¦‚æœç„¡æ³•æå–æœˆä»½ï¼Œè·³éé€™å€‹é é¢
            if (!monthPeriod) {
                console.warn('Job', jobId, 'ç„¡æ³•æå–æœˆä»½ï¼Œæ‰€å±¬å¹´æœˆä»½:', json.æ‰€å±¬å¹´æœˆä»½);
                return;
            }

            // æå–éŠ·é …è³‡æ–™
            var sales = json.éŠ·é … || {};
            var salesGeneral = sales.ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡ || {};
            var salesZeroRate = salesGeneral.é›¶ç¨…ç‡éŠ·å”®é¡ || {};  // ğŸ”§ ä¿®æ­£ï¼šé›¶ç¨…ç‡éŠ·å”®é¡åœ¨ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡ä¸‹

            // æå–é€²é …è³‡æ–™
            var purchase = json.é€²é … || {};
            var purchaseDeductible = purchase.å¾—æ‰£æŠµ || {};
            var purchaseReturn = purchase.æ¸›é€€å›åŠæŠ˜è®“ || {};
            var purchaseTotal = purchase.åˆè¨ˆ || {};  // ğŸ†• æ–°å¢ï¼šæå–åˆè¨ˆè³‡æ–™

            // éŠ·è²¨é€€å›åŠæŠ˜è®“ä¸‰æ¬„
            var returnGeneral = parseNumber(sales.éŠ·é …é€€å›åŠæŠ˜è®“ || 0);
            var returnZeroRate = parseNumber(salesZeroRate.æµ·é—œé€€å›åŠæŠ˜è®“ || 0);
            var returnSpecial = 0;  // 401 è¡¨å–®ç‰¹ç¨®é€€å›å›ºå®šç‚º 0
            var returnTotal = returnGeneral + returnZeroRate + returnSpecial;

            records.push({
                month: monthPeriod.display,  // é¡¯ç¤ºæ ¼å¼ï¼š07-08æœˆ
                monthSort: monthPeriod.sortKey,  // æ’åºç”¨ï¼šèµ·å§‹æœˆä»½æ•¸å­—
                é ç¢¼: json.é ç¢¼ || 1,               // ğŸ†• ä¿ç•™é ç¢¼ï¼ˆé›–ç„¶ä¸é¡¯ç¤ºï¼Œä½†ç‚ºäº†ä¸€è‡´æ€§ï¼‰
                ç¸½é æ•¸: json.ç¸½é æ•¸ || 1,           // ğŸ†• ä¿ç•™ç¸½é æ•¸
                // éŠ·é … - ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨ parseNumber è™•ç†å¸¶é€—è™Ÿçš„å­—ä¸²
                triplicateSales: parseNumber(salesGeneral.æ‡‰ç¨…?.ä¸‰è¯å¼ || salesGeneral.æ‡‰ç¨…?.ä¸‰è¯å¼ç™¼ç¥¨ || 0),
                duplicateSales: parseNumber(salesGeneral.æ‡‰ç¨…?.äºŒè¯å¼ || 0),
                customsSales: parseNumber(salesZeroRate.ç¶“æµ·é—œ || 0),
                nonCustomsSales: parseNumber(salesZeroRate.éç¶“æµ·é—œ || 0),
                taxFreeSales: parseNumber(salesGeneral.å…ç¨… || 0),
                specialTaxSales: parseNumber(sales.ç‰¹ç¨®ç¨…é¡éŠ·å”®é¡ || sales.ç‰¹ç¨®ç¨…é¡åˆè¨ˆ || 0),
                otherSales: parseNumber(sales.å…¶ä»– || 0),
                totalSales: 0,  // ç¨å¾Œè¨ˆç®—
                // éŠ·è²¨é€€å›åŠæŠ˜è®“ï¼ˆä¸‰æ¬„ + åˆè¨ˆï¼‰
                returnGeneral: returnGeneral,           // ä¸€èˆ¬
                returnZeroRate: returnZeroRate,         // é›¶ç¨…ç‡
                returnSpecial: returnSpecial,           // ç‰¹ç¨®ï¼ˆ401å›ºå®šç‚º0ï¼‰
                returnTotal: returnTotal,               // åˆè¨ˆ
                netAmount: 0,  // ç¨å¾Œè¨ˆç®—
                // é€²é … - ğŸ”§ ä¿®æ”¹ï¼šå¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
                purchaseAndExpense: parseNumber(purchaseTotal.é€²è²¨åŠè²»ç”¨ || 0) + parseNumber(purchaseReturn.é€²è²¨åŠè²»ç”¨ || 0),
                fixedAssets: parseNumber(purchaseTotal.å›ºå®šè³‡ç”¢ || 0) + parseNumber(purchaseReturn.å›ºå®šè³‡ç”¢ || 0),
                purchaseReturn: parseNumber(purchaseReturn.é€²è²¨åŠè²»ç”¨ || 0),
                purchaseReturnAssets: parseNumber(purchaseReturn.å›ºå®šè³‡ç”¢ || 0),
                purchaseTotal: parseNumber(purchaseTotal.é€²è²¨åŠè²»ç”¨ || 0),        // ğŸ†• æ–°å¢ï¼šåˆè¨ˆ-é€²è²¨åŠè²»ç”¨
                assetsTotal: parseNumber(purchaseTotal.å›ºå®šè³‡ç”¢ || 0),            // ğŸ†• æ–°å¢ï¼šåˆè¨ˆ-å›ºå®šè³‡ç”¢
                importAmount: parseNumber(purchase.é€²å£è²¨ç‰©é‡‘é¡ || 0),
                // ğŸ†• æ–°å¢ï¼šwarnings æ¬„ä½
                warnings: json.warnings || [],
                warnings_acknowledged: json.warnings_acknowledged || false
            });
        }
        
        // ğŸ†• è¨ˆç®—æ¯ç­†è¨˜éŒ„çš„éŠ·å”®é¡åˆè¨ˆå’Œæ·¨é¡ï¼ˆå‰ç«¯è‡ªè¡Œè¨ˆç®—ï¼Œä¸ä¾è³´å¾Œç«¯ JSONï¼‰
        records.forEach(function(record) {
            // éŠ·å”®é¡åˆè¨ˆ = ä¸‰è¯å¼ + äºŒè¯å¼ + ç¶“æµ·é—œ + éç¶“æµ·é—œ + å…ç¨… + ç‰¹ç¨®ç¨…é¡ + å…¶ä»–
            record.totalSales = record.triplicateSales + record.duplicateSales + 
                               record.customsSales + record.nonCustomsSales + 
                               record.taxFreeSales + record.specialTaxSales + 
                               record.otherSales;
            
            // æ·¨é¡ = éŠ·å”®é¡åˆè¨ˆ - éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
            record.netAmount = record.totalSales - record.returnTotal;
        });

        // æŒ‰æœˆä»½æ’åºï¼ˆå¾å°åˆ°å¤§ï¼‰
        records.sort(function (a, b) {
            return a.monthSort - b.monthSort;
        });

        console.log('æ˜ å°„å¾Œçš„ 401 è³‡æ–™:', records);
        return records;
    }

    // è¼”åŠ©å‡½æ•¸ï¼šæå–æœˆä»½å€é–“
    function extractMonthPeriod(monthStr) {
        if (!monthStr) return null;

        // æ ¼å¼ï¼š113å¹´07-08æœˆ æˆ– 113å¹´01-02æœˆ
        var match = monthStr.match(/(\d+)å¹´(\d+)-(\d+)æœˆ/);
        if (match) {
            var year = match[1];
            var startMonth = match[2];
            var endMonth = match[3];

            return {
                display: startMonth + '-' + endMonth + 'æœˆ',  // 07-08æœˆ
                sortKey: parseInt(startMonth)  // 7ï¼ˆç”¨æ–¼æ’åºï¼‰
            };
        }

        // å¦‚æœæ ¼å¼ä¸ç¬¦ï¼Œå˜—è©¦å…¶ä»–æ ¼å¼
        // æ ¼å¼ï¼š113å¹´07æœˆ
        match = monthStr.match(/(\d+)å¹´(\d+)æœˆ/);
        if (match) {
            var month = match[2];
            return {
                display: month + 'æœˆ',
                sortKey: parseInt(month)
            };
        }

        return null;
    }

    function mapJobsTo403Data(jobs) {
        // å°‡ Job çš„ result_json æ˜ å°„åˆ° 403 è¡¨æ ¼è³‡æ–™çµæ§‹
        console.log('æ˜ å°„ 403 è³‡æ–™:', jobs);

        var records = [];

        jobs.forEach(function (job) {
            // æª¢æŸ¥ Job æ˜¯å¦æœ‰ result_json
            if (!job.result_json) {
                console.warn('Job', job.id, 'æ²’æœ‰ result_jsonï¼Œè·³é');
                return;
            }

            var json = job.result_json;

            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šé æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                console.log('Job', job.id, 'æ˜¯å¤šé æ ¼å¼ï¼Œå…±', json.é é¢è³‡æ–™.length, 'é ');
                
                // å¤šé æª”æ¡ˆï¼šè¿­ä»£æ¯ä¸€é 
                json.é é¢è³‡æ–™.forEach(function (pageData, pageIndex) {
                    console.log('è™•ç†ç¬¬', pageIndex + 1, 'é ');
                    processPage403(pageData, job.id);
                });
            } else {
                // å–®é æ ¼å¼
                console.log('Job', job.id, 'æ˜¯å–®é æ ¼å¼');
                processPage403(json, job.id);
            }
        });

        // è™•ç†å–®é è³‡æ–™çš„è¼”åŠ©å‡½æ•¸ï¼ˆ403å°ˆç”¨ï¼‰
        function processPage403(json, jobId) {
            var monthPeriod = extractMonthPeriod(json.æ‰€å±¬å¹´æœˆä»½);

            // å¦‚æœç„¡æ³•æå–æœˆä»½ï¼Œè·³éé€™å€‹é é¢
            if (!monthPeriod) {
                console.warn('Job', jobId, 'ç„¡æ³•æå–æœˆä»½ï¼Œæ‰€å±¬å¹´æœˆä»½:', json.æ‰€å±¬å¹´æœˆä»½);
                return;
            }

            // æå–éŠ·é …è³‡æ–™
            var sales = json.éŠ·é … || {};
            var salesGeneral = sales.ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡ || {};
            var salesZeroRate = salesGeneral.é›¶ç¨…ç‡éŠ·å”®é¡ || {};  // ğŸ”§ ä¿®æ­£ï¼šé›¶ç¨…ç‡éŠ·å”®é¡åœ¨ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡ä¸‹

            // æå–é€²é …è³‡æ–™
            var purchase = json.é€²é … || {};
            var purchaseDeductible = purchase.å¾—æ‰£æŠµ || {};
            var purchaseReturn = purchase.æ¸›é€€å›åŠæŠ˜è®“ || {};
            var purchaseTotal = purchase.åˆè¨ˆ || {};

            // ğŸ†• 403ç‰¹æœ‰ï¼šç‰¹ç¨®ç¨…é¡è¨ˆç®—
            var specialTaxSales = parseNumber(sales['ç‰¹ç¨®ç¨…é¡-åˆè¨ˆ'] || 0) + parseNumber(sales['ç‰¹ç¨®ç¨…é¡-éŠ·å”®é¡é€€å›åŠæŠ˜è®“'] || 0);

            // éŠ·è²¨é€€å›åŠæŠ˜è®“ä¸‰æ¬„
            var returnGeneral = parseNumber(sales.éŠ·é …é€€å›åŠæŠ˜è®“ || 0);
            var returnZeroRate = parseNumber(salesZeroRate.æµ·é—œé€€å›åŠæŠ˜è®“ || 0);
            var returnSpecial = parseNumber(sales['ç‰¹ç¨®ç¨…é¡-éŠ·å”®é¡é€€å›åŠæŠ˜è®“'] || 0);
            var returnTotal = returnGeneral + returnZeroRate + returnSpecial;

            records.push({
                month: monthPeriod.display,  // é¡¯ç¤ºæ ¼å¼ï¼š07-08æœˆ
                monthSort: monthPeriod.sortKey,  // æ’åºç”¨ï¼šèµ·å§‹æœˆä»½æ•¸å­—
                é ç¢¼: json.é ç¢¼ || 1,
                ç¸½é æ•¸: json.ç¸½é æ•¸ || 1,
                // éŠ·é … - ğŸ”§ ä¿®æ­£ï¼šä½¿ç”¨ parseNumber è™•ç†å¸¶é€—è™Ÿçš„å­—ä¸²
                triplicateSales: parseNumber(salesGeneral.æ‡‰ç¨…?.ä¸‰è¯å¼ || salesGeneral.æ‡‰ç¨…?.ä¸‰è¯å¼ç™¼ç¥¨ || 0),
                duplicateSales: parseNumber(salesGeneral.æ‡‰ç¨…?.äºŒè¯å¼ || 0),
                customsSales: parseNumber(salesZeroRate?.ç¶“æµ·é—œ || 0),
                nonCustomsSales: parseNumber(salesZeroRate?.éç¶“æµ·é—œ || 0),
                taxFreeSales: parseNumber(salesGeneral.å…ç¨… || 0),
                specialTaxSales: specialTaxSales,  // ğŸ†• 403ç‰¹æœ‰ï¼šç‰¹ç¨®ç¨…é¡éŠ·å”®é¡ = åˆè¨ˆ + é€€å›åŠæŠ˜è®“
                otherSales: parseNumber(sales.å…¶ä»– || 0),
                totalSales: 0,  // ç¨å¾Œè¨ˆç®—
                // éŠ·è²¨é€€å›åŠæŠ˜è®“ï¼ˆä¸‰æ¬„ + åˆè¨ˆï¼‰
                returnGeneral: returnGeneral,           // ä¸€èˆ¬
                returnZeroRate: returnZeroRate,         // é›¶ç¨…ç‡
                returnSpecial: returnSpecial,           // ç‰¹ç¨®
                returnTotal: returnTotal,               // åˆè¨ˆ
                netAmount: 0,  // ç¨å¾Œè¨ˆç®—
                // é€²é …
                purchaseAndExpense: parseNumber(purchaseTotal.é€²è²¨åŠè²»ç”¨ || 0) + parseNumber(purchaseReturn.é€²è²¨åŠè²»ç”¨ || 0),
                fixedAssets: parseNumber(purchaseTotal.å›ºå®šè³‡ç”¢ || 0) + parseNumber(purchaseReturn.å›ºå®šè³‡ç”¢ || 0),
                purchaseReturn: parseNumber(purchaseReturn.é€²è²¨åŠè²»ç”¨ || 0),
                purchaseReturnAssets: parseNumber(purchaseReturn.å›ºå®šè³‡ç”¢ || 0),
                purchaseTotal: parseNumber(purchaseTotal.é€²è²¨åŠè²»ç”¨ || 0),
                assetsTotal: parseNumber(purchaseTotal.å›ºå®šè³‡ç”¢ || 0),
                importAmount: parseNumber(purchase.é€²å£è²¨ç‰©é‡‘é¡ || purchase.é€²å£å…ç¨…è²¨ç‰©é‡‘é¡ || 0),
                // ğŸ†• æ–°å¢ï¼šwarnings æ¬„ä½
                warnings: json.warnings || [],
                warnings_acknowledged: json.warnings_acknowledged || false
            });
        }
        
        // ğŸ†• è¨ˆç®—æ¯ç­†è¨˜éŒ„çš„éŠ·å”®é¡åˆè¨ˆå’Œæ·¨é¡ï¼ˆå‰ç«¯è‡ªè¡Œè¨ˆç®—ï¼Œä¸ä¾è³´å¾Œç«¯ JSONï¼‰
        records.forEach(function(record) {
            // éŠ·å”®é¡åˆè¨ˆ = ä¸‰è¯å¼ + äºŒè¯å¼ + ç¶“æµ·é—œ + éç¶“æµ·é—œ + å…ç¨… + ç‰¹ç¨®ç¨…é¡ + å…¶ä»–
            record.totalSales = record.triplicateSales + record.duplicateSales + 
                               record.customsSales + record.nonCustomsSales + 
                               record.taxFreeSales + record.specialTaxSales + 
                               record.otherSales;
            
            // æ·¨é¡ = éŠ·å”®é¡åˆè¨ˆ - éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
            record.netAmount = record.totalSales - record.returnTotal;
        });

        // æŒ‰æœˆä»½æ’åºï¼ˆå¾å°åˆ°å¤§ï¼‰
        records.sort(function (a, b) {
            return a.monthSort - b.monthSort;
        });

        console.log('æ˜ å°„å¾Œçš„ 403 è³‡æ–™:', records);
        return records;
    }

    function mapJobsToWithholdingData(jobs) {
        // å°‡ Job çš„ result_json æ˜ å°„åˆ°æ‰£ç¹³æ†‘å–®è¡¨æ ¼è³‡æ–™çµæ§‹
        console.log('æ˜ å°„æ‰£ç¹³æ†‘å–®è³‡æ–™:', jobs);

        var records = [];

        jobs.forEach(function (job) {
            if (!job.result_json) {
                console.warn('Job', job.id, 'æ²’æœ‰ result_jsonï¼Œè·³é');
                return;
            }

            var json = job.result_json;

            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šé æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                // å¤šé æª”æ¡ˆï¼šè¿­ä»£æ¯ä¸€é 
                json.é é¢è³‡æ–™.forEach(function (pageData) {
                    var pageRecords = pageData.records || [];
                    var companyName = pageData.æ‰£ç¹³å–®ä½åç¨± || '';

                    pageRecords.forEach(function (record) {
                        records.push({
                            jobId: job.id,  // è¨˜éŒ„ä¾†æº Job ID
                            fileName: job.original_filename || '',  // ğŸ†• è¨˜éŒ„æª”æ¡ˆåç¨±
                            é ç¢¼: pageData.é ç¢¼ || 1,           // ğŸ†• ä¿ç•™é ç¢¼
                            ç¸½é æ•¸: pageData.ç¸½é æ•¸ || 1,       // ğŸ†• ä¿ç•™ç¸½é æ•¸
                            æ†‘å–®åºè™Ÿ: pageData.æ†‘å–®åºè™Ÿ,        // ğŸ†• ä¿ç•™æ†‘å–®åºè™Ÿï¼ˆè‚¡åˆ©æ†‘å–®ç”¨ï¼‰
                            itemName: record.é …ç›® || '',
                            payerName: companyName,
                            incomeType: record.æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ || '',
                            totalAmount: parseInt(record.å„é¡çµ¦ä»˜ç¸½é¡ || 0),
                            withholdingTax: parseInt(record.æ‰£ç¹³ç¨…é¡ || 0),
                            has_warning: record.has_warning || false  // ğŸ†• å‚³éè­¦å‘Šæ¨™è¨˜
                        });
                    });
                });
            } else {
                // å–®é æª”æ¡ˆï¼šç›´æ¥è®€å– records
                var jsonRecords = json.records || [];
                var companyName = json.æ‰£ç¹³å–®ä½åç¨± || '';

                jsonRecords.forEach(function (record) {
                    records.push({
                        jobId: job.id,  // è¨˜éŒ„ä¾†æº Job ID
                        fileName: job.original_filename || '',  // ğŸ†• è¨˜éŒ„æª”æ¡ˆåç¨±
                        é ç¢¼: json.é ç¢¼ || 1,               // ğŸ†• ä¿ç•™é ç¢¼
                        ç¸½é æ•¸: json.ç¸½é æ•¸ || 1,           // ğŸ†• ä¿ç•™ç¸½é æ•¸
                        æ†‘å–®åºè™Ÿ: json.æ†‘å–®åºè™Ÿ,            // ğŸ†• ä¿ç•™æ†‘å–®åºè™Ÿï¼ˆè‚¡åˆ©æ†‘å–®ç”¨ï¼‰
                        itemName: record.é …ç›® || '',
                        payerName: companyName,
                        incomeType: record.æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ || '',
                        totalAmount: parseInt(record.å„é¡çµ¦ä»˜ç¸½é¡ || 0),
                        withholdingTax: parseInt(record.æ‰£ç¹³ç¨…é¡ || 0)
                    });
                });
            }
        });

        // å®šç¾©é …ç›®æ’åºé †åº
        var itemOrder = {
            'è–ªè³‡': 1,
            'åŸ·è¡Œæ¥­å‹™å ±é…¬': 2,
            'åˆ©æ¯': 3,
            'ç§Ÿè³ƒ': 4,
            'æ¬Šåˆ©é‡‘': 5,
            'è‚¡åˆ©': 6,
            'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç': 7,
            'é€€è·æ‰€å¾—': 8,
            'è²¡ç”¢äº¤æ˜“': 9,
            'å…¶ä»–æ‰€å¾—': 10,
            'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸': 11
        };

        // æ’åºï¼šå…ˆæŒ‰é …ç›®é †åºï¼Œå†æŒ‰æ‰€å¾—é¡åˆ¥
        records.sort(function (a, b) {
            var orderA = itemOrder[a.itemName] || 999;
            var orderB = itemOrder[b.itemName] || 999;

            // å…ˆæ¯”è¼ƒé …ç›®é †åº
            if (orderA !== orderB) {
                return orderA - orderB;
            }

            // é …ç›®ç›¸åŒï¼Œå†æ¯”è¼ƒæ‰€å¾—é¡åˆ¥
            return (a.incomeType || '').localeCompare(b.incomeType || '');
        });

        console.log('æ˜ å°„ä¸¦æ’åºå¾Œçš„æ‰£ç¹³æ†‘å–®è³‡æ–™:', records);
        
        
        return records;
    }

    function saveTableEdits() {
        // åŒæ­¥è¡¨æ ¼è³‡æ–™å› currentTableData
        syncTableDataToCurrentData();

        showLoading();

        // å°‡ currentTableData è½‰æ›å› result_json æ ¼å¼ä¸¦æ›´æ–°æ¯å€‹ Job
        var updatePromises = [];

        if ($('#table-401').is(':visible')) {
            // 401 è¡¨æ ¼ï¼šéœ€è¦å°‡è³‡æ–™è½‰æ›å›åŸå§‹ JSON æ ¼å¼
            updatePromises = save401DataToJobs();
        } else if ($('#table-403').is(':visible')) {
            // 403 è¡¨æ ¼ï¼šéœ€è¦å°‡è³‡æ–™è½‰æ›å›åŸå§‹ JSON æ ¼å¼
            updatePromises = save403DataToJobs();
        } else if ($('#table-withholding').is(':visible')) {
            // æ‰£ç¹³æ†‘å–®è¡¨æ ¼ï¼šéœ€è¦å°‡è³‡æ–™è½‰æ›å›åŸå§‹ JSON æ ¼å¼
            updatePromises = saveWithholdingDataToJobs();
        }

        // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
        Promise.all(updatePromises)
            .then(function () {
                hideLoading();
                showNotification('å·²å„²å­˜æ‰€æœ‰è®Šæ›´', 'success');

                // é€€å‡ºç·¨è¼¯æ¨¡å¼
                isEditMode = false;
                $('#save-btn').hide();
                $('#edit-btn').show();
                makeTableReadonly();
            })
            .catch(function (error) {
                hideLoading();
                console.error('å„²å­˜å¤±æ•—:', error);
                showNotification('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
            });
    }

    function save401DataToJobs() {
        // å°‡ 401 è¡¨æ ¼è³‡æ–™è½‰æ›å› result_json æ ¼å¼ä¸¦æ›´æ–° Jobs
        var promises = [];

        // æŒ‰æœˆä»½åˆ†çµ„è³‡æ–™ï¼ˆå› ç‚ºä¸€å€‹ Job å°æ‡‰ä¸€å€‹æœˆä»½çš„è³‡æ–™ï¼‰
        var monthDataMap = {};
        currentTableData.forEach(function (record) {
            monthDataMap[record.month] = record;
        });

        // æ›´æ–°æ¯å€‹ Job çš„ result_json
        allJobs.forEach(function (job) {
            if (!job.result_json) return;

            var json = job.result_json;
            var updatedJson = JSON.parse(JSON.stringify(json));  // æ·±æ‹·è²åŸå§‹ JSON
            var hasUpdate = false;

            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šé æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                // å¤šé æ ¼å¼ï¼šæ›´æ–°æ¯ä¸€é 
                json.é é¢è³‡æ–™.forEach(function (pageData, pageIndex) {
                    var monthPeriod = extractMonthPeriod(pageData.æ‰€å±¬å¹´æœˆä»½);
                    
                    if (monthPeriod && monthDataMap[monthPeriod.display]) {
                        var record = monthDataMap[monthPeriod.display];
                        updatePageData(updatedJson.é é¢è³‡æ–™[pageIndex], record);
                        hasUpdate = true;
                    }
                });
            } else {
                // å–®é æ ¼å¼
                var monthPeriod = extractMonthPeriod(json.æ‰€å±¬å¹´æœˆä»½);
                
                if (monthPeriod && monthDataMap[monthPeriod.display]) {
                    var record = monthDataMap[monthPeriod.display];
                    updatePageData(updatedJson, record);
                    hasUpdate = true;
                }
            }

            // å¦‚æœæœ‰æ›´æ–°ï¼Œç™¼é€è«‹æ±‚
            if (hasUpdate) {
                var promise = $.ajax({
                    url: API_BASE_URL + '/jobs/' + job.id + '/result',
                    method: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        ocr_result: updatedJson,
                        status: 'COMPLETED',
                        save_as_new_version: false
                    })
                });

                promises.push(promise);
            }
        });

        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°å–®é è³‡æ–™
        function updatePageData(pageJson, record) {
            pageJson.éŠ·é … = {
                ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡: {
                    æ‡‰ç¨…: {
                        ä¸‰è¯å¼: record.triplicateSales.toString(),
                        äºŒè¯å¼: record.duplicateSales.toString(),
                        ä¸‰è¯å¼ç™¼ç¥¨: 0,  // ä¿æŒåŸæœ‰æ¬„ä½
                        æ”¶éŠ€æ©Ÿç™¼ç¥¨éŠ·å”®é¡: 0  // ä¿æŒåŸæœ‰æ¬„ä½
                    },
                    é›¶ç¨…ç‡éŠ·å”®é¡: {
                        ç¶“æµ·é—œ: record.customsSales.toString(),
                        éç¶“æµ·é—œ: record.nonCustomsSales.toString(),
                        æµ·é—œé€€å›åŠæŠ˜è®“: record.returnZeroRate.toString()  // é›¶ç¨…ç‡é€€å›
                    },
                    å…ç¨…: record.taxFreeSales.toString()
                },
                ç‰¹ç¨®ç¨…é¡éŠ·å”®é¡: record.specialTaxSales.toString(),
                å…¶ä»–: record.otherSales.toString(),
                éŠ·å”®é¡åˆè¨ˆ: record.totalSales.toString(),
                éŠ·é …é€€å›åŠæŠ˜è®“: record.returnGeneral.toString(),  // ä¸€èˆ¬éŠ·é …é€€å›åŠæŠ˜è®“
                'éŠ·è²¨é€€å›åŠæŠ˜è®“-é›¶ç¨…ç‡': record.returnZeroRate.toString(),
                'éŠ·è²¨é€€å›åŠæŠ˜è®“-ç‰¹ç¨®': record.returnSpecial.toString(),
                éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ: record.returnTotal.toString(),
                æ·¨é¡: record.netAmount.toString()
            };

            // ğŸ”§ ä¿®æ”¹ï¼šé‡æ–°è¨ˆç®—å¾—æ‰£æŠµå’Œåˆè¨ˆçš„é—œä¿‚
            pageJson.é€²é … = {
                å¾—æ‰£æŠµ: {
                    é€²è²¨åŠè²»ç”¨: record.purchaseAndExpense.toString(),
                    å›ºå®šè³‡ç”¢: record.fixedAssets.toString()
                },
                æ¸›é€€å›åŠæŠ˜è®“: {
                    é€²è²¨åŠè²»ç”¨: record.purchaseReturn.toString(),
                    å›ºå®šè³‡ç”¢: record.purchaseReturnAssets.toString()
                },
                åˆè¨ˆ: {
                    é€²è²¨åŠè²»ç”¨: (record.purchaseAndExpense - record.purchaseReturn).toString(),
                    å›ºå®šè³‡ç”¢: (record.fixedAssets - record.purchaseReturnAssets).toString()
                },
                é€²å£è²¨ç‰©é‡‘é¡: record.importAmount.toString()
            };
        }

        return promises;
    }

    function save403DataToJobs() {
        // å°‡ 403 è¡¨æ ¼è³‡æ–™è½‰æ›å› result_json æ ¼å¼ä¸¦æ›´æ–° Jobs
        var promises = [];

        // æŒ‰æœˆä»½åˆ†çµ„è³‡æ–™ï¼ˆå› ç‚ºä¸€å€‹ Job å°æ‡‰ä¸€å€‹æœˆä»½çš„è³‡æ–™ï¼‰
        var monthDataMap = {};
        currentTableData.forEach(function (record) {
            monthDataMap[record.month] = record;
        });

        // æ›´æ–°æ¯å€‹ Job çš„ result_json
        allJobs.forEach(function (job) {
            if (!job.result_json) return;

            var json = job.result_json;
            var updatedJson = JSON.parse(JSON.stringify(json));  // æ·±æ‹·è²åŸå§‹ JSON
            var hasUpdate = false;

            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šé æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                // å¤šé æ ¼å¼ï¼šæ›´æ–°æ¯ä¸€é 
                json.é é¢è³‡æ–™.forEach(function (pageData, pageIndex) {
                    var monthPeriod = extractMonthPeriod(pageData.æ‰€å±¬å¹´æœˆä»½);
                    
                    if (monthPeriod && monthDataMap[monthPeriod.display]) {
                        var record = monthDataMap[monthPeriod.display];
                        update403PageData(updatedJson.é é¢è³‡æ–™[pageIndex], record);
                        hasUpdate = true;
                    }
                });
            } else {
                // å–®é æ ¼å¼
                var monthPeriod = extractMonthPeriod(json.æ‰€å±¬å¹´æœˆä»½);
                
                if (monthPeriod && monthDataMap[monthPeriod.display]) {
                    var record = monthDataMap[monthPeriod.display];
                    update403PageData(updatedJson, record);
                    hasUpdate = true;
                }
            }

            // å¦‚æœæœ‰æ›´æ–°ï¼Œç™¼é€è«‹æ±‚
            if (hasUpdate) {
                var promise = $.ajax({
                    url: API_BASE_URL + '/jobs/' + job.id + '/result',
                    method: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        ocr_result: updatedJson,
                        status: 'COMPLETED',
                        save_as_new_version: false
                    })
                });

                promises.push(promise);
            }
        });

        // è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°403å–®é è³‡æ–™
        function update403PageData(pageJson, record) {
            pageJson.éŠ·é … = {
                ä¸€èˆ¬ç¨…é¡éŠ·å”®é¡: {
                    æ‡‰ç¨…: {
                        ä¸‰è¯å¼: record.triplicateSales.toString(),
                        äºŒè¯å¼: record.duplicateSales.toString(),
                        ä¸‰è¯å¼ç™¼ç¥¨: 0,  // ä¿æŒåŸæœ‰æ¬„ä½
                        æ”¶éŠ€æ©Ÿç™¼ç¥¨éŠ·å”®é¡: 0  // ä¿æŒåŸæœ‰æ¬„ä½
                    },
                    é›¶ç¨…ç‡éŠ·å”®é¡: {
                        ç¶“æµ·é—œ: record.customsSales.toString(),
                        éç¶“æµ·é—œ: record.nonCustomsSales.toString(),
                        æµ·é—œé€€å›åŠæŠ˜è®“: record.returnZeroRate.toString()  // é›¶ç¨…ç‡é€€å›
                    },
                    å…ç¨…: record.taxFreeSales.toString()
                },
                'ç‰¹ç¨®ç¨…é¡-åˆè¨ˆ': (record.specialTaxSales - record.returnSpecial).toString(),  // 403ç‰¹æœ‰ï¼šåæ¨åˆè¨ˆï¼ˆéŠ·å”®é¡ - é€€å›ï¼‰
                'ç‰¹ç¨®ç¨…é¡-éŠ·å”®é¡é€€å›åŠæŠ˜è®“': record.returnSpecial.toString(),  // 403ç‰¹æœ‰ï¼šç‰¹ç¨®ç¨…é¡é€€å›åŠæŠ˜è®“
                å…¶ä»–: record.otherSales.toString(),
                éŠ·å”®é¡åˆè¨ˆ: record.totalSales.toString(),
                éŠ·é …é€€å›åŠæŠ˜è®“: record.returnGeneral.toString(),  // ä¸€èˆ¬éŠ·é …é€€å›åŠæŠ˜è®“
                'éŠ·è²¨é€€å›åŠæŠ˜è®“-é›¶ç¨…ç‡': record.returnZeroRate.toString(),
                'éŠ·è²¨é€€å›åŠæŠ˜è®“-ç‰¹ç¨®': record.returnSpecial.toString(),
                éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ: record.returnTotal.toString(),
                æ·¨é¡: record.netAmount.toString()
            };

            // ğŸ”§ ä¿®æ”¹ï¼šé‡æ–°è¨ˆç®—å¾—æ‰£æŠµå’Œåˆè¨ˆçš„é—œä¿‚
            pageJson.é€²é … = {
                å¾—æ‰£æŠµ: {
                    é€²è²¨åŠè²»ç”¨: record.purchaseAndExpense.toString(),
                    å›ºå®šè³‡ç”¢: record.fixedAssets.toString()
                },
                æ¸›é€€å›åŠæŠ˜è®“: {
                    é€²è²¨åŠè²»ç”¨: record.purchaseReturn.toString(),
                    å›ºå®šè³‡ç”¢: record.purchaseReturnAssets.toString()
                },
                åˆè¨ˆ: {
                    é€²è²¨åŠè²»ç”¨: (record.purchaseAndExpense - record.purchaseReturn).toString(),
                    å›ºå®šè³‡ç”¢: (record.fixedAssets - record.purchaseReturnAssets).toString()
                },
                é€²å£è²¨ç‰©é‡‘é¡: record.importAmount.toString()
            };
        }

        return promises;
    }

    function saveWithholdingDataToJobs() {
        // å°‡æ‰£ç¹³æ†‘å–®è¡¨æ ¼è³‡æ–™è½‰æ›å› result_json æ ¼å¼ä¸¦æ›´æ–° Jobs
        var promises = [];

        // æŒ‰ Job ID åˆ†çµ„è³‡æ–™ï¼ˆæ¯å€‹ Job åªæ›´æ–°è‡ªå·±çš„è³‡æ–™ï¼‰
        var jobDataMap = {};
        currentTableData.forEach(function (record) {
            if (!record.jobId) {
                console.warn('è¨˜éŒ„ç¼ºå°‘ jobIdï¼Œè·³é:', record);
                return;
            }

            if (!jobDataMap[record.jobId]) {
                jobDataMap[record.jobId] = [];
            }

            jobDataMap[record.jobId].push({
                é …ç›®: record.itemName,
                æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ: record.incomeType,
                å„é¡çµ¦ä»˜ç¸½é¡: record.totalAmount.toString(),
                æ‰£ç¹³ç¨…é¡: record.withholdingTax.toString()
            });
        });

        console.log('æŒ‰ Job ID åˆ†çµ„çš„è³‡æ–™:', jobDataMap);
        
        // ğŸ”§ æ–°å¢ï¼šé©—è­‰è³‡æ–™å®Œæ•´æ€§
        var totalRecords = Object.values(jobDataMap).reduce((sum, records) => sum + records.length, 0);
        console.log('ç¸½è¨˜éŒ„æ•¸é©—è­‰:', {
            currentTableData: currentTableData.length,
            jobDataMap: totalRecords,
            allJobs: allJobs.length
        });
        
        if (totalRecords !== currentTableData.length) {
            console.error('âŒ è³‡æ–™åˆ†çµ„éŒ¯èª¤ï¼è¨˜éŒ„æ•¸ä¸åŒ¹é…');
            showNotification('è³‡æ–™è™•ç†éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'danger');
            return [];
        }

        // æ›´æ–°æ¯å€‹ Job çš„ result_json
        allJobs.forEach(function (job) {
            if (!job.result_json) return;

            // åªæ›´æ–°æœ‰è³‡æ–™çš„ Job
            if (!jobDataMap[job.id]) {
                console.log('Job', job.id, 'æ²’æœ‰å°æ‡‰çš„è¡¨æ ¼è³‡æ–™ï¼Œè·³é');
                return;
            }

            var json = JSON.parse(JSON.stringify(job.result_json));  // æ·±æ‹·è²
            var updatedRecords = jobDataMap[job.id];

            // åˆ¤æ–·æ˜¯å¤šé é‚„æ˜¯å–®é æ ¼å¼
            if (json.é é¢è³‡æ–™ && Array.isArray(json.é é¢è³‡æ–™)) {
                // ğŸ”§ ä¿®å¾©ï¼šå¤šé æ ¼å¼æ­£ç¢ºè™•ç†ï¼ŒæŒ‰é ç¢¼é‡æ–°åˆ†é…è³‡æ–™
                console.log('Job', job.id, 'å¤šé æ ¼å¼è™•ç†ï¼ŒåŸå§‹é æ•¸:', json.é é¢è³‡æ–™.length);
                console.log('Job', job.id, 'æ›´æ–°è¨˜éŒ„æ•¸:', updatedRecords.length);
                
                // ğŸ†• æ”¹é€²ï¼šæŒ‰é ç¢¼å’Œè¨˜éŒ„å…§å®¹ç²¾ç¢ºåˆ†çµ„
                var recordsByPage = {};
                
                // å…ˆåˆå§‹åŒ–æ‰€æœ‰é é¢
                json.é é¢è³‡æ–™.forEach(function(pageData, pageIndex) {
                    var pageNum = pageData.é ç¢¼ || (pageIndex + 1);
                    recordsByPage[pageNum] = [];
                });
                
                // å°‡æ›´æ–°å¾Œçš„è¨˜éŒ„åˆ†é…åˆ°å°æ‡‰é é¢
                updatedRecords.forEach(function(record) {
                    // ğŸ”§ æ”¹é€²ï¼šä½¿ç”¨æ›´ç²¾ç¢ºçš„åŒ¹é…é‚è¼¯
                    var matchingOriginalRecords = currentTableData.filter(function(r) {
                        return r.jobId === job.id && 
                               r.itemName === record.é …ç›® && 
                               r.incomeType === record.æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ;
                    });
                    
                    if (matchingOriginalRecords.length > 0) {
                        // å¦‚æœæœ‰å¤šå€‹åŒ¹é…è¨˜éŒ„ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹çš„é ç¢¼
                        var pageNum = matchingOriginalRecords[0].é ç¢¼ || 1;
                        if (!recordsByPage[pageNum]) {
                            recordsByPage[pageNum] = [];
                        }
                        recordsByPage[pageNum].push(record);
                        console.log('åˆ†é…è¨˜éŒ„åˆ°ç¬¬', pageNum, 'é :', record.é …ç›®, record.æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ);
                    } else {
                        // æ‰¾ä¸åˆ°åŒ¹é…è¨˜éŒ„ï¼Œåˆ†é…åˆ°ç¬¬ä¸€é 
                        console.warn('æ‰¾ä¸åˆ°åŒ¹é…çš„åŸå§‹è¨˜éŒ„ï¼Œåˆ†é…åˆ°ç¬¬1é :', record);
                        if (!recordsByPage[1]) {
                            recordsByPage[1] = [];
                        }
                        recordsByPage[1].push(record);
                    }
                });
                
                // æ›´æ–°æ¯ä¸€é çš„è³‡æ–™
                json.é é¢è³‡æ–™.forEach(function(pageData, pageIndex) {
                    var pageNum = pageData.é ç¢¼ || (pageIndex + 1);
                    var newRecords = recordsByPage[pageNum] || [];
                    
                    // ğŸ”§ é‡è¦ï¼šä¿ç•™åŸå§‹é é¢çš„å…¶ä»–è³‡è¨Šï¼Œåªæ›´æ–° records
                    pageData.records = newRecords;
                    
                    console.log('æ›´æ–°ç¬¬', pageNum, 'é ï¼Œè¨˜éŒ„æ•¸:', newRecords.length);
                    if (newRecords.length > 0) {
                        console.log('  è¨˜éŒ„è©³æƒ…:', newRecords.map(r => `${r.é …ç›®}:${r.å„é¡çµ¦ä»˜ç¸½é¡}`));
                    }
                });
                
            } else {
                // å–®é æ ¼å¼ï¼šç›´æ¥æ›´æ–° records
                console.log('Job', job.id, 'å–®é æ ¼å¼è™•ç†ï¼Œè¨˜éŒ„æ•¸:', updatedRecords.length);
                json.records = updatedRecords;
            }

            // ç™¼é€æ›´æ–°è«‹æ±‚
            var promise = $.ajax({
                url: API_BASE_URL + '/jobs/' + job.id + '/result',
                method: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({
                    ocr_result: json,
                    status: 'COMPLETED',
                    save_as_new_version: false
                })
            }).done(function(response) {
                console.log('âœ… Job', job.id, 'æ›´æ–°æˆåŠŸ:', response);
            }).fail(function(xhr, status, error) {
                console.error('âŒ Job', job.id, 'æ›´æ–°å¤±æ•—:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });
                
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                var errorMsg = 'å„²å­˜å¤±æ•—';
                try {
                    var errorResponse = JSON.parse(xhr.responseText);
                    errorMsg = errorResponse.error || errorResponse.detail || errorMsg;
                } catch (e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                
                showNotification('Job ' + job.id + ' å„²å­˜å¤±æ•—: ' + errorMsg, 'danger');
            });

            promises.push(promise);
        });

        return promises;
    }

    function createVersion() {
        var filename = $('#version-filename').val();
        var notes = $('#version-notes').val();
        var confirmed = $('#amount-confirm').prop('checked');

        if (!filename) {
            showNotification('è«‹å¡«å¯«æª”æ¡ˆåç¨±', 'danger');
            return;
        }
        if (!confirmed) {
            showNotification('è«‹ç¢ºèªæ‰€æœ‰é‡‘é¡ç„¡èª¤å¾Œå†å»ºç«‹ç‰ˆæœ¬', 'danger');
            return;
        }

        if (!caseId) {
            showNotification('æœªé¸æ“‡æ¡ˆä»¶ï¼Œç„¡æ³•å»ºç«‹ç‰ˆæœ¬', 'danger');
            return;
        }

        // åœ¨å»ºç«‹ç‰ˆæœ¬å‰ï¼Œå…ˆåŒæ­¥è¡¨æ ¼è³‡æ–™å› currentTableData
        syncTableDataToCurrentData();

        showLoading();

        // åˆ¤æ–·è¡¨æ ¼é¡å‹ï¼ˆæ ¹æ“šé¡¯ç¤ºçš„è¡¨æ ¼å’Œè³‡æ–™ï¼‰
        var tableType = '';

        // Debug: æª¢æŸ¥è¡¨æ ¼é¡¯ç¤ºç‹€æ…‹
        console.log('=== å»ºç«‹ç‰ˆæœ¬ Debug ===');
        console.log('401è¡¨æ ¼æ˜¯å¦é¡¯ç¤º:', $('#table-401').is(':visible'));
        console.log('æ‰£ç¹³æ†‘å–®è¡¨æ ¼æ˜¯å¦é¡¯ç¤º:', $('#table-withholding').is(':visible'));
        console.log('withholdingView:', withholdingView);
        console.log('currentDocType:', currentDocType);
        console.log('allJobs æ•¸é‡:', allJobs ? allJobs.length : 0);
        if (allJobs && allJobs.length > 0) {
            console.log('ç¬¬ä¸€å€‹ Job çš„ document_type:', allJobs[0].document_type);
            console.log('ç¬¬ä¸€å€‹ Job çš„ detected_stream:', allJobs[0].detected_stream);
        }

        if ($('#table-401').is(':visible') || $('#table-403').is(':visible')) {
            // 401/403 è¡¨æ ¼
            console.log('åˆ¤æ–·ç‚º 401/403 è¡¨æ ¼');
            // æª¢æŸ¥ç¬¬ä¸€å€‹ Job çš„ document_type
            if (allJobs && allJobs.length > 0) {
                var firstJobType = allJobs[0].document_type;
                if (firstJobType === '403') {
                    tableType = '403';
                } else {
                    tableType = '401';
                }
            } else {
                // å¾ currentDocType åˆ¤æ–·
                if (currentDocType && currentDocType.includes('403')) {
                    tableType = '403';
                } else {
                    tableType = '401';
                }
            }
        } else if ($('#table-withholding').is(':visible')) {
            // æ‰£ç¹³æ†‘å–®è¡¨æ ¼ï¼ˆåŒ…æ‹¬è‚¡åˆ©æ†‘å–®ï¼Œçµ±ä¸€æ­¸é¡ç‚ºå„é¡æ‰€å¾—æ‰£ç¹³æ†‘å–®ï¼‰
            console.log('åˆ¤æ–·ç‚ºæ‰£ç¹³æ†‘å–®è¡¨æ ¼');

            // æ ¹æ“š withholdingView åˆ¤æ–·æ”¶æ”¯æ–¹å‘ï¼ˆè‚¡åˆ©æ†‘å–®èˆ‡ä¸€èˆ¬æ‰£ç¹³æ†‘å–®ä½¿ç”¨ç›¸åŒçš„ tableTypeï¼‰
            if (withholdingView === 'income') {
                tableType = 'withholding_income';
            } else {
                tableType = 'withholding_expense';
            }
        } else {
            // é è¨­ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿï¼‰
            console.error('ç„¡æ³•åˆ¤æ–·è¡¨æ ¼é¡å‹ - å…©å€‹è¡¨æ ¼éƒ½ä¸å¯è¦‹ï¼');
            tableType = '401';
        }

        console.log('æœ€çµ‚åˆ¤æ–·çš„ table_type:', tableType);
        console.log('======================');

        // æ”¶é›† job IDsï¼ˆå¦‚æœæ˜¯å¾ Jobs è¼‰å…¥çš„è©±ï¼‰
        var jobIdsList = [];
        if (jobIds && jobIds.length > 0) {
            jobIdsList = jobIds;
        } else if (allJobs && allJobs.length > 0) {
            jobIdsList = allJobs.map(function (job) { return job.id; });
        }

        // æº–å‚™ç‰ˆæœ¬è³‡æ–™
        var versionData = {
            case_id: caseId,
            file_name: filename + '.xlsx',
            table_type: tableType,
            job_ids: jobIdsList,
            data: currentTableData,
            notes: notes,
            record_count: currentTableData.length
        };

        $.ajax({
            url: API_BASE_URL + '/versions',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(versionData),
            success: function (response) {
                hideLoading();
                showNotification('ç‰ˆæœ¬å»ºç«‹æˆåŠŸï¼š' + filename + '.xlsx', 'success');
                $('#versionModal').modal('hide');
                $('#version-form')[0].reset();

                // å°èˆªåˆ°æ­·å²ç´€éŒ„é é¢
                setTimeout(function () {
                    window.location.href = '/history?case_id=' + caseId;
                }, 1500);
            },
            error: function (xhr, status, error) {
                hideLoading();
                console.error('å»ºç«‹ç‰ˆæœ¬å¤±æ•—:', error);
                showNotification('å»ºç«‹ç‰ˆæœ¬å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
            }
        });
    }

    // ============ è¡¨æ ¼æ¸²æŸ“å‡½æ•¸ ============

    function render401Table() {
        if (currentTableData.length === 0) {
            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            $('#sales-tbody').html('<tr><td colspan="14" class="text-center text-muted" style="padding: 40px;">ç„¡è³‡æ–™</td></tr>');
            $('#purchase-tbody').html('<tr><td colspan="8" class="text-center text-muted" style="padding: 40px;">ç„¡è³‡æ–™</td></tr>');
            return;
        }

        var records = currentTableData;

        // ğŸ†• æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰è­¦å‘Š
        var hasWarnings = records.some(r => r.warnings && r.warnings.length > 0 && !r.warnings_acknowledged);
        
        // ğŸ†• å‹•æ…‹èª¿æ•´è¡¨é ­ï¼ˆåŠ åˆ°ç¬¬ä¸€è¡Œï¼Œä½¿ç”¨ rowspan="3"ï¼‰
        var $thead = $('#sales-table thead');
        var $firstRow = $thead.find('tr:first');
        
        if (hasWarnings && $firstRow.find('th:last-child').text().trim() !== 'è­¦å‘Š') {
            $firstRow.append('<th rowspan="3" style="width: 80px; text-align: center; vertical-align: middle;">è­¦å‘Š</th>');
        } else if (!hasWarnings && $firstRow.find('th:last-child').text().trim() === 'è­¦å‘Š') {
            $firstRow.find('th:last-child').remove();
        }

        // Render sales table
        var salesHtml = '';
        var salesTotals = {
            triplicateSales: 0, duplicateSales: 0, nonCustomsSales: 0, customsSales: 0,
            taxFreeSales: 0, specialTaxSales: 0, otherSales: 0, totalSales: 0,
            returnGeneral: 0, returnZeroRate: 0, returnSpecial: 0, returnTotal: 0, netAmount: 0
        };

        records.forEach(function (r) {
            // ğŸ†• æª¢æŸ¥æ˜¯å¦æœ‰è­¦å‘Šä¸”æœªç¢ºèª
            var warningCell = '';
            if (r.warnings && r.warnings.length > 0 && !r.warnings_acknowledged) {
                var warningText = r.warnings.join('ã€');
                warningCell = '<td class="text-center">' +
                    '<i class="fa fa-exclamation-triangle warning-icon" ' +
                    'style="color: #f39c12; cursor: pointer; font-size: 18px;" ' +
                    'data-month="' + r.month + '" ' +
                    'data-warnings="' + warningText + '" ' +
                    'title="é»æ“ŠæŸ¥çœ‹è©³æƒ…"></i>' +
                    '</td>';
            } else if (hasWarnings) {
                warningCell = '<td></td>';
            }
            
            salesHtml += '<tr>' +
                '<td class="text-center"><strong>' + r.month + '</strong></td>' +
                '<td class="text-right">' + formatNumber(r.triplicateSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.duplicateSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.nonCustomsSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.customsSales) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.taxFreeSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.specialTaxSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.otherSales) + '</td>' +
                '<td class="text-right"><strong>' + formatNumber(r.totalSales) + '</strong></td>' +
                '<td class="text-right" style="border-left: 2px solid #dee2e6;">' + formatNumber(r.returnGeneral) + '</td>' +
                '<td class="text-right">' + formatNumber(r.returnZeroRate) + '</td>' +
                '<td class="text-right">' + formatNumber(r.returnSpecial) + '</td>' +
                '<td class="text-right"><strong>' + formatNumber(r.returnTotal) + '</strong></td>' +
                '<td class="text-right"><strong>' + formatNumber(r.netAmount) + '</strong></td>' +
                warningCell +
                '</tr>';

            for (var key in salesTotals) {
                salesTotals[key] += r[key] || 0;
            }
        });

        // Add totals row - 401
        var totalWarningCell = hasWarnings ? '<td></td>' : '';
        salesHtml += '<tr style="background: #e8f4f8; font-weight: bold; border-top: 2px solid #3498db;">' +
            '<td class="text-center">åˆè¨ˆ</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.triplicateSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.duplicateSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.nonCustomsSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.customsSales) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(salesTotals.taxFreeSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.specialTaxSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.otherSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.totalSales) + '</td>' +
            '<td class="text-right" style="border-left: 2px solid #dee2e6;">' + formatNumber(salesTotals.returnGeneral) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnZeroRate) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnSpecial) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnTotal) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.netAmount) + '</td>' +
            totalWarningCell +
            '</tr>';

        $('#sales-tbody').html(salesHtml);
        
        // ğŸ†• ç¶å®šè­¦å‘Šåœ–ç¤ºé»æ“Šäº‹ä»¶
        $('.warning-icon').click(function() {
            var month = $(this).data('month');
            var warnings = $(this).data('warnings');
            showWarningDialog(month, warnings);
        });

        // Render purchase table
        var purchaseHtml = '';
        var purchaseTotals = {
            purchaseReturn: 0, purchaseReturnAssets: 0, 
            purchaseTotal: 0, assetsTotal: 0, importAmount: 0  // ğŸ”§ ä¿®æ”¹ï¼šç§»é™¤ä¸éœ€è¦çš„æ¬„ä½ï¼Œä¿ç•™éœ€è¦çš„æ¬„ä½
        };

        records.forEach(function (r) {
            // ğŸ”§ ä¿®æ”¹ï¼šç¾åœ¨å¾—æ‰£æŠµæ˜¯è¨ˆç®—å€¼ï¼Œåˆè¨ˆæ˜¯åŸå§‹å€¼
            // å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
            var deductibleExpense = (r.purchaseTotal || 0) + (r.purchaseReturn || 0);
            var deductibleAsset = (r.assetsTotal || 0) + (r.purchaseReturnAssets || 0);

            purchaseHtml += '<tr>' +
                '<td class="text-center"><strong>' + r.month + '</strong></td>' +
                '<td class="text-right"><strong>' + formatNumber(deductibleExpense) + '</strong></td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;"><strong>' + formatNumber(deductibleAsset) + '</strong></td>' +
                '<td class="text-right">' + formatNumber(r.purchaseReturn) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.purchaseReturnAssets) + '</td>' +
                '<td class="text-right">' + formatNumber(r.purchaseTotal) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.assetsTotal) + '</td>' +
                '<td class="text-right">' + formatNumber(r.importAmount) + '</td>' +
                '</tr>';

            // ğŸ”§ ä¿®æ”¹ï¼šç´¯åŠ æ•¸å€¼ - ç¾åœ¨ç´¯åŠ åˆè¨ˆå’Œé€€å›æŠ˜è®“ï¼Œè¨ˆç®—å¾—æ‰£æŠµ
            purchaseTotals.purchaseReturn += r.purchaseReturn || 0;
            purchaseTotals.purchaseReturnAssets += r.purchaseReturnAssets || 0;
            purchaseTotals.purchaseTotal += r.purchaseTotal || 0;
            purchaseTotals.assetsTotal += r.assetsTotal || 0;
            purchaseTotals.importAmount += r.importAmount || 0;
        });

        // ğŸ”§ ä¿®æ”¹ï¼šç¸½è¨ˆåˆ—è¨ˆç®— - å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
        var deductibleExpenseSum = purchaseTotals.purchaseTotal + purchaseTotals.purchaseReturn;
        var deductibleAssetSum = purchaseTotals.assetsTotal + purchaseTotals.purchaseReturnAssets;

        purchaseHtml += '<tr style="background: #d5f4e6; font-weight: bold; border-top: 2px solid #27ae60;">' +
            '<td class="text-center">åˆè¨ˆ</td>' +
            '<td class="text-right">' + formatNumber(deductibleExpenseSum) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(deductibleAssetSum) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.purchaseReturn) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(purchaseTotals.purchaseReturnAssets) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.purchaseTotal) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(purchaseTotals.assetsTotal) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.importAmount) + '</td>' +
            '</tr>';

        $('#purchase-tbody').html(purchaseHtml);

        // ğŸ†• æª¢æ¸¬è¡¨æ ¼æ»¾å‹•ç‹€æ…‹
        setTimeout(function() {
            checkTableScroll();
        }, 100);
    }

    function render403Table() {
        if (currentTableData.length === 0) {
            // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯
            $('#sales-tbody-403').html('<tr><td colspan="14" class="text-center text-muted" style="padding: 40px;">ç„¡è³‡æ–™</td></tr>');
            $('#purchase-tbody-403').html('<tr><td colspan="8" class="text-center text-muted" style="padding: 40px;">ç„¡è³‡æ–™</td></tr>');
            return;
        }

        var records = currentTableData;

        // ğŸ†• æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¨˜éŒ„æœ‰è­¦å‘Š
        var hasWarnings = records.some(r => r.warnings && r.warnings.length > 0 && !r.warnings_acknowledged);
        
        // ğŸ†• å‹•æ…‹èª¿æ•´è¡¨é ­ï¼ˆåŠ åˆ°ç¬¬ä¸€è¡Œï¼Œä½¿ç”¨ rowspan="3"ï¼‰
        var $thead = $('#sales-table-403 thead');
        var $firstRow = $thead.find('tr:first');
        
        if (hasWarnings && $firstRow.find('th:last-child').text().trim() !== 'è­¦å‘Š') {
            $firstRow.append('<th rowspan="3" style="width: 80px; text-align: center; vertical-align: middle;">è­¦å‘Š</th>');
        } else if (!hasWarnings && $firstRow.find('th:last-child').text().trim() === 'è­¦å‘Š') {
            $firstRow.find('th:last-child').remove();
        }

        // Render sales table (403)
        var salesHtml = '';
        var salesTotals = {
            triplicateSales: 0, duplicateSales: 0, nonCustomsSales: 0, customsSales: 0,
            taxFreeSales: 0, specialTaxSales: 0, otherSales: 0, totalSales: 0,
            returnGeneral: 0, returnZeroRate: 0, returnSpecial: 0, returnTotal: 0, netAmount: 0
        };

        records.forEach(function (r) {
            // ğŸ†• æª¢æŸ¥æ˜¯å¦æœ‰è­¦å‘Šä¸”æœªç¢ºèª
            var warningCell = '';
            if (r.warnings && r.warnings.length > 0 && !r.warnings_acknowledged) {
                var warningText = r.warnings.join('ã€');
                warningCell = '<td class="text-center">' +
                    '<i class="fa fa-exclamation-triangle warning-icon" ' +
                    'style="color: #f39c12; cursor: pointer; font-size: 18px;" ' +
                    'data-month="' + r.month + '" ' +
                    'data-warnings="' + warningText + '" ' +
                    'title="é»æ“ŠæŸ¥çœ‹è©³æƒ…"></i>' +
                    '</td>';
            } else if (hasWarnings) {
                warningCell = '<td></td>';
            }
            
            salesHtml += '<tr>' +
                '<td class="text-center"><strong>' + r.month + '</strong></td>' +
                '<td class="text-right">' + formatNumber(r.triplicateSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.duplicateSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.nonCustomsSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.customsSales) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.taxFreeSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.specialTaxSales) + '</td>' +
                '<td class="text-right">' + formatNumber(r.otherSales) + '</td>' +
                '<td class="text-right"><strong>' + formatNumber(r.totalSales) + '</strong></td>' +
                '<td class="text-right" style="border-left: 2px solid #dee2e6;">' + formatNumber(r.returnGeneral) + '</td>' +
                '<td class="text-right">' + formatNumber(r.returnZeroRate) + '</td>' +
                '<td class="text-right">' + formatNumber(r.returnSpecial) + '</td>' +
                '<td class="text-right"><strong>' + formatNumber(r.returnTotal) + '</strong></td>' +
                '<td class="text-right"><strong>' + formatNumber(r.netAmount) + '</strong></td>' +
                warningCell +
                '</tr>';

            for (var key in salesTotals) {
                salesTotals[key] += r[key] || 0;
            }
        });

        // Add totals row - 403
        var totalWarningCell = hasWarnings ? '<td></td>' : '';
        salesHtml += '<tr style="background: #e8f4f8; font-weight: bold; border-top: 2px solid #3498db;">' +
            '<td class="text-center">åˆè¨ˆ</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.triplicateSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.duplicateSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.nonCustomsSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.customsSales) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(salesTotals.taxFreeSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.specialTaxSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.otherSales) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.totalSales) + '</td>' +
            '<td class="text-right" style="border-left: 2px solid #dee2e6;">' + formatNumber(salesTotals.returnGeneral) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnZeroRate) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnSpecial) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.returnTotal) + '</td>' +
            '<td class="text-right">' + formatNumber(salesTotals.netAmount) + '</td>' +
            totalWarningCell +
            '</tr>';

        $('#sales-tbody-403').html(salesHtml);
        
        // ğŸ†• ç¶å®šè­¦å‘Šåœ–ç¤ºé»æ“Šäº‹ä»¶
        $('.warning-icon').click(function() {
            var month = $(this).data('month');
            var warnings = $(this).data('warnings');
            showWarningDialog(month, warnings);
        });

        // Render purchase table (403) - èˆ‡401ç›¸åŒçš„é‚è¼¯
        var purchaseHtml = '';
        var purchaseTotals = {
            purchaseReturn: 0, purchaseReturnAssets: 0, 
            purchaseTotal: 0, assetsTotal: 0, importAmount: 0
        };

        records.forEach(function (r) {
            // ğŸ”§ ä¿®æ”¹ï¼šç¾åœ¨å¾—æ‰£æŠµæ˜¯è¨ˆç®—å€¼ï¼Œåˆè¨ˆæ˜¯åŸå§‹å€¼
            // å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
            var deductibleExpense = (r.purchaseTotal || 0) + (r.purchaseReturn || 0);
            var deductibleAsset = (r.assetsTotal || 0) + (r.purchaseReturnAssets || 0);

            purchaseHtml += '<tr>' +
                '<td class="text-center"><strong>' + r.month + '</strong></td>' +
                '<td class="text-right"><strong>' + formatNumber(deductibleExpense) + '</strong></td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;"><strong>' + formatNumber(deductibleAsset) + '</strong></td>' +
                '<td class="text-right">' + formatNumber(r.purchaseReturn) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.purchaseReturnAssets) + '</td>' +
                '<td class="text-right">' + formatNumber(r.purchaseTotal) + '</td>' +
                '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(r.assetsTotal) + '</td>' +
                '<td class="text-right">' + formatNumber(r.importAmount) + '</td>' +
                '</tr>';

            // ğŸ”§ ä¿®æ”¹ï¼šç´¯åŠ æ•¸å€¼ - ç¾åœ¨ç´¯åŠ åˆè¨ˆå’Œé€€å›æŠ˜è®“ï¼Œè¨ˆç®—å¾—æ‰£æŠµ
            purchaseTotals.purchaseReturn += r.purchaseReturn || 0;
            purchaseTotals.purchaseReturnAssets += r.purchaseReturnAssets || 0;
            purchaseTotals.purchaseTotal += r.purchaseTotal || 0;
            purchaseTotals.assetsTotal += r.assetsTotal || 0;
            purchaseTotals.importAmount += r.importAmount || 0;
        });

        // ğŸ”§ ä¿®æ”¹ï¼šç¸½è¨ˆåˆ—è¨ˆç®— - å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
        var deductibleExpenseSum = purchaseTotals.purchaseTotal + purchaseTotals.purchaseReturn;
        var deductibleAssetSum = purchaseTotals.assetsTotal + purchaseTotals.purchaseReturnAssets;

        purchaseHtml += '<tr style="background: #d5f4e6; font-weight: bold; border-top: 2px solid #27ae60;">' +
            '<td class="text-center">åˆè¨ˆ</td>' +
            '<td class="text-right">' + formatNumber(deductibleExpenseSum) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(deductibleAssetSum) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.purchaseReturn) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(purchaseTotals.purchaseReturnAssets) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.purchaseTotal) + '</td>' +
            '<td class="text-right" style="border-right: 2px solid #dee2e6;">' + formatNumber(purchaseTotals.assetsTotal) + '</td>' +
            '<td class="text-right">' + formatNumber(purchaseTotals.importAmount) + '</td>' +
            '</tr>';

        $('#purchase-tbody-403').html(purchaseHtml);

        // ğŸ†• æª¢æ¸¬è¡¨æ ¼æ»¾å‹•ç‹€æ…‹
        setTimeout(function() {
            checkTableScroll();
        }, 100);
    }

    function renderWithholdingTable() {
        var isFileSourceVisible = $('.file-source-column').is(':visible');
        var isActionVisible = $('.action-column').is(':visible');


        // ğŸ†• æ§åˆ¶é ç¢¼æ¬„ä½çš„é¡¯ç¤º
        // - å–®ä¸€æª”æ¡ˆæ¨¡å¼ï¼šæœ‰å¤šé æ™‚é¡¯ç¤º
        // - å…¨éƒ¨æª”æ¡ˆæ¨¡å¼ï¼šç•¶æª”æ¡ˆä¾†æºæ¬„ä½é¡¯ç¤ºæ™‚ä¹Ÿé¡¯ç¤ºé ç¢¼
        var isPageNumberVisible = false;
        if (viewMode === 'single' && currentTableData.length > 0) {
            var totalPages = currentTableData[0].ç¸½é æ•¸ || 1;
            isPageNumberVisible = totalPages > 1;
        } else if (viewMode === 'all' && isFileSourceVisible) {
            // å…¨éƒ¨æª”æ¡ˆæ¨¡å¼ï¼šæª”æ¡ˆä¾†æºé¡¯ç¤ºæ™‚ï¼Œé ç¢¼ä¹Ÿé¡¯ç¤º
            isPageNumberVisible = true;
        }

        // é¡¯ç¤º/éš±è—é ç¢¼æ¬„ä½
        if (isPageNumberVisible) {
            $('.page-number-column').show();
        } else {
            $('.page-number-column').hide();
        }

        var colspanCount = 7;
        if (isFileSourceVisible) colspanCount++;
        if (isPageNumberVisible) colspanCount++;
        if (isActionVisible) colspanCount++;

        if (currentTableData.length === 0) {
            $('#withholding-tbody').html('<tr><td colspan="' + colspanCount + '" class="text-center text-muted" style="padding: 40px;">ç„¡è³‡æ–™</td></tr>');
            return;
        }

        var records = currentTableData;
        var html = '';

        // ğŸ†• æ ¹æ“š viewMode é¸æ“‡æ¸²æŸ“æ–¹å¼
        if (viewMode === 'single') {
            // å–®ä¸€æª”æ¡ˆæ¨¡å¼ï¼šå…ˆé æ•¸ï¼Œå†é …ç›®
            html = renderByPageThenItem(records, isFileSourceVisible, isPageNumberVisible, isActionVisible);
        } else {
            // å…¨éƒ¨æª”æ¡ˆæ¨¡å¼ï¼šåªæŒ‰é …ç›®
            html = renderByItemOnly(records, isFileSourceVisible, isPageNumberVisible, isActionVisible);
        }

        $('#withholding-tbody').html(html);

        // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
        $('.delete-record-btn').click(function () {
            var index = $(this).data('index');
            deleteRecord(index);
        });

        // ç¶å®šæ–°å¢æŒ‰éˆ•äº‹ä»¶
        $('.add-record-btn').click(function () {
            var itemName = $(this).data('item');
            showAddRecordDialog(itemName);
        });

        // ğŸ†• ç¶å®šé …ç›®ä¸‹æ‹‰é¸å–®æ”¹è®Šäº‹ä»¶
        $('.item-name-select').change(function () {
            var $row = $(this).closest('tr');
            var dataIndex = parseInt($row.attr('data-index'));
            var newItemName = $(this).val();
            
            // æ›´æ–° currentTableData ä¸­çš„é …ç›®åç¨±
            if (currentTableData[dataIndex]) {
                currentTableData[dataIndex].itemName = newItemName;
                console.log('é …ç›®å·²æ›´æ–°:', dataIndex, 'â†’', newItemName);
            }
            
            // æç¤ºä½¿ç”¨è€…å¯èƒ½éœ€è¦é‡æ–°æ’åº
            // æ³¨æ„ï¼šä¸è‡ªå‹•é‡æ–°æ’åºï¼Œå› ç‚ºæœƒæ‰“æ–·ä½¿ç”¨è€…çš„ç·¨è¼¯æµç¨‹
            // ä½¿ç”¨è€…å¯ä»¥åœ¨å„²å­˜æ™‚è‡ªå‹•æ’åº
        });

        // ğŸ†• æª¢æ¸¬è¡¨æ ¼æ˜¯å¦éœ€è¦æ»¾å‹•ä¸¦æ·»åŠ æŒ‡ç¤ºå™¨
        setTimeout(function() {
            checkTableScroll();
        }, 100);
    }

    // ğŸ†• æª¢æ¸¬è¡¨æ ¼æ»¾å‹•ç‹€æ…‹
    function checkTableScroll() {
        $('.table-responsive, .table-container').each(function() {
            var $container = $(this);
            var container = $container[0];
            
            if (container && container.scrollWidth > container.clientWidth) {
                $container.addClass('has-scroll');
            } else {
                $container.removeClass('has-scroll');
            }
        });
    }

    // ğŸ†• è¼”åŠ©å‡½æ•¸ï¼šåªæŒ‰é …ç›®æ¸²æŸ“ï¼ˆå…¨éƒ¨æª”æ¡ˆæ¨¡å¼ï¼‰
    // æ’åºé‚è¼¯ï¼šé …ç›®æ’åº > æª”åæ’åº > æª”æ¡ˆé ç¢¼æ’åº
    function renderByItemOnly(records, isFileSourceVisible, isPageNumberVisible, isActionVisible) {
        var html = '';
        var totals = { totalAmount: 0, withholdingTax: 0 };
        var colspanCount = 7;
        if (isFileSourceVisible) colspanCount++;
        if (isPageNumberVisible) colspanCount++;
        if (isActionVisible) colspanCount++;

        // è¼”åŠ©å‡½æ•¸ï¼šç²å–è¨˜éŒ„çš„æª”æ¡ˆåç¨±
        function getFileName(r) {
            if (r.jobId && allJobs) {
                var job = allJobs.find(function (j) { return j.id === r.jobId; });
                if (job) {
                    return job.original_filename || '';
                }
            }
            return '';
        }

        // æŒ‰é …ç›®åˆ†çµ„ï¼ŒåŒæ™‚è¨˜éŒ„æª”å
        var groupedRecords = {};
        records.forEach(function (r, index) {
            var itemName = r.itemName || 'æœªåˆ†é¡';
            if (!groupedRecords[itemName]) {
                groupedRecords[itemName] = {
                    records: [],
                    subtotal: { totalAmount: 0, withholdingTax: 0 }
                };
            }
            r._index = index;  // è¨˜éŒ„åœ¨ currentTableData ä¸­çš„ç´¢å¼•
            r._fileName = getFileName(r);  // é å…ˆç²å–æª”åä»¥ä¾¿æ’åº
            groupedRecords[itemName].records.push(r);
            groupedRecords[itemName].subtotal.totalAmount += r.totalAmount;
            groupedRecords[itemName].subtotal.withholdingTax += r.withholdingTax;
        });

        // å®šç¾©é …ç›®æ’åºé †åº
        var itemOrder = {
            'è–ªè³‡': 1,
            'åŸ·è¡Œæ¥­å‹™å ±é…¬': 2,
            'åˆ©æ¯': 3,
            'ç§Ÿè³ƒ': 4,
            'æ¬Šåˆ©é‡‘': 5,
            'è‚¡åˆ©': 6,
            'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç': 7,
            'é€€è·æ‰€å¾—': 8,
            'è²¡ç”¢äº¤æ˜“': 9,
            'å…¶ä»–æ‰€å¾—': 10,
            'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸': 11
        };

        // æŒ‰é …ç›®é †åºæ¸²æŸ“
        var sortedItems = Object.keys(groupedRecords).sort(function (a, b) {
            var orderA = itemOrder[a] || 999;
            var orderB = itemOrder[b] || 999;
            return orderA - orderB;
        });

        sortedItems.forEach(function (itemName) {
            var group = groupedRecords[itemName];

            // ğŸ†• åœ¨æ¯å€‹é …ç›®çµ„å…§ï¼ŒæŒ‰æª”åæ’åºï¼Œå†æŒ‰é ç¢¼æ’åºï¼Œæœ€å¾ŒæŒ‰æ†‘å–®åºè™Ÿæ’åº
            group.records.sort(function (a, b) {
                // å…ˆæ¯”è¼ƒæª”åï¼ˆå­—æ¯é †åºï¼‰
                var fileNameCompare = (a._fileName || '').localeCompare(b._fileName || '');
                if (fileNameCompare !== 0) {
                    return fileNameCompare;
                }
                // æª”åç›¸åŒï¼Œå†æ¯”è¼ƒé ç¢¼ï¼ˆæ•¸å­—é †åºï¼‰
                var pageA = a.é ç¢¼ || 1;
                var pageB = b.é ç¢¼ || 1;
                if (pageA !== pageB) {
                    return pageA - pageB;
                }
                // ğŸ†• é ç¢¼ç›¸åŒï¼Œæ¯”è¼ƒæ†‘å–®åºè™Ÿï¼ˆè‚¡åˆ©æ†‘å–®ç”¨ï¼‰
                var seqA = a.æ†‘å–®åºè™Ÿ || 0;
                var seqB = b.æ†‘å–®åºè™Ÿ || 0;
                return seqA - seqB;
            });

            // æ¸²æŸ“è©²é …ç›®çš„æ‰€æœ‰è¨˜éŒ„
            group.records.forEach(function (r) {
                // ä½¿ç”¨é å…ˆç²å–çš„æª”å
                var fileName = r._fileName;

                // åˆªé™¤æŒ‰éˆ•ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰
                var deleteBtn = isActionVisible ?
                    '<td class="text-center action-column">' +
                    '<button class="btn btn-danger btn-xs delete-record-btn" data-index="' + r._index + '" title="åˆªé™¤æ­¤è¨˜éŒ„">' +
                    '<i class="fa fa-trash"></i>' +
                    '</button>' +
                    '</td>' : '';

                // ğŸ†• é …ç›®æ¬„ä½ï¼šç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºä¸‹æ‹‰é¸å–®ï¼Œå¦å‰‡é¡¯ç¤ºæ–‡å­—
                var itemCell = '';
                if (isActionVisible) {
                    // ç·¨è¼¯æ¨¡å¼ï¼šä¸‹æ‹‰é¸å–®
                    itemCell = '<td class="item-name-cell">' +
                        '<select class="form-control input-sm item-name-select" style="width: 100%;">' +
                        '<option value="è–ªè³‡"' + (r.itemName === 'è–ªè³‡' ? ' selected' : '') + '>è–ªè³‡</option>' +
                        '<option value="åŸ·è¡Œæ¥­å‹™å ±é…¬"' + (r.itemName === 'åŸ·è¡Œæ¥­å‹™å ±é…¬' ? ' selected' : '') + '>åŸ·è¡Œæ¥­å‹™å ±é…¬</option>' +
                        '<option value="åˆ©æ¯"' + (r.itemName === 'åˆ©æ¯' ? ' selected' : '') + '>åˆ©æ¯</option>' +
                        '<option value="ç§Ÿè³ƒ"' + (r.itemName === 'ç§Ÿè³ƒ' ? ' selected' : '') + '>ç§Ÿè³ƒ</option>' +
                        '<option value="æ¬Šåˆ©é‡‘"' + (r.itemName === 'æ¬Šåˆ©é‡‘' ? ' selected' : '') + '>æ¬Šåˆ©é‡‘</option>' +
                        '<option value="è‚¡åˆ©"' + (r.itemName === 'è‚¡åˆ©' ? ' selected' : '') + '>è‚¡åˆ©</option>' +
                        '<option value="ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç"' + (r.itemName === 'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç' ? ' selected' : '') + '>ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç</option>' +
                        '<option value="é€€è·æ‰€å¾—"' + (r.itemName === 'é€€è·æ‰€å¾—' ? ' selected' : '') + '>é€€è·æ‰€å¾—</option>' +
                        '<option value="è²¡ç”¢äº¤æ˜“"' + (r.itemName === 'è²¡ç”¢äº¤æ˜“' ? ' selected' : '') + '>è²¡ç”¢äº¤æ˜“</option>' +
                        '<option value="å…¶ä»–æ‰€å¾—"' + (r.itemName === 'å…¶ä»–æ‰€å¾—' ? ' selected' : '') + '>å…¶ä»–æ‰€å¾—</option>' +
                        '<option value="é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸"' + (r.itemName === 'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸' ? ' selected' : '') + '>é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸</option>' +
                        '</select>' +
                        '</td>';
                } else {
                    // æª¢è¦–æ¨¡å¼ï¼šç´”æ–‡å­—
                    itemCell = '<td>' + r.itemName + '</td>';
                }

                html += '<tr data-job-id="' + (r.jobId || '') + '" data-index="' + r._index + '">' +
                    (isFileSourceVisible ? '<td class="file-source-column" style="font-size: 12px; color: #666;">' + fileName + '</td>' : '') +
                    (isPageNumberVisible ? '<td class="text-center page-number-column">' + formatPageNumber(r) + '</td>' : '') +
                    itemCell +
                    '<td class="text-center">' + (r.index ? '<span class="badge badge-default">' + r.index + '</span>' : '-') + '</td>' +
                    '<td>' + r.payerName + '</td>' +
                    '<td>' + r.incomeType + '</td>' +
                    '<td class="text-right"><strong>' + formatNumber(r.totalAmount) + '</strong></td>' +
                    '<td class="text-right">' + formatNumber(r.withholdingTax) + '</td>' +
                    '<td class="text-center tax-rate-column">' + 
                        calculateTaxRate(r.totalAmount, r.withholdingTax) + 
                    '</td>' +
                    deleteBtn +
                    '</tr>';

                totals.totalAmount += r.totalAmount;
                totals.withholdingTax += r.withholdingTax;
            });

            // æ–°å¢è¨˜éŒ„æŒ‰éˆ•ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰
            if (isActionVisible) {
                var addBtnColspan = colspanCount;
                html += '<tr class="add-record-row" style="background: #f9f9f9;">' +
                    '<td colspan="' + addBtnColspan + '" style="padding: 8px; text-align: left;">' +
                    '<button class="btn btn-success btn-sm add-record-btn" data-item="' + itemName + '">' +
                    '<i class="fa fa-plus"></i> æ–°å¢' + itemName + 'è¨˜éŒ„' +
                    '</button>' +
                    '</td>' +
                    '</tr>';
            }

            // å¦‚æœè©²é …ç›®æœ‰è¨˜éŒ„ï¼Œæ–°å¢é …ç›®ç¸½é¡åˆ—ï¼ˆå…¨éƒ¨æª”æ¡ˆæ¨¡å¼ä¿ç•™æ­¤åŠŸèƒ½ï¼‰
            if (group.records.length >= 1) {
                // è¨ˆç®— colspanï¼šç¸½æ¬„ä½æ•¸ - çµ¦ä»˜ç¸½é¡ - æ‰£ç¹³ç¨…é¡ - ç¨…ç‡æ¬„ä½ - (æ“ä½œæ¬„ä½ï¼Œå¦‚æœæœ‰çš„è©±)
                var subtotalColspan = colspanCount - 3 - (isActionVisible ? 1 : 0);
                html += '<tr class="subtotal-row" style="background: #e8f4f8; font-weight: bold; border-top: 2px solid #3498db;">' +
                    '<td colspan="' + subtotalColspan + '" class="text-right" style="background: #e8f4f8;">' + itemName + 'ç¸½é¡</td>' +
                    '<td class="text-right" style="background: #e8f4f8;">' + formatNumber(group.subtotal.totalAmount) + '</td>' +
                    '<td class="text-right" style="background: #e8f4f8;">' + formatNumber(group.subtotal.withholdingTax) + '</td>' +
                    '<td class="tax-rate-column text-center" style="background: #e8f4f8;">' + 
                        calculateTaxRate(group.subtotal.totalAmount, group.subtotal.withholdingTax) + 
                    '</td>' +
                    (isActionVisible ? '<td class="action-column" style="background: #fff; border-left: 1px solid #ddd;"></td>' : '') +
                    '</tr>';
            }
        });

        // Add totals row
        var totalLabel = withholdingView === 'expense' ? 'æœ¬æœŸçµ¦ä»˜åˆè¨ˆ' : 'æœ¬æœŸæ”¶å…¥åˆè¨ˆ';
        // è¨ˆç®— colspanï¼šç¸½æ¬„ä½æ•¸ - çµ¦ä»˜ç¸½é¡ - æ‰£ç¹³ç¨…é¡ - ç¨…ç‡æ¬„ä½ - (æ“ä½œæ¬„ä½ï¼Œå¦‚æœæœ‰çš„è©±)
        var totalColspan = colspanCount - 3 - (isActionVisible ? 1 : 0);
        html += '<tr style="background: #d4edda; font-weight: bold; border-top: 3px solid #28a745;">' +
            '<td colspan="' + totalColspan + '" class="text-right" style="font-size: 16px; background: #d4edda;">' + totalLabel + '</td>' +
            '<td class="text-right" style="font-size: 16px; background: #d4edda;">' + formatNumber(totals.totalAmount) + '</td>' +
            '<td class="text-right" style="font-size: 16px; background: #d4edda;">' + formatNumber(totals.withholdingTax) + '</td>' +
            '<td class="tax-rate-column text-center" style="font-size: 16px; background: #d4edda;">' + 
                calculateTaxRate(totals.totalAmount, totals.withholdingTax) + 
            '</td>' +
            (isActionVisible ? '<td class="action-column" style="background: #fff; border-left: 1px solid #ddd;"></td>' : '') +
            '</tr>';

        return html;  // ğŸ”§ å›å‚³ HTML è€Œä¸æ˜¯ç›´æ¥è¨­å®š
    }

    // ğŸ†• è¼”åŠ©å‡½æ•¸ï¼šå…ˆæŒ‰é æ•¸å†æŒ‰é …ç›®æ¸²æŸ“ï¼ˆå–®ä¸€æª”æ¡ˆæ¨¡å¼ï¼‰
    function renderByPageThenItem(records, isFileSourceVisible, isPageNumberVisible, isActionVisible) {
        var html = '';
        var totals = { totalAmount: 0, withholdingTax: 0 };
        var colspanCount = 7;
        if (isFileSourceVisible) colspanCount++;
        if (isPageNumberVisible) colspanCount++;
        if (isActionVisible) colspanCount++;

        // å®šç¾©é …ç›®æ’åºé †åº
        var itemOrder = {
            'è–ªè³‡': 1,
            'åŸ·è¡Œæ¥­å‹™å ±é…¬': 2,
            'åˆ©æ¯': 3,
            'ç§Ÿè³ƒ': 4,
            'æ¬Šåˆ©é‡‘': 5,
            'è‚¡åˆ©': 6,
            'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç': 7,
            'é€€è·æ‰€å¾—': 8,
            'è²¡ç”¢äº¤æ˜“': 9,
            'å…¶ä»–æ‰€å¾—': 10,
            'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸': 11
        };

        // ğŸ”§ å…ˆæŒ‰é ç¢¼æ’åºï¼Œå†æŒ‰æ†‘å–®åºè™Ÿæ’åºï¼Œæœ€å¾ŒæŒ‰é …ç›®æ’åº
        var sortedRecords = records.slice().sort(function (a, b) {
            var pageA = a.é ç¢¼ || 1;
            var pageB = b.é ç¢¼ || 1;

            // å…ˆæ¯”è¼ƒé ç¢¼
            if (pageA !== pageB) {
                return pageA - pageB;
            }

            // ğŸ†• é ç¢¼ç›¸åŒï¼Œæ¯”è¼ƒæ†‘å–®åºè™Ÿï¼ˆè‚¡åˆ©æ†‘å–®ç”¨ï¼‰
            var seqA = a.æ†‘å–®åºè™Ÿ || 0;
            var seqB = b.æ†‘å–®åºè™Ÿ || 0;
            if (seqA !== seqB) {
                return seqA - seqB;
            }

            // é ç¢¼å’Œæ†‘å–®åºè™Ÿéƒ½ç›¸åŒï¼Œå†æ¯”è¼ƒé …ç›®
            var itemA = a.itemName || 'æœªåˆ†é¡';
            var itemB = b.itemName || 'æœªåˆ†é¡';
            var orderA = itemOrder[itemA] || 999;
            var orderB = itemOrder[itemB] || 999;
            return orderA - orderB;
        });

        // æŒ‰é …ç›®åˆ†çµ„ï¼ˆç”¨æ–¼è¨ˆç®—å°è¨ˆï¼‰
        var groupedRecords = {};
        sortedRecords.forEach(function (r, index) {
            r._index = records.indexOf(r);  // è¨˜éŒ„åœ¨åŸå§‹ currentTableData ä¸­çš„ç´¢å¼•
            var itemName = r.itemName || 'æœªåˆ†é¡';
            if (!groupedRecords[itemName]) {
                groupedRecords[itemName] = {
                    records: [],
                    subtotal: { totalAmount: 0, withholdingTax: 0 }
                };
            }
            groupedRecords[itemName].records.push(r);
            groupedRecords[itemName].subtotal.totalAmount += r.totalAmount;
            groupedRecords[itemName].subtotal.withholdingTax += r.withholdingTax;
        });

        // æ¸²æŸ“æ’åºå¾Œçš„è¨˜éŒ„
        var currentItem = null;
        sortedRecords.forEach(function (r, idx) {
            var itemName = r.itemName || 'æœªåˆ†é¡';

            // æ¸²æŸ“è¨˜éŒ„
            var fileName = '';
            if (r.jobId && allJobs) {
                var job = allJobs.find(function (j) { return j.id === r.jobId; });
                if (job) {
                    fileName = job.original_filename || '';
                }
            }

            var deleteBtn = isActionVisible ?
                '<td class="text-center action-column">' +
                '<button class="btn btn-danger btn-xs delete-record-btn" data-index="' + r._index + '" title="åˆªé™¤æ­¤è¨˜éŒ„">' +
                '<i class="fa fa-trash"></i>' +
                '</button>' +
                '</td>' : '';

            html += '<tr data-job-id="' + (r.jobId || '') + '" data-index="' + r._index + '">' +
                (isFileSourceVisible ? '<td class="file-source-column" style="font-size: 12px; color: #666;">' + fileName + '</td>' : '') +
                (isPageNumberVisible ? '<td class="text-center page-number-column">' + formatPageNumber(r) + '</td>' : '') +
                '<td>' + r.itemName + '</td>' +
                '<td class="text-center">' + (r.index ? '<span class="badge badge-default">' + r.index + '</span>' : '-') + '</td>' +
                '<td>' + r.payerName + '</td>' +
                '<td>' + r.incomeType + '</td>' +
                '<td class="text-right"><strong>' + formatNumber(r.totalAmount) + '</strong></td>' +
                '<td class="text-right">' + formatNumber(r.withholdingTax) + '</td>' +
                '<td class="text-center tax-rate-column">' + 
                    calculateTaxRate(r.totalAmount, r.withholdingTax) + 
                '</td>' +
                deleteBtn +
                '</tr>';

            totals.totalAmount += r.totalAmount;
            totals.withholdingTax += r.withholdingTax;

            // æª¢æŸ¥æ˜¯å¦æ˜¯è©²é …ç›®çš„æœ€å¾Œä¸€ç­†è¨˜éŒ„
            var isLastOfItem = (idx === sortedRecords.length - 1) || (sortedRecords[idx + 1].itemName !== itemName);

            if (isLastOfItem) {
                // æ–°å¢è¨˜éŒ„æŒ‰éˆ•ï¼ˆåªåœ¨ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºï¼‰
                if (isActionVisible) {
                    html += '<tr class="add-record-row" style="background: #f9f9f9;">' +
                        '<td colspan="' + colspanCount + '" style="padding: 8px; text-align: left;">' +
                        '<button class="btn btn-success btn-sm add-record-btn" data-item="' + itemName + '">' +
                        '<i class="fa fa-plus"></i> æ–°å¢' + itemName + 'è¨˜éŒ„' +
                        '</button>' +
                        '</td>' +
                        '</tr>';
                }

                // ğŸ”§ æš«æ™‚é—œé–‰ï¼šå¦‚æœè©²é …ç›®æœ‰å¤šç­†è¨˜éŒ„ï¼Œæ–°å¢é …ç›®å°è¨ˆ
                // if (groupedRecords[itemName].records.length > 1) {
                //     var subtotalColspan = colspanCount - 2 - (isActionVisible ? 1 : 0);
                //     html += '<tr class="subtotal-row" style="background: #e8f4f8; font-weight: bold; border-top: 2px solid #3498db;">' +
                //         '<td colspan="' + subtotalColspan + '" class="text-right" style="background: #e8f4f8;">' + itemName + 'ç¸½é¡</td>' +
                //         '<td class="text-right" style="background: #e8f4f8;">' + formatNumber(groupedRecords[itemName].subtotal.totalAmount) + '</td>' +
                //         '<td class="text-right" style="background: #e8f4f8;">' + formatNumber(groupedRecords[itemName].subtotal.withholdingTax) + '</td>' +
                //         (isActionVisible ? '<td class="action-column" style="background: #fff; border-left: 1px solid #ddd;"></td>' : '') +
                //         '</tr>';
                // }
            }
        });

        // ç¸½è¨ˆåˆ—
        var totalLabel = withholdingView === 'expense' ? 'æœ¬æœŸçµ¦ä»˜åˆè¨ˆ' : 'æœ¬æœŸæ”¶å…¥åˆè¨ˆ';
        var totalColspan = colspanCount - 3 - (isActionVisible ? 1 : 0);
        html += '<tr style="background: #d4edda; font-weight: bold; border-top: 3px solid #28a745;">' +
            '<td colspan="' + totalColspan + '" class="text-right" style="font-size: 16px; background: #d4edda;">' + totalLabel + '</td>' +
            '<td class="text-right" style="font-size: 16px; background: #d4edda;">' + formatNumber(totals.totalAmount) + '</td>' +
            '<td class="text-right" style="font-size: 16px; background: #d4edda;">' + formatNumber(totals.withholdingTax) + '</td>' +
            '<td class="tax-rate-column text-center" style="font-size: 16px; background: #d4edda;">' + 
                calculateTaxRate(totals.totalAmount, totals.withholdingTax) + 
            '</td>' +
            (isActionVisible ? '<td class="action-column" style="background: #fff; border-left: 1px solid #ddd;"></td>' : '') +
            '</tr>';

        return html;
    }

    function makeTableEditable() {
        if ($('#table-401').is(':visible')) {
            // 401 è¡¨æ ¼ç·¨è¼¯è¨­å®š
            // éŠ·é …å’Œé€²é …è¡¨æ ¼ï¼šæ’é™¤åˆè¨ˆåˆ—å’Œæœˆä»½æ¬„ä½
            $('#sales-tbody tr:not(:last-child) td:not(:first-child), #purchase-tbody tr:not(:last-child) td:not(:first-child)')
                .attr('contenteditable', 'true');

            // é€²é …è³‡æ–™è¡¨æ ¼ï¼šæ’é™¤ã€Œå¾—æ‰£æŠµã€æ¬„ä½ï¼ˆç¬¬2å’Œç¬¬3æ¬„ï¼Œç´¢å¼•1å’Œ2ï¼‰çš„ç·¨è¼¯åŠŸèƒ½ - ğŸ”§ ä¿®æ”¹ï¼šå¾—æ‰£æŠµç¾åœ¨æ˜¯è¨ˆç®—å€¼
            $('#purchase-tbody tr:not(:last-child)').each(function () {
                $(this).find('td:eq(1), td:eq(2)').attr('contenteditable', 'false');
            });

            // éŠ·é …è³‡æ–™è¡¨æ ¼ï¼šæ’é™¤ã€ŒéŠ·å”®é¡åˆè¨ˆã€å’Œã€Œæ·¨é¡ã€æ¬„ä½ï¼ˆç¬¬9å’Œç¬¬11æ¬„ï¼Œç´¢å¼•8å’Œ10ï¼‰çš„ç·¨è¼¯åŠŸèƒ½
            $('#sales-tbody tr:not(:last-child)').each(function () {
                $(this).find('td:eq(8), td:eq(10)').attr('contenteditable', 'false');
            });

        } else if ($('#table-403').is(':visible')) {
            // 403 è¡¨æ ¼ç·¨è¼¯è¨­å®š
            // éŠ·é …å’Œé€²é …è¡¨æ ¼ï¼šæ’é™¤åˆè¨ˆåˆ—å’Œæœˆä»½æ¬„ä½
            $('#sales-tbody-403 tr:not(:last-child) td:not(:first-child), #purchase-tbody-403 tr:not(:last-child) td:not(:first-child)')
                .attr('contenteditable', 'true');

            // é€²é …è³‡æ–™è¡¨æ ¼ï¼šæ’é™¤ã€Œå¾—æ‰£æŠµã€æ¬„ä½ï¼ˆç¬¬2å’Œç¬¬3æ¬„ï¼Œç´¢å¼•1å’Œ2ï¼‰çš„ç·¨è¼¯åŠŸèƒ½ - ğŸ”§ ä¿®æ”¹ï¼šå¾—æ‰£æŠµç¾åœ¨æ˜¯è¨ˆç®—å€¼
            $('#purchase-tbody-403 tr:not(:last-child)').each(function () {
                $(this).find('td:eq(1), td:eq(2)').attr('contenteditable', 'false');
            });

            // éŠ·é …è³‡æ–™è¡¨æ ¼ï¼šæ’é™¤ã€ŒéŠ·å”®é¡åˆè¨ˆã€å’Œã€Œæ·¨é¡ã€æ¬„ä½ï¼ˆç¬¬10å’Œç¬¬12æ¬„ï¼Œç´¢å¼•9å’Œ11ï¼‰çš„ç·¨è¼¯åŠŸèƒ½
            $('#sales-tbody-403 tr:not(:last-child)').each(function () {
                $(this).find('td:eq(9), td:eq(11)').attr('contenteditable', 'false');
            });

        } else if ($('#table-withholding').is(':visible')) {
            // æ‰£ç¹³æ†‘å–®è¡¨æ ¼ç·¨è¼¯è¨­å®š
            // é¡¯ç¤ºæ“ä½œæ¬„ä½
            $('.action-column').show();

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥é¡¯ç¤ºåˆªé™¤å’Œæ–°å¢æŒ‰éˆ•
            renderWithholdingTable();

            // æ‰€æœ‰æ¬„ä½éƒ½å¯ç·¨è¼¯ï¼ˆé™¤äº†ç‰¹æ®Šåˆ—å’Œç‰¹æ®Šæ¬„ä½ï¼‰
            // æ’é™¤ï¼šå°è¨ˆåˆ—ã€æ–°å¢æŒ‰éˆ•åˆ—ã€æ“ä½œæ¬„ä½ã€æª”æ¡ˆä¾†æºæ¬„ä½ã€é ç¢¼æ¬„ä½ã€ç¨…ç‡æ¬„ä½ã€é …ç›®æ¬„ä½ï¼ˆä¸‹æ‹‰é¸å–®ï¼‰
            $('#withholding-tbody tr:not(.subtotal-row):not(.add-record-row) td:not(.action-column):not(.file-source-column):not(.page-number-column):not(.tax-rate-column):not(.item-name-cell)').attr('contenteditable', 'true');
        }

        $('.table tbody td[contenteditable="true"]').css({
            'background': '#fff9e6',
            'cursor': 'text',
            'border': '1px solid #f39c12'
        });

        // è¨ˆç®—æ¬„ä½ä¿æŒåŸæ¨£
        $('.table tbody td[contenteditable="false"]:not(:first-child)').css({
            'background': '#f0f0f0',
            'cursor': 'not-allowed'
        });

        // ç›£è½ç·¨è¼¯äº‹ä»¶ï¼Œç•¶æ•¸å€¼æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—åˆè¨ˆ
        $('.table tbody td[contenteditable="true"]').on('blur keyup paste input', function () {
            recalculateTotals();
            recalculateRowTotals($(this).closest('tr'));
        });
    }

    function makeTableReadonly() {
        $('.table tbody td').attr('contenteditable', 'false');
        $('.table tbody td').css({
            'background': '',
            'cursor': '',
            'border': ''
        });
        // ç§»é™¤äº‹ä»¶ç›£è½
        $('.table tbody td').off('blur keyup paste input');

        // éš±è—æ“ä½œæ¬„ä½
        if ($('#table-withholding').is(':visible')) {
            $('.action-column').hide();
            renderWithholdingTable();
        }
    }

    // é‡æ–°è¨ˆç®—åˆè¨ˆ
    function recalculateTotals() {
        // åˆ¤æ–·ç•¶å‰é¡¯ç¤ºçš„æ˜¯å“ªå€‹è¡¨æ ¼
        if ($('#table-401').is(':visible')) {
            recalculateSalesTotals();
            recalculatePurchaseTotals();
        } else if ($('#table-403').is(':visible')) {
            recalculate403SalesTotals();
            recalculate403PurchaseTotals();
        } else if ($('#table-withholding').is(':visible')) {
            recalculateWithholdingTotals();
        }
    }

    // é‡æ–°è¨ˆç®—éŠ·é …åˆè¨ˆ
    function recalculateSalesTotals() {
        var $tbody = $('#sales-tbody');
        var $rows = $tbody.find('tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var totals = {};

        // åˆå§‹åŒ–åˆè¨ˆ
        var columnCount = $rows.first().find('td').length;
        for (var i = 1; i < columnCount; i++) {
            totals[i] = 0;
        }

        // è¨ˆç®—æ¯ä¸€æ¬„çš„åˆè¨ˆ
        $rows.each(function () {
            $(this).find('td').each(function (index) {
                if (index > 0) { // è·³éç¬¬ä¸€æ¬„ï¼ˆæœˆä»½ï¼‰
                    var value = parseNumber($(this).text());
                    totals[index] = (totals[index] || 0) + value;
                }
            });
        });

        // æ›´æ–°åˆè¨ˆåˆ—
        var $totalRow = $tbody.find('tr:last-child');
        $totalRow.find('td').each(function (index) {
            if (index > 0) {
                $(this).text(formatNumber(totals[index]));
            }
        });
    }

    // é‡æ–°è¨ˆç®—é€²é …åˆè¨ˆ
    function recalculatePurchaseTotals() {
        var $tbody = $('#purchase-tbody');
        var $rows = $tbody.find('tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var totals = {};

        // åˆå§‹åŒ–åˆè¨ˆ
        var columnCount = $rows.first().find('td').length;
        for (var i = 1; i < columnCount; i++) {
            totals[i] = 0;
        }

        // è¨ˆç®—æ¯ä¸€æ¬„çš„åˆè¨ˆ
        $rows.each(function () {
            $(this).find('td').each(function (index) {
                if (index > 0) { // è·³éç¬¬ä¸€æ¬„ï¼ˆæœˆä»½ï¼‰
                    var value = parseNumber($(this).text());
                    totals[index] = (totals[index] || 0) + value;
                }
            });
        });

        // æ›´æ–°åˆè¨ˆåˆ—ï¼ˆéœ€è¦ç‰¹åˆ¥è™•ç†åˆè¨ˆæ¬„ä½ï¼‰
        var $totalRow = $tbody.find('tr:last-child');

        // ğŸ”§ ä¿®æ”¹ï¼šé‡æ–°è¨ˆç®—ç¸½è¨ˆé‚è¼¯ - å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
        var purchaseReturn = totals[3] || 0;       // é€€å›æŠ˜è®“-é€²è²¨åŠè²»ç”¨ç¸½è¨ˆ
        var purchaseReturnAssets = totals[4] || 0; // é€€å›æŠ˜è®“-å›ºå®šè³‡ç”¢ç¸½è¨ˆ
        var totalExpense = totals[5] || 0;         // åˆè¨ˆ-é€²è²¨åŠè²»ç”¨ç¸½è¨ˆ
        var totalAsset = totals[6] || 0;           // åˆè¨ˆ-å›ºå®šè³‡ç”¢ç¸½è¨ˆ

        // è¨ˆç®—å¾—æ‰£æŠµæ¬„ä½
        var purchaseExpense = totalExpense + purchaseReturn;    // å¾—æ‰£æŠµ-é€²è²¨åŠè²»ç”¨
        var fixedAssets = totalAsset + purchaseReturnAssets;    // å¾—æ‰£æŠµ-å›ºå®šè³‡ç”¢

        // æ›´æ–°é¡¯ç¤º
        $totalRow.find('td:eq(1)').text(formatNumber(purchaseExpense));   // è¨ˆç®—å€¼
        $totalRow.find('td:eq(2)').text(formatNumber(fixedAssets));       // è¨ˆç®—å€¼
        $totalRow.find('td:eq(3)').text(formatNumber(purchaseReturn));
        $totalRow.find('td:eq(4)').text(formatNumber(purchaseReturnAssets));
        $totalRow.find('td:eq(5)').text(formatNumber(totalExpense));
        $totalRow.find('td:eq(6)').text(formatNumber(totalAsset));
        $totalRow.find('td:eq(7)').text(formatNumber(totals[7] || 0));
    }

    // é‡æ–°è¨ˆç®—403éŠ·é …åˆè¨ˆ
    function recalculate403SalesTotals() {
        var $tbody = $('#sales-tbody-403');
        var $rows = $tbody.find('tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var totals = {};

        // åˆå§‹åŒ–åˆè¨ˆ
        var columnCount = $rows.first().find('td').length;
        for (var i = 1; i < columnCount; i++) {
            totals[i] = 0;
        }

        // è¨ˆç®—æ¯ä¸€æ¬„çš„åˆè¨ˆ
        $rows.each(function () {
            $(this).find('td').each(function (index) {
                if (index > 0) { // è·³éç¬¬ä¸€æ¬„ï¼ˆæœˆä»½ï¼‰
                    var value = parseNumber($(this).text());
                    totals[index] = (totals[index] || 0) + value;
                }
            });
        });

        // æ›´æ–°åˆè¨ˆåˆ—
        var $totalRow = $tbody.find('tr:last-child');
        $totalRow.find('td').each(function (index) {
            if (index > 0) {
                $(this).text(formatNumber(totals[index]));
            }
        });
    }

    // é‡æ–°è¨ˆç®—403é€²é …åˆè¨ˆ
    function recalculate403PurchaseTotals() {
        var $tbody = $('#purchase-tbody-403');
        var $rows = $tbody.find('tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var totals = {};

        // åˆå§‹åŒ–åˆè¨ˆ
        var columnCount = $rows.first().find('td').length;
        for (var i = 1; i < columnCount; i++) {
            totals[i] = 0;
        }

        // è¨ˆç®—æ¯ä¸€æ¬„çš„åˆè¨ˆ
        $rows.each(function () {
            $(this).find('td').each(function (index) {
                if (index > 0) { // è·³éç¬¬ä¸€æ¬„ï¼ˆæœˆä»½ï¼‰
                    var value = parseNumber($(this).text());
                    totals[index] = (totals[index] || 0) + value;
                }
            });
        });

        // æ›´æ–°åˆè¨ˆåˆ—ï¼ˆéœ€è¦ç‰¹åˆ¥è™•ç†åˆè¨ˆæ¬„ä½ï¼‰
        var $totalRow = $tbody.find('tr:last-child');

        // ğŸ”§ ä¿®æ”¹ï¼šé‡æ–°è¨ˆç®—ç¸½è¨ˆé‚è¼¯ - å¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
        var purchaseReturn = totals[3] || 0;       // é€€å›æŠ˜è®“-é€²è²¨åŠè²»ç”¨ç¸½è¨ˆ
        var purchaseReturnAssets = totals[4] || 0; // é€€å›æŠ˜è®“-å›ºå®šè³‡ç”¢ç¸½è¨ˆ
        var totalExpense = totals[5] || 0;         // åˆè¨ˆ-é€²è²¨åŠè²»ç”¨ç¸½è¨ˆ
        var totalAsset = totals[6] || 0;           // åˆè¨ˆ-å›ºå®šè³‡ç”¢ç¸½è¨ˆ

        // è¨ˆç®—å¾—æ‰£æŠµæ¬„ä½
        var purchaseExpense = totalExpense + purchaseReturn;    // å¾—æ‰£æŠµ-é€²è²¨åŠè²»ç”¨
        var fixedAssets = totalAsset + purchaseReturnAssets;    // å¾—æ‰£æŠµ-å›ºå®šè³‡ç”¢

        // æ›´æ–°é¡¯ç¤º
        $totalRow.find('td:eq(1)').text(formatNumber(purchaseExpense));   // è¨ˆç®—å€¼
        $totalRow.find('td:eq(2)').text(formatNumber(fixedAssets));       // è¨ˆç®—å€¼
        $totalRow.find('td:eq(3)').text(formatNumber(purchaseReturn));
        $totalRow.find('td:eq(4)').text(formatNumber(purchaseReturnAssets));
        $totalRow.find('td:eq(5)').text(formatNumber(totalExpense));
        $totalRow.find('td:eq(6)').text(formatNumber(totalAsset));
        $totalRow.find('td:eq(7)').text(formatNumber(totals[7] || 0));
    }

    // é‡æ–°è¨ˆç®—æ‰£ç¹³æ†‘å–®åˆè¨ˆ
    function recalculateWithholdingTotals() {
        var $tbody = $('#withholding-tbody');
        var isFileSourceVisible = $('.file-source-column').is(':visible');
        var isActionVisible = $('.action-column').is(':visible');

        // è¨ˆç®—æ¬„ä½åç§»
        var offset = 0;
        if (isFileSourceVisible) offset++;

        // åªè¨ˆç®—è³‡æ–™åˆ—ï¼ˆæ’é™¤åˆè¨ˆåˆ—ã€ç¸½é¡åˆ—ã€æ–°å¢æŒ‰éˆ•åˆ—ï¼‰
        var $dataRows = $tbody.find('tr:not(:last-child):not(.subtotal-row):not(.add-record-row)');

        // æŒ‰é …ç›®åˆ†çµ„è¨ˆç®—
        var itemTotals = {};
        var grandTotal = { totalAmount: 0, withholdingTax: 0 };

        $dataRows.each(function () {
            var $cells = $(this).find('td');
            var itemName = $cells.eq(offset + 0).text().trim();
            var totalAmount = parseNumber($cells.eq(offset + 4).text());
            var withholdingTax = parseNumber($cells.eq(offset + 5).text());

            if (!itemTotals[itemName]) {
                itemTotals[itemName] = { totalAmount: 0, withholdingTax: 0 };
            }

            itemTotals[itemName].totalAmount += totalAmount;
            itemTotals[itemName].withholdingTax += withholdingTax;

            grandTotal.totalAmount += totalAmount;
            grandTotal.withholdingTax += withholdingTax;
        });

        // æ›´æ–°å„é …ç›®çš„ç¸½é¡åˆ—
        $tbody.find('tr.subtotal-row').each(function () {
            var $row = $(this);
            var $cells = $row.find('td');
            var text = $cells.eq(0).text().trim();

            // å¾ã€Œè–ªè³‡ç¸½é¡ã€ä¸­æå–ã€Œè–ªè³‡ã€
            var itemName = text.replace('ç¸½é¡', '');

            if (itemTotals[itemName]) {
                var colspanCount = isFileSourceVisible ? 1 : 0;
                if (isActionVisible) colspanCount++;

                var totalAmountIndex = $cells.length - 2 - (isActionVisible ? 1 : 0);
                var withholdingTaxIndex = $cells.length - 1 - (isActionVisible ? 1 : 0);

                $cells.eq(totalAmountIndex).text(formatNumber(itemTotals[itemName].totalAmount));
                $cells.eq(withholdingTaxIndex).text(formatNumber(itemTotals[itemName].withholdingTax));
            }
        });

        // æ›´æ–°åˆè¨ˆåˆ—
        var $totalRow = $tbody.find('tr:last-child');
        var $totalCells = $totalRow.find('td');
        var totalAmountIndex = $totalCells.length - 2 - (isActionVisible ? 1 : 0);
        var withholdingTaxIndex = $totalCells.length - 1 - (isActionVisible ? 1 : 0);

        $totalCells.eq(totalAmountIndex).text(formatNumber(grandTotal.totalAmount));
        $totalCells.eq(withholdingTaxIndex).text(formatNumber(grandTotal.withholdingTax));
    }

    // è§£ææ•¸å­—ï¼ˆç§»é™¤åƒåˆ†ä½é€—è™Ÿï¼‰
    function parseNumber(str) {
        if (!str) return 0;
        var cleaned = str.toString().replace(/,/g, '').replace(/[^\d.-]/g, '');
        var num = parseFloat(cleaned);
        return isNaN(num) ? 0 : num;
    }

    // æ ¼å¼åŒ–æ•¸å­—ï¼ˆæ·»åŠ åƒåˆ†ä½é€—è™Ÿï¼‰
    function formatNumber(num) {
        if (num === null || num === undefined || isNaN(num)) return '0';
        return parseInt(num).toLocaleString('en-US');
    }

    // ğŸ†• æ ¼å¼åŒ–é ç¢¼é¡¯ç¤ºï¼ˆè‚¡åˆ©æ†‘å–®é¡¯ç¤ºç‚º "é ç¢¼-åºè™Ÿ"ï¼‰
    function formatPageNumber(record) {
        var pageNum = record.é ç¢¼ || '-';
        var voucherSeq = record.æ†‘å–®åºè™Ÿ;
        
        // å¦‚æœæœ‰æ†‘å–®åºè™Ÿï¼Œé¡¯ç¤ºç‚º "é ç¢¼-åºè™Ÿ" æ ¼å¼
        if (voucherSeq !== undefined && voucherSeq !== null) {
            return pageNum + '-' + voucherSeq;
        }
        
        // å¦å‰‡åªé¡¯ç¤ºé ç¢¼
        return pageNum;
    }

    // é‡æ–°è¨ˆç®—å–®è¡Œçš„åˆè¨ˆæ¬„ä½
    function recalculateRowTotals($row) {
        // åˆ¤æ–·æ˜¯å“ªå€‹è¡¨æ ¼çš„è¡Œ
        if ($row.closest('#sales-tbody').length > 0) {
            // 401 éŠ·é …è³‡æ–™ï¼šæ–°æ¬„ä½çµæ§‹ï¼ˆ14æ¬„ï¼‰
            // ç´¢å¼•ï¼š0æœˆä»½ 1ä¸‰è¯å¼ 2äºŒè¯å¼ 3ç¶“æµ·é—œ 4éç¶“æµ·é—œ 5å…ç¨… 6ç‰¹ç¨®ç¨…é¡ 7å…¶ä»–
            //       8éŠ·å”®é¡åˆè¨ˆ 9é€€å›ä¸€èˆ¬ 10é€€å›é›¶ç¨…ç‡ 11é€€å›ç‰¹ç¨® 12é€€å›åˆè¨ˆ 13æ·¨é¡
            var $cells = $row.find('td');

            // éŠ·å”®é¡åˆè¨ˆ = ä¸‰è¯å¼ + äºŒè¯å¼ + ç¶“æµ·é—œ + éç¶“æµ·é—œ + å…ç¨… + ç‰¹ç¨®ç¨…é¡ + å…¶ä»–
            var totalSales =
                parseNumber($cells.eq(1).text()) +  // ä¸‰è¯å¼
                parseNumber($cells.eq(2).text()) +  // äºŒè¯å¼
                parseNumber($cells.eq(3).text()) +  // ç¶“æµ·é—œ
                parseNumber($cells.eq(4).text()) +  // éç¶“æµ·é—œ
                parseNumber($cells.eq(5).text()) +  // å…ç¨…
                parseNumber($cells.eq(6).text()) +  // ç‰¹ç¨®ç¨…é¡
                parseNumber($cells.eq(7).text());   // å…¶ä»–

            // éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ = ä¸€èˆ¬ + é›¶ç¨…ç‡ + ç‰¹ç¨®
            var returnGeneral = parseNumber($cells.eq(9).text());
            var returnZeroRate = parseNumber($cells.eq(10).text());
            var returnSpecial = parseNumber($cells.eq(11).text());
            var returnTotal = returnGeneral + returnZeroRate + returnSpecial;

            // æ·¨é¡ = éŠ·å”®é¡åˆè¨ˆ - éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
            var netAmount = totalSales - returnTotal;

            // ä¿ç•™ <strong> æ¨™ç±¤
            $cells.eq(8).html('<strong>' + formatNumber(totalSales) + '</strong>');
            $cells.eq(12).html('<strong>' + formatNumber(returnTotal) + '</strong>');
            $cells.eq(13).html('<strong>' + formatNumber(netAmount) + '</strong>');

        } else if ($row.closest('#sales-tbody-403').length > 0) {
            // 403 éŠ·é …è³‡æ–™ï¼šæ–°æ¬„ä½çµæ§‹ï¼ˆ14æ¬„ï¼‰
            // ç´¢å¼•ï¼š0æœˆä»½ 1ä¸‰è¯å¼ 2äºŒè¯å¼ 3ç¶“æµ·é—œ 4éç¶“æµ·é—œ 5å…ç¨… 6ç‰¹ç¨®ç¨…é¡ 7å…¶ä»–
            //       8éŠ·å”®é¡åˆè¨ˆ 9é€€å›ä¸€èˆ¬ 10é€€å›é›¶ç¨…ç‡ 11é€€å›ç‰¹ç¨® 12é€€å›åˆè¨ˆ 13æ·¨é¡
            var $cells = $row.find('td');

            // éŠ·å”®é¡åˆè¨ˆ = ä¸‰è¯å¼ + äºŒè¯å¼ + ç¶“æµ·é—œ + éç¶“æµ·é—œ + å…ç¨… + ç‰¹ç¨®ç¨…é¡ + å…¶ä»–
            var totalSales =
                parseNumber($cells.eq(1).text()) +  // ä¸‰è¯å¼
                parseNumber($cells.eq(2).text()) +  // äºŒè¯å¼
                parseNumber($cells.eq(3).text()) +  // ç¶“æµ·é—œ
                parseNumber($cells.eq(4).text()) +  // éç¶“æµ·é—œ
                parseNumber($cells.eq(5).text()) +  // å…ç¨…
                parseNumber($cells.eq(6).text()) +  // ç‰¹ç¨®ç¨…é¡éŠ·å”®é¡
                parseNumber($cells.eq(7).text());   // å…¶ä»–

            // éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ = ä¸€èˆ¬ + é›¶ç¨…ç‡ + ç‰¹ç¨®
            var returnGeneral = parseNumber($cells.eq(9).text());
            var returnZeroRate = parseNumber($cells.eq(10).text());
            var returnSpecial = parseNumber($cells.eq(11).text());
            var returnTotal = returnGeneral + returnZeroRate + returnSpecial;

            // æ·¨é¡ = éŠ·å”®é¡åˆè¨ˆ - éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
            var netAmount = totalSales - returnTotal;

            // ä¿ç•™ <strong> æ¨™ç±¤
            $cells.eq(8).html('<strong>' + formatNumber(totalSales) + '</strong>');
            $cells.eq(12).html('<strong>' + formatNumber(returnTotal) + '</strong>');
            $cells.eq(13).html('<strong>' + formatNumber(netAmount) + '</strong>');

        } else if ($row.closest('#purchase-tbody').length > 0) {
            // 401 é€²é …è³‡æ–™ï¼šè¨ˆç®—å¾—æ‰£æŠµæ¬„ä½ï¼ˆç¬¬2å’Œç¬¬3æ¬„ï¼‰- ğŸ”§ ä¿®æ”¹ï¼šå¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
            var $cells = $row.find('td');

            // å¾—æ‰£æŠµé€²è²¨åŠè²»ç”¨ = åˆè¨ˆé€²è²¨åŠè²»ç”¨ + é€€å›æŠ˜è®“é€²è²¨åŠè²»ç”¨
            var deductibleExpense = parseNumber($cells.eq(5).text()) + parseNumber($cells.eq(3).text());

            // å¾—æ‰£æŠµå›ºå®šè³‡ç”¢ = åˆè¨ˆå›ºå®šè³‡ç”¢ + é€€å›æŠ˜è®“å›ºå®šè³‡ç”¢
            var deductibleAsset = parseNumber($cells.eq(6).text()) + parseNumber($cells.eq(4).text());

            // ä¿ç•™ <strong> æ¨™ç±¤
            $cells.eq(1).html('<strong>' + formatNumber(deductibleExpense) + '</strong>');
            $cells.eq(2).html('<strong>' + formatNumber(deductibleAsset) + '</strong>');

        } else if ($row.closest('#purchase-tbody-403').length > 0) {
            // 403 é€²é …è³‡æ–™ï¼šè¨ˆç®—å¾—æ‰£æŠµæ¬„ä½ï¼ˆç¬¬2å’Œç¬¬3æ¬„ï¼‰- ğŸ”§ ä¿®æ”¹ï¼šå¾—æ‰£æŠµ = åˆè¨ˆ + é€€å›æŠ˜è®“
            var $cells = $row.find('td');

            // å¾—æ‰£æŠµé€²è²¨åŠè²»ç”¨ = åˆè¨ˆé€²è²¨åŠè²»ç”¨ + é€€å›æŠ˜è®“é€²è²¨åŠè²»ç”¨
            var deductibleExpense = parseNumber($cells.eq(5).text()) + parseNumber($cells.eq(3).text());

            // å¾—æ‰£æŠµå›ºå®šè³‡ç”¢ = åˆè¨ˆå›ºå®šè³‡ç”¢ + é€€å›æŠ˜è®“å›ºå®šè³‡ç”¢
            var deductibleAsset = parseNumber($cells.eq(6).text()) + parseNumber($cells.eq(4).text());

            // ä¿ç•™ <strong> æ¨™ç±¤
            $cells.eq(1).html('<strong>' + formatNumber(deductibleExpense) + '</strong>');
            $cells.eq(2).html('<strong>' + formatNumber(deductibleAsset) + '</strong>');
        }
    }

    // åŒæ­¥è¡¨æ ¼è³‡æ–™å› currentTableDataï¼ˆåœ¨å»ºç«‹ç‰ˆæœ¬å‰å‘¼å«ï¼‰
    function syncTableDataToCurrentData() {
        if ($('#table-401').is(':visible')) {
            // 401 è¡¨æ ¼ï¼šå¾éŠ·é …å’Œé€²é …è¡¨æ ¼è®€å–è³‡æ–™
            sync401TableData();
        } else if ($('#table-403').is(':visible')) {
            // 403 è¡¨æ ¼ï¼šå¾éŠ·é …å’Œé€²é …è¡¨æ ¼è®€å–è³‡æ–™
            sync403TableData();
        } else if ($('#table-withholding').is(':visible')) {
            // æ‰£ç¹³æ†‘å–®è¡¨æ ¼ï¼šå¾æ‰£ç¹³æ†‘å–®è¡¨æ ¼è®€å–è³‡æ–™
            syncWithholdingTableData();
        }
    }

    function sync401TableData() {
        var newData = [];
        var $salesRows = $('#sales-tbody tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var $purchaseRows = $('#purchase-tbody tr:not(:last-child)');

        $salesRows.each(function (index) {
            var $salesCells = $(this).find('td');
            var $purchaseCells = $purchaseRows.eq(index).find('td');

            var record = {
                month: $salesCells.eq(0).text().trim(),
                monthSort: currentTableData[index] ? currentTableData[index].monthSort : index,
                é ç¢¼: currentTableData[index] ? currentTableData[index].é ç¢¼ : 1,      // ä¿ç•™é ç¢¼
                ç¸½é æ•¸: currentTableData[index] ? currentTableData[index].ç¸½é æ•¸ : 1,  // ä¿ç•™ç¸½é æ•¸
                // éŠ·é … - 14æ¬„çµæ§‹ï¼ˆéç¶“æµ·é—œåœ¨å‰ï¼Œç¶“æµ·é—œåœ¨å¾Œï¼‰
                triplicateSales: parseNumber($salesCells.eq(1).text()),
                duplicateSales: parseNumber($salesCells.eq(2).text()),
                nonCustomsSales: parseNumber($salesCells.eq(3).text()),     // éç¶“æµ·é—œ
                customsSales: parseNumber($salesCells.eq(4).text()),        // ç¶“æµ·é—œ
                taxFreeSales: parseNumber($salesCells.eq(5).text()),
                specialTaxSales: parseNumber($salesCells.eq(6).text()),
                otherSales: parseNumber($salesCells.eq(7).text()),
                totalSales: parseNumber($salesCells.eq(8).text()),
                // éŠ·è²¨é€€å›åŠæŠ˜è®“ (3å­æ¬„ + åˆè¨ˆ)
                returnGeneral: parseNumber($salesCells.eq(9).text()),       // ä¸€èˆ¬
                returnZeroRate: parseNumber($salesCells.eq(10).text()),     // é›¶ç¨…ç‡
                returnSpecial: parseNumber($salesCells.eq(11).text()),      // ç‰¹ç¨® (401å›ºå®šç‚º0)
                returnTotal: parseNumber($salesCells.eq(12).text()),        // éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
                netAmount: parseNumber($salesCells.eq(13).text()),
                // é€²é …
                purchaseAndExpense: parseNumber($purchaseCells.eq(1).text()),
                fixedAssets: parseNumber($purchaseCells.eq(2).text()),
                purchaseReturn: parseNumber($purchaseCells.eq(3).text()),
                purchaseReturnAssets: parseNumber($purchaseCells.eq(4).text()),
                purchaseTotal: parseNumber($purchaseCells.eq(5).text()),        // åˆè¨ˆ-é€²è²¨åŠè²»ç”¨
                assetsTotal: parseNumber($purchaseCells.eq(6).text()),          // åˆè¨ˆ-å›ºå®šè³‡ç”¢
                importAmount: parseNumber($purchaseCells.eq(7).text())
            };

            newData.push(record);
        });

        currentTableData = newData;
        console.log('å·²åŒæ­¥ 401 è¡¨æ ¼è³‡æ–™å› currentTableData:', currentTableData);
    }

    function sync403TableData() {
        var newData = [];
        var $salesRows = $('#sales-tbody-403 tr:not(:last-child)'); // æ’é™¤åˆè¨ˆåˆ—
        var $purchaseRows = $('#purchase-tbody-403 tr:not(:last-child)');

        $salesRows.each(function (index) {
            var $salesCells = $(this).find('td');
            var $purchaseCells = $purchaseRows.eq(index).find('td');

            var record = {
                month: $salesCells.eq(0).text().trim(),
                monthSort: currentTableData[index] ? currentTableData[index].monthSort : index,
                é ç¢¼: currentTableData[index] ? currentTableData[index].é ç¢¼ : 1,      // ä¿ç•™é ç¢¼
                ç¸½é æ•¸: currentTableData[index] ? currentTableData[index].ç¸½é æ•¸ : 1,  // ä¿ç•™ç¸½é æ•¸
                // éŠ·é … - 14æ¬„çµæ§‹ï¼ˆéç¶“æµ·é—œåœ¨å‰ï¼Œç¶“æµ·é—œåœ¨å¾Œï¼‰
                triplicateSales: parseNumber($salesCells.eq(1).text()),
                duplicateSales: parseNumber($salesCells.eq(2).text()),
                nonCustomsSales: parseNumber($salesCells.eq(3).text()),     // éç¶“æµ·é—œ
                customsSales: parseNumber($salesCells.eq(4).text()),        // ç¶“æµ·é—œ
                taxFreeSales: parseNumber($salesCells.eq(5).text()),
                specialTaxSales: parseNumber($salesCells.eq(6).text()),
                otherSales: parseNumber($salesCells.eq(7).text()),
                totalSales: parseNumber($salesCells.eq(8).text()),
                // éŠ·è²¨é€€å›åŠæŠ˜è®“ (3å­æ¬„ + åˆè¨ˆ)
                returnGeneral: parseNumber($salesCells.eq(9).text()),       // ä¸€èˆ¬
                returnZeroRate: parseNumber($salesCells.eq(10).text()),     // é›¶ç¨…ç‡
                returnSpecial: parseNumber($salesCells.eq(11).text()),      // ç‰¹ç¨®
                returnTotal: parseNumber($salesCells.eq(12).text()),        // éŠ·è²¨é€€å›åŠæŠ˜è®“åˆè¨ˆ
                netAmount: parseNumber($salesCells.eq(13).text()),
                // é€²é …
                purchaseAndExpense: parseNumber($purchaseCells.eq(1).text()),
                fixedAssets: parseNumber($purchaseCells.eq(2).text()),
                purchaseReturn: parseNumber($purchaseCells.eq(3).text()),
                purchaseReturnAssets: parseNumber($purchaseCells.eq(4).text()),
                purchaseTotal: parseNumber($purchaseCells.eq(5).text()),        // åˆè¨ˆ-é€²è²¨åŠè²»ç”¨
                assetsTotal: parseNumber($purchaseCells.eq(6).text()),          // åˆè¨ˆ-å›ºå®šè³‡ç”¢
                importAmount: parseNumber($purchaseCells.eq(7).text())
            };

            newData.push(record);
        });

        currentTableData = newData;
        console.log('å·²åŒæ­¥ 403 è¡¨æ ¼è³‡æ–™å› currentTableData:', currentTableData);
    }

    function syncWithholdingTableData() {
        var newData = [];
        // æ’é™¤åˆè¨ˆåˆ—ã€ç¸½é¡åˆ—ã€æ–°å¢æŒ‰éˆ•åˆ—
        var $rows = $('#withholding-tbody tr:not(:last-child):not(.subtotal-row):not(.add-record-row)');

        console.log('=== åŒæ­¥æ‰£ç¹³æ†‘å–®è¡¨æ ¼è³‡æ–™ ===');
        console.log('è¡¨æ ¼è¡Œæ•¸ï¼ˆä¸å«åˆè¨ˆ/ç¸½é¡/æ–°å¢æŒ‰éˆ•ï¼‰:', $rows.length);
        console.log('åŸå§‹ currentTableData é•·åº¦:', currentTableData.length);

        $rows.each(function (index) {
            var $row = $(this);
            var $cells = $row.find('td');
            var jobId = parseInt($row.attr('data-job-id')) || null;
            var dataIndex = parseInt($row.attr('data-index')) || index;

            // æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆä¾†æºæ¬„ä½å’Œé ç¢¼æ¬„ä½
            var hasFileSource = $('.file-source-column').is(':visible');
            var hasPageNumber = $('.page-number-column').is(':visible');
            var offset = 0;
            if (hasFileSource) offset++;
            if (hasPageNumber) offset++;

            // ğŸ”§ ä¿®å¾©ï¼šå¾åŸå§‹è³‡æ–™ä¸­æ­£ç¢ºç²å–é ç¢¼è³‡è¨Š
            var originalRecord = currentTableData[dataIndex] || currentTableData.find(function(r, i) {
                return r.jobId === jobId && i === index;
            });

            // ğŸ†• è®€å–é …ç›®ï¼šå¦‚æœæ˜¯ä¸‹æ‹‰é¸å–®å‰‡å¾ select è®€å–ï¼Œå¦å‰‡å¾æ–‡å­—è®€å–
            var $itemCell = $cells.eq(offset + 0);
            var itemName = '';
            if ($itemCell.find('select.item-name-select').length > 0) {
                // ç·¨è¼¯æ¨¡å¼ï¼šå¾ä¸‹æ‹‰é¸å–®è®€å–
                itemName = $itemCell.find('select.item-name-select').val();
            } else {
                // æª¢è¦–æ¨¡å¼ï¼šå¾æ–‡å­—è®€å–
                itemName = $itemCell.text().trim();
            }

            var record = {
                jobId: jobId,  // ä¿ç•™ jobId
                fileName: originalRecord ? originalRecord.fileName : '',  // ğŸ†• ä¿ç•™æª”æ¡ˆåç¨±
                é ç¢¼: originalRecord ? originalRecord.é ç¢¼ : 1,      // ğŸ”§ ä¿®å¾©ï¼šæ­£ç¢ºä¿ç•™é ç¢¼
                ç¸½é æ•¸: originalRecord ? originalRecord.ç¸½é æ•¸ : 1,  // ğŸ”§ ä¿®å¾©ï¼šæ­£ç¢ºä¿ç•™ç¸½é æ•¸
                æ†‘å–®åºè™Ÿ: originalRecord ? originalRecord.æ†‘å–®åºè™Ÿ : null,  // ğŸ†• ä¿ç•™æ†‘å–®åºè™Ÿï¼ˆè‚¡åˆ©æ†‘å–®ç”¨ï¼‰
                itemName: itemName,
                index: $cells.eq(offset + 1).find('.badge').text().trim() || '',
                payerName: $cells.eq(offset + 2).text().trim(),
                incomeType: $cells.eq(offset + 3).text().trim(),
                totalAmount: parseNumber($cells.eq(offset + 4).text()),
                withholdingTax: parseNumber($cells.eq(offset + 5).text())
            };

            if (index < 3) {  // åªé¡¯ç¤ºå‰ 3 ç­†
                console.log('è¡Œ ' + index + ':', {
                    jobId: record.jobId,
                    é ç¢¼: record.é ç¢¼,
                    æ†‘å–®åºè™Ÿ: record.æ†‘å–®åºè™Ÿ,
                    itemName: record.itemName,
                    payerName: record.payerName,
                    totalAmount: record.totalAmount,
                    originalRecord: originalRecord ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'
                });
            }

            newData.push(record);
        });

        currentTableData = newData;
        console.log('åŒæ­¥å®Œæˆï¼Œç¸½ç­†æ•¸:', currentTableData.length);
        console.log('æŒ‰ jobId çµ±è¨ˆ:', currentTableData.reduce(function (acc, r) {
            acc[r.jobId] = (acc[r.jobId] || 0) + 1;
            return acc;
        }, {}));
        console.log('æŒ‰é ç¢¼çµ±è¨ˆ:', currentTableData.reduce(function (acc, r) {
            acc[r.é ç¢¼] = (acc[r.é ç¢¼] || 0) + 1;
            return acc;
        }, {}));
        console.log('===========================');
    }

    // ============ æ–°å¢/åˆªé™¤è¨˜éŒ„åŠŸèƒ½ ============

    // é …ç›®èˆ‡æ‰€å¾—é¡åˆ¥çš„å°æ‡‰é—œä¿‚
    var itemToIncomeTypeMap = {
        'è–ªè³‡': 'è–ªè³‡',
        'åŸ·è¡Œæ¥­å‹™å ±é…¬': 'åŸ·è¡Œæ¥­å‹™ä¸€èˆ¬',
        'åˆ©æ¯': 'åˆ©æ¯',
        'ç§Ÿè³ƒ': 'ç§Ÿè³ƒ',
        'æ¬Šåˆ©é‡‘': 'æ¬Šåˆ©é‡‘',
        'è‚¡åˆ©': 'ç‡Ÿåˆ©æ‰€å¾—87å¹´åº¦æˆ–ä»¥å¾Œå¹´åº¦è‚¡åˆ©æˆ–ç›ˆé¤˜',
        'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç': 'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç',
        'é€€è·æ‰€å¾—': 'é€€è·æ‰€å¾—',
        'è²¡ç”¢äº¤æ˜“': 'è²¡ç”¢äº¤æ˜“æ‰€å¾—',
        'å…¶ä»–æ‰€å¾—': 'å‰4é …ä»¥å¤–ä¹‹å…¶ä»–æ‰€å¾—',
        'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸': 'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸'
    };

    function deleteRecord(index) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨˜éŒ„å—ï¼Ÿ')) {
            return;
        }

        // å¾ currentTableData ä¸­ç§»é™¤
        currentTableData.splice(index, 1);

        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderWithholdingTable();

        // é‡æ–°å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
        makeTableEditable();

        showNotification('å·²åˆªé™¤è¨˜éŒ„', 'success');
    }

    function showAddRecordDialog(itemName) {
        // ğŸ†• ä½¿ç”¨æ–°çš„ Modal å°è©±æ¡†
        $('#new-record-item-name').val(itemName);
        populateFileNameOptions();
        $('#addRecordModal').modal('show');
    }

    // ğŸ†• å¡«å……æª”æ¡ˆä¸‹æ‹‰é¸å–®
    function populateFileNameOptions() {
        var $select = $('#new-record-file-name');
        $select.empty().append('<option value="">è«‹é¸æ“‡æª”æ¡ˆ</option>');
        
        // å¾ allJobs ä¸­å–å¾—æª”æ¡ˆè³‡è¨Š
        var fileMap = {};
        allJobs.forEach(function(job) {
            if (job.original_filename && !fileMap[job.id]) {
                var totalPages = 1;
                if (job.result_json) {
                    if (job.result_json.é é¢è³‡æ–™ && Array.isArray(job.result_json.é é¢è³‡æ–™)) {
                        totalPages = job.result_json.é é¢è³‡æ–™.length;
                    } else if (job.result_json.ç¸½é æ•¸) {
                        totalPages = job.result_json.ç¸½é æ•¸;
                    }
                }
                fileMap[job.id] = {
                    fileName: job.original_filename,
                    totalPages: totalPages
                };
            }
        });
        
        Object.keys(fileMap).forEach(function(jobId) {
            var info = fileMap[jobId];
            $select.append(
                $('<option></option>')
                    .val(jobId)
                    .text(info.fileName)
                    .data('total-pages', info.totalPages)
            );
        });
    }

    // ğŸ†• æ–°å¢è¨˜éŒ„ï¼ˆå«æª”æ¡ˆå’Œé ç¢¼è³‡è¨Šï¼‰
    function addNewRecordWithFileInfo(itemName, jobId, pageNumber) {
        var selectedJob = allJobs.find(function(j) { return j.id == jobId; });
        if (!selectedJob) {
            showNotification('æ‰¾ä¸åˆ°é¸æ“‡çš„æª”æ¡ˆ', 'danger');
            return;
        }
        
        // å–å¾— payerNameï¼ˆæ‰£ç¹³å–®ä½åç¨±ï¼‰
        var payerName = '';
        var totalPages = 1;
        
        if (selectedJob.result_json) {
            if (selectedJob.result_json.é é¢è³‡æ–™ && Array.isArray(selectedJob.result_json.é é¢è³‡æ–™)) {
                // å¤šé æ ¼å¼ï¼šå¾æŒ‡å®šé é¢å–å¾—
                totalPages = selectedJob.result_json.é é¢è³‡æ–™.length;
                var pageData = selectedJob.result_json.é é¢è³‡æ–™.find(function(p) { 
                    return p.é ç¢¼ === pageNumber; 
                });
                if (!pageData && pageNumber <= totalPages) {
                    // å¦‚æœæ‰¾ä¸åˆ°ç²¾ç¢ºåŒ¹é…ï¼Œä½¿ç”¨ç´¢å¼•
                    pageData = selectedJob.result_json.é é¢è³‡æ–™[pageNumber - 1];
                }
                payerName = pageData ? (pageData.æ‰£ç¹³å–®ä½åç¨± || '') : '';
            } else {
                // å–®é æ ¼å¼ï¼šç›´æ¥å–å¾—
                payerName = selectedJob.result_json.æ‰£ç¹³å–®ä½åç¨± || '';
                totalPages = selectedJob.result_json.ç¸½é æ•¸ || 1;
            }
        }
        
        // å»ºç«‹æ–°è¨˜éŒ„
        var newRecord = {
            jobId: selectedJob.id,
            fileName: selectedJob.original_filename,
            é ç¢¼: pageNumber,
            ç¸½é æ•¸: totalPages,
            itemName: itemName,
            index: '',
            payerName: payerName,
            incomeType: '',
            totalAmount: 0,
            withholdingTax: 0
        };
        
        // æ‰¾åˆ°æ’å…¥ä½ç½®ï¼ˆæŒ‰é …ç›®æ’åºï¼‰
        var insertIndex = findInsertPosition(itemName);
        currentTableData.splice(insertIndex, 0, newRecord);
        
        // é‡æ–°æ¸²æŸ“è¡¨æ ¼
        renderWithholdingTable();
        
        // é‡æ–°å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
        makeTableEditable();
        
        showNotification('å·²æ–°å¢è¨˜éŒ„ï¼Œè«‹å¡«å¯«è©³ç´°è³‡è¨Š', 'success');
    }

    // ğŸ†• æ‰¾åˆ°æ’å…¥ä½ç½®ï¼ˆæŒ‰é …ç›®æ’åºï¼‰
    function findInsertPosition(itemName) {
        var itemOrder = {
            'è–ªè³‡': 1, 'åŸ·è¡Œæ¥­å‹™å ±é…¬': 2, 'åˆ©æ¯': 3, 'ç§Ÿè³ƒ': 4, 'æ¬Šåˆ©é‡‘': 5,
            'è‚¡åˆ©': 6, 'ç«¶æŠ€ã€ç«¶è³½åŠæ©Ÿæœƒä¸­ç': 7, 'é€€è·æ‰€å¾—': 8, 'è²¡ç”¢äº¤æ˜“': 9,
            'å…¶ä»–æ‰€å¾—': 10, 'é€€ä¼‘é‡‘å“¡å·¥è‡ªææ•¸': 11
        };
        
        var targetOrder = itemOrder[itemName] || 999;
        
        for (var i = 0; i < currentTableData.length; i++) {
            var currentOrder = itemOrder[currentTableData[i].itemName] || 999;
            if (currentOrder > targetOrder) {
                return i;
            }
        }
        
        return currentTableData.length;
    }

    function addRecord(itemName) {
        var defaultIncomeType = itemToIncomeTypeMap[itemName] || '';

        // åˆ¤æ–·æ˜¯ã€Œå…¨éƒ¨æª”æ¡ˆã€é‚„æ˜¯ã€Œå€‹åˆ¥æª”æ¡ˆã€æ¨¡å¼
        var isAllMode = viewMode === 'all';

        // æ§‹å»ºå°è©±æ¡† HTML
        var dialogHtml = '<div class="modal fade" id="addRecordModal" tabindex="-1" role="dialog">' +
            '<div class="modal-dialog" role="document">' +
            '<div class="modal-content">' +
            '<div class="modal-header">' +
            '<button type="button" class="close" data-dismiss="modal">&times;</button>' +
            '<h4 class="modal-title">æ–°å¢' + itemName + 'è¨˜éŒ„</h4>' +
            '</div>' +
            '<div class="modal-body">' +
            '<form id="addRecordForm">';

        // å¦‚æœæ˜¯ã€Œå…¨éƒ¨æª”æ¡ˆã€æ¨¡å¼ï¼Œæ–°å¢æª”æ¡ˆé¸æ“‡ä¸‹æ‹‰é¸å–®
        if (isAllMode && allJobs.length > 1) {
            dialogHtml += '<div class="form-group">' +
                '<label>é¸æ“‡æª”æ¡ˆ <span class="text-danger">*</span></label>' +
                '<select class="form-control" id="add-record-job-id" required>';

            allJobs.forEach(function (job) {
                var fileName = job.original_filename || 'æœªå‘½åæª”æ¡ˆ';
                dialogHtml += '<option value="' + job.id + '">' + fileName + '</option>';
            });

            dialogHtml += '</select>' +
                '</div>';
        }

        dialogHtml += '<div class="form-group">' +
            '<label>æ‰£ç¹³å–®ä½åç¨±</label>' +
            '<input type="text" class="form-control" id="add-record-payer-name" placeholder="è«‹è¼¸å…¥æ‰£ç¹³å–®ä½åç¨±">' +
            '</div>' +
            '<div class="form-group">' +
            '<label>æ‰€å¾—é¡åˆ¥åŠä»£è™Ÿ</label>' +
            '<input type="text" class="form-control" id="add-record-income-type" value="' + defaultIncomeType + '" placeholder="è«‹è¼¸å…¥æ‰€å¾—é¡åˆ¥">' +
            '</div>' +
            '<div class="form-group">' +
            '<label>å„é¡çµ¦ä»˜ç¸½é¡</label>' +
            '<input type="number" class="form-control" id="add-record-total-amount" value="0" min="0" step="1">' +
            '</div>' +
            '<div class="form-group">' +
            '<label>æ‰£ç¹³ç¨…é¡</label>' +
            '<input type="number" class="form-control" id="add-record-withholding-tax" value="0" min="0" step="1">' +
            '</div>' +
            '</form>' +
            '</div>' +
            '<div class="modal-footer">' +
            '<button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>' +
            '<button type="button" class="btn btn-primary" id="confirm-add-record-btn">ç¢ºå®š</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        // ç§»é™¤èˆŠçš„å°è©±æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        $('#addRecordModal').remove();

        // æ–°å¢å°è©±æ¡†åˆ°é é¢
        $('body').append(dialogHtml);

        // é¡¯ç¤ºå°è©±æ¡†
        $('#addRecordModal').modal('show');

        // è‡ªå‹•å¡«å…¥æ‰£ç¹³å–®ä½åç¨±
        $('#addRecordModal').on('shown.bs.modal', function () {
            var jobId = isAllMode && allJobs.length > 1 ?
                parseInt($('#add-record-job-id').val()) :
                (selectedJobId || allJobs[0].id);

            var job = allJobs.find(function (j) { return j.id === jobId; });
            if (job && job.result_json) {
                var payerName = '';
                if (job.result_json.é é¢è³‡æ–™ && job.result_json.é é¢è³‡æ–™.length > 0) {
                    payerName = job.result_json.é é¢è³‡æ–™[0].æ‰£ç¹³å–®ä½åç¨± || '';
                } else {
                    payerName = job.result_json.æ‰£ç¹³å–®ä½åç¨± || '';
                }
                $('#add-record-payer-name').val(payerName);
            }
        });

        // ç•¶é¸æ“‡æª”æ¡ˆæ”¹è®Šæ™‚ï¼Œæ›´æ–°æ‰£ç¹³å–®ä½åç¨±
        $('#add-record-job-id').change(function () {
            var jobId = parseInt($(this).val());
            var job = allJobs.find(function (j) { return j.id === jobId; });
            if (job && job.result_json) {
                var payerName = '';
                if (job.result_json.é é¢è³‡æ–™ && job.result_json.é é¢è³‡æ–™.length > 0) {
                    payerName = job.result_json.é é¢è³‡æ–™[0].æ‰£ç¹³å–®ä½åç¨± || '';
                } else {
                    payerName = job.result_json.æ‰£ç¹³å–®ä½åç¨± || '';
                }
                $('#add-record-payer-name').val(payerName);
            }
        });

        // ç¢ºå®šæŒ‰éˆ•äº‹ä»¶
        $('#confirm-add-record-btn').click(function () {
            addRecord(itemName);
        });
    }

    function addRecord(itemName) {
        // å–å¾—è¡¨å–®è³‡æ–™
        var jobId = viewMode === 'all' && allJobs.length > 1 ?
            parseInt($('#add-record-job-id').val()) :
            (selectedJobId || allJobs[0].id);

        var payerName = $('#add-record-payer-name').val().trim();
        var incomeType = $('#add-record-income-type').val().trim();
        var totalAmount = parseInt($('#add-record-total-amount').val()) || 0;
        var withholdingTax = parseInt($('#add-record-withholding-tax').val()) || 0;

        // é©—è­‰
        if (!payerName) {
            showNotification('è«‹è¼¸å…¥æ‰£ç¹³å–®ä½åç¨±', 'warning');
            return;
        }
        if (!incomeType) {
            showNotification('è«‹è¼¸å…¥æ‰€å¾—é¡åˆ¥', 'warning');
            return;
        }

        // æ–°å¢è¨˜éŒ„åˆ° currentTableData
        var newRecord = {
            jobId: jobId,
            itemName: itemName,
            payerName: payerName,
            incomeType: incomeType,
            totalAmount: totalAmount,
            withholdingTax: withholdingTax,
            index: null,
            isNew: true  // æ¨™è¨˜ç‚ºæ–°å¢çš„è¨˜éŒ„
        };

        currentTableData.push(newRecord);

        // é—œé–‰å°è©±æ¡†
        $('#addRecordModal').modal('hide');

        // é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼ˆæœƒè‡ªå‹•æŒ‰é …ç›®æ’åºï¼‰
        renderWithholdingTable();

        // é‡æ–°å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
        makeTableEditable();

        showNotification('å·²æ–°å¢è¨˜éŒ„', 'success');
    }

    // ============ ğŸ†• éŒ¯èª¤è™•ç†å‡½æ•¸ ============

    function showJobErrors() {
        /**
         * æª¢æŸ¥ä¸¦é¡¯ç¤ºå¤±æ•—çš„JobéŒ¯èª¤è¨Šæ¯
         */
        var failedJobs = allJobs.filter(function(job) {
            return job.status === 'FAILED';
        });

        if (failedJobs.length === 0) {
            $('#error-container').hide();
            return;
        }

        var errorHtml = '';
        failedJobs.forEach(function(job) {
            var errorInfo = parseErrorMessage(job.error_message);
            var errorDataId = 'error-data-' + job.id;
            
            errorHtml += 
                '<div class="alert alert-danger" style="margin-bottom: 15px;">' +
                '<h4><i class="fa fa-exclamation-triangle"></i> è™•ç†å¤±æ•—</h4>' +
                '<div class="row">' +
                '<div class="col-md-8">' +
                '<p><strong>æª”æ¡ˆï¼š</strong><span id="' + errorDataId + '-file">' + escapeHtml(errorInfo.file_name) + '</span></p>' +
                '<p><strong>éŒ¯èª¤é¡å‹ï¼š</strong><span id="' + errorDataId + '-type">' + escapeHtml(errorInfo.error_type) + '</span></p>' +
                '<p><strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong><span id="' + errorDataId + '-msg">' + escapeHtml(errorInfo.error_message) + '</span></p>' +
                '</div>' +
                '<div class="col-md-4 text-right">' +
                '<button class="btn btn-sm btn-info" onclick="copyErrorMessageById(' + job.id + ')">' +
                '<i class="fa fa-copy"></i> è¤‡è£½éŒ¯èª¤è¨Šæ¯' +
                '</button>' +
                '</div>' +
                '</div>' +
                // éš±è—çš„ data å®¹å™¨
                '<div id="' + errorDataId + '" style="display: none;" ' +
                'data-job-id="' + job.id + '" ' +
                'data-file-name="' + escapeHtml(errorInfo.file_name) + '" ' +
                'data-error-type="' + escapeHtml(errorInfo.error_type) + '" ' +
                'data-error-message="' + escapeHtml(errorInfo.error_message) + '">' +
                '</div>' +
                '</div>';
        });

        $('#error-container').html(errorHtml).show();
    }

    function escapeHtml(text) {
        /**
         * è½‰ç¾©HTMLç‰¹æ®Šå­—å…ƒï¼Œé˜²æ­¢XSSæ”»æ“Š
         */
        if (!text) return '';
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function parseErrorMessage(errorMessage) {
        /**
         * è§£æéŒ¯èª¤è¨Šæ¯ï¼Œæ”¯æ´æ–°èˆŠæ ¼å¼
         */
        try {
            // å˜—è©¦è§£ææ–°æ ¼å¼ï¼ˆJSONï¼‰
            var errorInfo = JSON.parse(errorMessage);
            return {
                file_name: errorInfo.file_name || 'Unknown',
                error_type: errorInfo.error_type || 'Unknown',
                error_message: errorInfo.error_message || errorMessage
            };
        } catch (e) {
            // èˆŠæ ¼å¼ï¼ˆç´”æ–‡å­—ï¼‰
            return {
                file_name: 'Unknown',
                error_type: 'ProcessingError',
                error_message: errorMessage || 'æœªçŸ¥éŒ¯èª¤'
            };
        }
    }

    function copyErrorMessageById(jobId) {
        /**
         * å¾dataå±¬æ€§è®€å–éŒ¯èª¤è¨Šæ¯ä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿
         */
        console.log('ğŸ” é–‹å§‹è¤‡è£½éŒ¯èª¤è¨Šæ¯ï¼ŒJob ID:', jobId);
        
        var errorDataId = 'error-data-' + jobId;
        var errorDataEl = document.getElementById(errorDataId);
        
        if (!errorDataEl) {
            console.error('âŒ æ‰¾ä¸åˆ°éŒ¯èª¤è³‡æ–™å…ƒç´ :', errorDataId);
            showNotification('ç„¡æ³•æ‰¾åˆ°éŒ¯èª¤è³‡æ–™', 'warning');
            return;
        }
        
        console.log('âœ… æ‰¾åˆ°éŒ¯èª¤è³‡æ–™å…ƒç´ ');
        
        var fileName = errorDataEl.getAttribute('data-file-name');
        var errorType = errorDataEl.getAttribute('data-error-type');
        var errorMessage = errorDataEl.getAttribute('data-error-message');
        
        console.log('ğŸ“‹ éŒ¯èª¤è³‡æ–™:', {
            fileName: fileName,
            errorType: errorType,
            errorMessage: errorMessage ? errorMessage.substring(0, 50) + '...' : null
        });
        
        var errorText = 'Tax-OCR éŒ¯èª¤å ±å‘Š\n' +
            'Job ID: ' + jobId + '\n' +
            'æª”æ¡ˆåç¨±: ' + fileName + '\n' +
            'éŒ¯èª¤é¡å‹: ' + errorType + '\n' +
            'éŒ¯èª¤è¨Šæ¯: ' + errorMessage + '\n' +
            'æ™‚é–“: ' + new Date().toLocaleString();

        console.log('ğŸ“ æº–å‚™è¤‡è£½çš„æ–‡å­—é•·åº¦:', errorText.length);

        // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            console.log('âœ… ä½¿ç”¨ Clipboard API');
            navigator.clipboard.writeText(errorText).then(function() {
                console.log('âœ… è¤‡è£½æˆåŠŸ');
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(function(err) {
                console.error('âŒ Clipboard API è¤‡è£½å¤±æ•—:', err);
                fallbackCopyTextToClipboard(errorText);
            });
        } else {
            // èˆŠç€è¦½å™¨çš„ fallback æ–¹æ³•
            console.log('âš ï¸ Clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ fallback æ–¹æ³•');
            fallbackCopyTextToClipboard(errorText);
        }
    }

    function copyErrorMessage(jobId, fileName, errorType, errorMessage) {
        /**
         * è¤‡è£½éŒ¯èª¤è¨Šæ¯åˆ°å‰ªè²¼ç°¿ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ä»¥ä¾¿ç›¸å®¹ï¼‰
         */
        var errorText = 'Tax-OCR éŒ¯èª¤å ±å‘Š\n' +
            'Job ID: ' + jobId + '\n' +
            'æª”æ¡ˆåç¨±: ' + fileName + '\n' +
            'éŒ¯èª¤é¡å‹: ' + errorType + '\n' +
            'éŒ¯èª¤è¨Šæ¯: ' + errorMessage + '\n' +
            'æ™‚é–“: ' + new Date().toLocaleString();

        // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(errorText).then(function() {
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(function(err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                fallbackCopyTextToClipboard(errorText);
            });
        } else {
            // èˆŠç€è¦½å™¨çš„ fallback æ–¹æ³•
            fallbackCopyTextToClipboard(errorText);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        /**
         * èˆŠç€è¦½å™¨çš„è¤‡è£½æ–¹æ³•
         */
        console.log('ğŸ”„ ä½¿ç”¨ fallback è¤‡è£½æ–¹æ³•');
        
        var textArea = document.createElement("textarea");
        textArea.value = text;
        
        // é¿å…åœ¨ iOS ä¸Šå‡ºç¾ç¸®æ”¾
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            var successful = document.execCommand('copy');
            console.log('ğŸ“‹ execCommand çµæœ:', successful);
            
            if (successful) {
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            } else {
                showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'warning');
            }
        } catch (err) {
            console.error('âŒ Fallback è¤‡è£½å¤±æ•—:', err);
            showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'warning');
        }

        document.body.removeChild(textArea);
    }

    // ğŸ†• è‡ªå‹•èª¿æ•´ textarea é«˜åº¦çš„å‡½æ•¸
    function autoResizeTextarea(textarea) {
        /**
         * æ ¹æ“šå…§å®¹è‡ªå‹•èª¿æ•´ textarea çš„é«˜åº¦
         */
        if (!textarea) return;
        
        // é‡ç½®é«˜åº¦ä»¥ç²å¾—æ­£ç¢ºçš„ scrollHeight
        textarea.style.height = 'auto';
        
        // è¨ˆç®—æ‰€éœ€é«˜åº¦ï¼ˆæœ€å°3è¡Œï¼Œæœ€å¤§10è¡Œï¼‰
        var minHeight = 3 * 20; // 3è¡Œ * è¡Œé«˜
        var maxHeight = 10 * 20; // 10è¡Œ * è¡Œé«˜
        var scrollHeight = textarea.scrollHeight;
        
        // è¨­å®šæ–°é«˜åº¦
        var newHeight = Math.max(minHeight, Math.min(maxHeight, scrollHeight));
        textarea.style.height = newHeight + 'px';
        
        // å¦‚æœå…§å®¹è¶…éæœ€å¤§é«˜åº¦ï¼Œé¡¯ç¤ºæ»¾å‹•æ¢
        if (scrollHeight > maxHeight) {
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.overflowY = 'hidden';
        }
    }

    // ğŸ†• è¨ˆç®—ç¨…ç‡çš„å‡½æ•¸
    function calculateTaxRate(totalAmount, withholdingTax) {
        /**
         * è¨ˆç®—ç¨…ç‡ï¼šæ‰£ç¹³ç¨…é¡ / å„é¡çµ¦ä»˜ç¸½é¡ * 100%
         * @param {number} totalAmount - å„é¡çµ¦ä»˜ç¸½é¡æˆ–å„é¡æ”¶ç›Šç¸½é¡
         * @param {number} withholdingTax - æ‰£ç¹³ç¨…é¡
         * @returns {string} - æ ¼å¼åŒ–çš„ç¨…ç‡å­—ä¸²ï¼ˆä¾‹å¦‚ï¼š"10.00%"ï¼‰
         */
        if (!totalAmount || totalAmount === 0) {
            return '-';
        }
        
        var rate = (withholdingTax / totalAmount) * 100;
        return rate.toFixed(2) + '%';
    }
</script>

<!-- é™¤éŒ¯å·¥å…·ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰ -->
<script src="{{ url_for('static', filename='/js/debug_helper.js') }}"></script>
{% endblock %}