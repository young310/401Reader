{% extends "base.html" %}

{% block title %}è³‡æ–™åº« - ç¨…å‹™è³‡æ–™è‡ªå‹•åŒ–å¹³å°{% endblock %}

{% block content %}
<div class="page-header-section">
    <h1>è³‡æ–™åº«ç®¡ç†</h1>
    <p>é¸æ“‡æª”æ¡ˆå‰å¾€AIè¾¨è­˜æ ¡å°é é¢é€²è¡Œè³‡æ–™æ ¡å°</p>
</div>

<!-- Warning Alert -->
<div class="alert alert-warning" id="type-mismatch-alert" style="display: none;">
    <i class="fa fa-exclamation-triangle"></i> åªèƒ½é¸æ“‡è¾¨è­˜å®Œæˆä¸”ç›¸åŒé¡å‹çš„æª”æ¡ˆï¼š401/403 ç‚ºä¸€çµ„ï¼Œæ‰£ç¹³æ†‘å–®/æ‰£ç¹³æ†‘å–®ç”³å ±æ›¸ç‚ºä¸€çµ„
</div>

<!-- Case Info -->
<div id="case-info-container">
    <!-- Will be loaded by JavaScript -->
</div>

<!-- Table Card -->
<div class="card">
    <div class="card-header">
        <div class="clearfix">
            <div class="pull-left">
                <h3>å·²ä¸Šå‚³æª”æ¡ˆ</h3>
                <small class="text-muted">ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨ã€Œæª”æ¡ˆé¡å‹ã€ç¯©é¸å™¨é¸æ“‡é¡å‹ï¼Œå†é»æ“Šå·¦ä¸Šè§’è¤‡é¸æ¡†ä¸€éµå…¨é¸</small>
            </div>
            <div class="pull-right">
                <span class="badge badge-info" id="selected-count" style="display: none; margin-right: 10px;">å·²é¸æ“‡ 0
                    å€‹æª”æ¡ˆ</span>
                <button class="btn btn-danger btn-sm" id="batch-delete-btn" style="display: none;">
                    <i class="fa fa-trash"></i> æ‰¹æ¬¡åˆªé™¤
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th class="text-center" style="width: 50px;">
                            <input type="checkbox" id="select-all">
                        </th>
                        <th class="text-center" style="max-width: 250px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>æª”æ¡ˆåç¨±</span>
                                <button class="btn btn-xs btn-primary" id="sort-filename-btn" title="é»æ“Šåˆ‡æ›æ’åº">
                                    <i class="fa fa-sort-alpha-asc"></i>
                                </button>
                            </div>
                        </th>
                        <th class="text-center" style="min-width: 280px; max-width: 320px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>æª”æ¡ˆé¡å‹</span>
                                <select class="form-control input-sm" id="filter-type" style="width: 140px;">
                                    <option value="all">å…¨éƒ¨é¡å‹</option>
                                    <option value="401">401 ç”³å ±æ›¸</option>
                                    <option value="403">403 ç”³å ±æ›¸</option>
                                    <option value="withholding-slip-æ”¯å‡º">å°å¼µ - æ”¯å‡º</option>
                                    <option value="withholding-slip-æ”¶å…¥">å°å¼µ - æ”¶å…¥</option>
                                    <option value="withholding-statement-æ”¯å‡º">å¤§å¼µ - æ”¯å‡º</option>
                                    <option value="withholding-statement-æ”¶å…¥">å¤§å¼µ - æ”¶å…¥</option>
                                    <option value="dividend-slip-æ”¯å‡º">è‚¡åˆ©æ†‘å–® - æ”¯å‡º</option>
                                    <option value="dividend-slip-æ”¶å…¥">è‚¡åˆ©æ†‘å–® - æ”¶å…¥</option>
                                    <option value="all-income">æ‰€æœ‰æ”¶å…¥</option>
                                    <option value="all-expense">æ‰€æœ‰æ”¯å‡º</option>
                                </select>
                            </div>
                        </th>
                        <th class="text-center" style="min-width: 140px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>ä¸Šå‚³æ™‚é–“</span>
                                <button class="btn btn-xs btn-primary" id="sort-time-btn" title="é»æ“Šåˆ‡æ›æ’åº">
                                    <i class="fa fa-sort-amount-desc"></i>
                                </button>
                            </div>
                        </th>
                        <th class="text-center" style="min-width: 140px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>ç‹€æ…‹</span>
                                <select class="form-control input-sm" id="filter-status" style="width: 100px;">
                                    <option value="all">å…¨éƒ¨</option>
                                    <option value="completed">è¾¨è­˜å®Œæˆ</option>
                                    <option value="error">è¾¨è­˜å¤±æ•—</option>
                                    <option value="processing">è¾¨è­˜ä¸­</option>
                                    <option value="pending">å¾…è¾¨è­˜</option>
                                </select>
                            </div>
                        </th>
                        <th class="text-center" style="width: 100px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="documents-table">
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
/* ç¾åŒ–æ“ä½œæŒ‰éˆ• */
.btn-group-xs .btn {
    transition: all 0.2s ease;
}

.btn-group-xs .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.btn-group-xs .btn:active {
    transform: translateY(0);
}

.btn-group-xs .btn-info {
    background-color: #5bc0de;
    border-color: #46b8da;
}

.btn-group-xs .btn-info:hover {
    background-color: #31b0d5;
    border-color: #269abc;
}

.btn-group-xs .btn-danger {
    background-color: #d9534f;
    border-color: #d43f3a;
}

.btn-group-xs .btn-danger:hover {
    background-color: #c9302c;
    border-color: #ac2925;
}

/* ç¢ºä¿æŒ‰éˆ•çµ„ç·Šå¯†æ’åˆ— */
.btn-group-xs {
    display: inline-flex;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    border-radius: 3px;
}

.btn-group-xs .btn {
    margin: 0 !important;
    border-left-width: 0;
}

.btn-group-xs .btn:first-child {
    border-left-width: 1px;
}

/* æ”¶æ”¯æ–¹å‘ç·¨è¼¯æŒ‰éˆ• */
.stream-edit-btn {
    transition: all 0.2s ease;
    background-color: #f5f5f5;
    border-color: #ddd;
    color: #666;
    white-space: nowrap;
}

.stream-edit-btn:hover {
    background-color: #e0e0e0;
    border-color: #ccc;
    color: #333;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.stream-edit-btn:active {
    transform: translateY(0);
}

/* æª”æ¡ˆåç¨±æ¬„ä½ - æ–‡å­—æˆªæ–· */
.table tbody td {
    vertical-align: middle !important;
}

/* æª”æ¡ˆé¡å‹æ¬„ä½ - ç¢ºä¿ä¸æ›è¡Œ */
.badge {
    white-space: nowrap;
    display: inline-block;
}

/* æª”æ¡ˆåç¨± hover æ•ˆæœ */
.table tbody td[title]:hover {
    background-color: #f9f9f9;
}

/* æª”æ¡ˆåç¨±é€£çµå’Œæ–‡å­—çš„ hover æ•ˆæœ */
.table tbody td a[title],
.table tbody td span[title] {
    cursor: pointer;
}

/* ç§»é™¤ç¦ç”¨æŒ‰éˆ•çš„ç¦æ­¢ç¬¦è™Ÿ */
#goto-verification-btn:disabled {
    cursor: default !important;
}

/* éŒ¯èª¤è¨Šæ¯è¡Œæ¨£å¼ - è‡ªå‹•æ›è¡Œ */
.error-row td {
    word-wrap: break-word;
    word-break: break-all;
    white-space: normal !important;
}

.error-row .error-message-text {
    display: block;
    max-width: 100%;
    word-wrap: break-word;
    word-break: break-word;
    white-space: pre-wrap;
    overflow-wrap: break-word;
}

/* é™åˆ¶è¡¨æ ¼æ¬„ä½ä¸è¢«éŒ¯èª¤è¨Šæ¯æ’é–‹ */
.table {
    table-layout: fixed;
    width: 100%;
}

.table tbody td:nth-child(2) {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
}
</style>

<!-- Navigation -->
<div class="clearfix" style="margin-top: 30px;">
    <div class="pull-left">
        <button class="btn btn-default" id="back-btn">
            <i class="fa fa-arrow-left"></i> è¿”å›æ†‘è­‰ä¸Šå‚³
        </button>
    </div>
    <div class="pull-right">
        <button class="btn btn-primary" id="goto-verification-btn" disabled title="è¦å‹¾é¸æª”æ¡ˆå¾Œæ‰å¯ä»¥å‰å¾€æ ¡å°é é¢">
            å‰å¾€æ ¡å°é é¢ <i class="fa fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- Edit History Modal -->
<div class="modal fade" id="editHistoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">
                    <i class="fa fa-history"></i> ç·¨è¼¯è»Œè·¡
                </h4>
            </div>
            <div class="modal-body">
                <div id="history-loading" class="text-center" style="padding: 40px;">
                    <i class="fa fa-spinner fa-spin fa-3x"></i>
                    <p class="text-muted" style="margin-top: 15px;">è¼‰å…¥ä¸­...</p>
                </div>
                <div id="history-content" style="display: none;">
                    <div class="alert alert-info">
                        <strong>æª”æ¡ˆåç¨±ï¼š</strong> <span id="history-filename"></span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 180px;">ç·¨è¼¯æ™‚é–“</th>
                                    <th class="text-center" style="width: 120px;">ç·¨è¼¯äººå“¡</th>
                                    <th>æ“ä½œèªªæ˜</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="history-empty" style="display: none; text-center; padding: 40px;">
                    <i class="fa fa-info-circle fa-3x text-muted"></i>
                    <p class="text-muted" style="margin-top: 15px;">æ­¤æª”æ¡ˆå°šç„¡ç·¨è¼¯è¨˜éŒ„</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // API Base URL
    // API Base URL - FastAPI å¾Œç«¯æœå‹™
    var API_BASE_URL = '/api';

    var currentCase = null;
    var caseId = null;
    var documents = [];
    var allJobs = [];  // å„²å­˜å®Œæ•´çš„ Job è³‡æ–™
    var selectedDocs = [];
    var sortOrder = 'desc'; // 'desc' = æœ€æ–°åœ¨ä¸Š (é è¨­), 'asc' = æœ€èˆŠåœ¨ä¸Š
    var filenameSortOrder = 'asc'; // 'asc' = A-Z (é è¨­), 'desc' = Z-A
    var currentSortBy = 'time'; // 'time' = æŒ‰æ™‚é–“æ’åº (é è¨­), 'filename' = æŒ‰æª”æ¡ˆåç¨±æ’åº

    // ç°¡åŒ–çš„æ–‡ä»¶é¡å‹æ¨™ç±¤ï¼ˆèˆ‡ä¸Šå‚³é é¢ä¸€è‡´ï¼‰
    var docTypeLabels = {
        '401': 'ç‡Ÿæ¥­äººéŠ·å”®é¡èˆ‡ç¨…é¡ç”³å ±æ›¸(401)',
        '403': 'ç‡Ÿæ¥­äººéŠ·å”®é¡èˆ‡ç¨…é¡ç”³å ±æ›¸(403)',
        'withholding-slip': 'å„é¡æ‰€å¾—æ‰£ç¹³æš¨å…æ‰£ç¹³æ†‘å–®(å°å¼µ)',
        'withholding-statement': 'å„é¡æ‰€å¾—æ‰£ç¹³æš¨å…æ‰£ç¹³æ†‘å–®ç”³å ±æ›¸(å¤§å¼µ)',
        'dividend-slip': 'è‚¡åˆ©æ†‘å–®'
    };

    // æ”¶å…¥/æ”¯å‡ºæ¨™ç±¤ï¼ˆé¡¯ç¤ºåœ¨ detected_streamï¼‰
    var streamLabels = {
        'æ”¯å‡º': 'â€”æ”¯å‡º',
        'æ”¶å…¥': 'â€”æ”¶å…¥'
    };

    $(document).ready(function () {
        // å¾ URL åƒæ•¸æˆ– localStorage è®€å– case_id
        var urlParams = new URLSearchParams(window.location.search);
        caseId = urlParams.get('case_id');

        if (!caseId) {
            var storedCase = localStorage.getItem('selectedCase');
            if (storedCase) {
                currentCase = JSON.parse(storedCase);
                caseId = currentCase.id;
            }
        }

        if (caseId) {
            loadCaseInfo();
            loadCaseJobs();

            // è¨­ç½®æŒ‰éˆ•
            $('#back-btn').click(function () {
                window.location.href = '/upload?case_id=' + caseId;
            });
        } else {
            // æ²’æœ‰æ¡ˆä»¶ ID æ™‚ï¼Œå¼·åˆ¶é‡å°å‘åˆ°æ¡ˆä»¶ç¸½è¦½
            showNotification('è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä»¶', 'warning');
            setTimeout(function () {
                window.location.href = '/dashboard';
            }, 1500);
            return;
        }

        // Filters
        $('#filter-type, #filter-status').change(function () {
            renderDocuments();
            // ğŸ†• filterè®Šæ›´æ™‚æ›´æ–°å…¨é¸æŒ‰éˆ•ç‹€æ…‹
            updateSelectAllButtonState();
        });

        // Sort by upload time
        $('#sort-time-btn').click(function() {
            currentSortBy = 'time';
            toggleSortOrder();
            renderDocuments();
        });

        // Sort by filename
        $('#sort-filename-btn').click(function() {
            currentSortBy = 'filename';
            toggleFilenameSortOrder();
            renderDocuments();
        });

        // åˆå§‹åŒ–æ’åºæŒ‰éˆ•ç‹€æ…‹
        $('#sort-time-btn').attr('title', 'ç›®å‰ï¼šæœ€æ–°åœ¨ä¸Šï¼Œé»æ“Šåˆ‡æ›ç‚ºæœ€èˆŠåœ¨ä¸Š');
        $('#sort-filename-btn').attr('title', 'ç›®å‰ï¼šA-Zæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºZ-Aæ’åº');

        // Select all
        $('#select-all').change(function () {
            var checked = $(this).prop('checked');
            if (checked) {
                smartSelectAll();
            } else {
                selectedDocs = [];
            }
            updateSelectionUI();
            renderDocuments();
        });

        // å‰å¾€æ ¡å°é é¢
        $('#goto-verification-btn').click(function () {
            if (selectedDocs.length === 0) {
                alert('è¦å‹¾é¸æª”æ¡ˆå¾Œæ‰å¯ä»¥å‰å¾€æ ¡å°é é¢');
                return;
            }
            goToVerification();
        });

        // Batch delete
        $('#batch-delete-btn').click(function () {
            batchDeleteJobs();
        });

        // åˆä½µ Excel (æš«æ™‚ä½¿ç”¨å‰å¾€æ ¡å°é é¢çš„é‚è¼¯)
        $('#merge-export-btn').click(function () {
            if (selectedDocs.length === 0) {
                showNotification('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æª”æ¡ˆ', 'warning');
                return;
            }
            goToVerification();
        });
    });

    // åˆ‡æ›æ’åºé †åº
    function toggleSortOrder() {
        if (sortOrder === 'desc') {
            sortOrder = 'asc';
            $('#sort-time-btn i').removeClass('fa-sort-amount-desc').addClass('fa-sort-amount-asc');
            $('#sort-time-btn').removeClass('btn-primary').addClass('btn-warning');
            $('#sort-time-btn').attr('title', 'ç›®å‰ï¼šæœ€èˆŠåœ¨ä¸Šï¼Œé»æ“Šåˆ‡æ›ç‚ºæœ€æ–°åœ¨ä¸Š');
        } else {
            sortOrder = 'desc';
            $('#sort-time-btn i').removeClass('fa-sort-amount-asc').addClass('fa-sort-amount-desc');
            $('#sort-time-btn').removeClass('btn-warning').addClass('btn-primary');
            $('#sort-time-btn').attr('title', 'ç›®å‰ï¼šæœ€æ–°åœ¨ä¸Šï¼Œé»æ“Šåˆ‡æ›ç‚ºæœ€èˆŠåœ¨ä¸Š');
        }
        console.log('æ™‚é–“æ’åºé †åºå·²åˆ‡æ›ç‚º:', sortOrder);
        
        // é‡ç½®æª”æ¡ˆåç¨±æ’åºæŒ‰éˆ•ç‹€æ…‹
        resetFilenameSortButton();
    }

    // åˆ‡æ›æª”æ¡ˆåç¨±æ’åºé †åº
    function toggleFilenameSortOrder() {
        if (filenameSortOrder === 'asc') {
            filenameSortOrder = 'desc';
            $('#sort-filename-btn i').removeClass('fa-sort-alpha-asc').addClass('fa-sort-alpha-desc');
            $('#sort-filename-btn').removeClass('btn-primary').addClass('btn-warning');
            $('#sort-filename-btn').attr('title', 'ç›®å‰ï¼šZ-Aæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºA-Zæ’åº');
        } else {
            filenameSortOrder = 'asc';
            $('#sort-filename-btn i').removeClass('fa-sort-alpha-desc').addClass('fa-sort-alpha-asc');
            $('#sort-filename-btn').removeClass('btn-warning').addClass('btn-primary');
            $('#sort-filename-btn').attr('title', 'ç›®å‰ï¼šA-Zæ’åºï¼Œé»æ“Šåˆ‡æ›ç‚ºZ-Aæ’åº');
        }
        console.log('æª”æ¡ˆåç¨±æ’åºé †åºå·²åˆ‡æ›ç‚º:', filenameSortOrder);
        
        // é‡ç½®æ™‚é–“æ’åºæŒ‰éˆ•ç‹€æ…‹
        resetTimeSortButton();
    }

    // é‡ç½®æ™‚é–“æ’åºæŒ‰éˆ•ç‹€æ…‹
    function resetTimeSortButton() {
        $('#sort-time-btn i').removeClass('fa-sort-amount-asc fa-sort-amount-desc').addClass('fa-sort-amount-desc');
        $('#sort-time-btn').removeClass('btn-warning').addClass('btn-primary');
        $('#sort-time-btn').attr('title', 'é»æ“ŠæŒ‰æ™‚é–“æ’åº');
    }

    // é‡ç½®æª”æ¡ˆåç¨±æ’åºæŒ‰éˆ•ç‹€æ…‹
    function resetFilenameSortButton() {
        $('#sort-filename-btn i').removeClass('fa-sort-alpha-desc fa-sort-alpha-asc').addClass('fa-sort-alpha-asc');
        $('#sort-filename-btn').removeClass('btn-warning').addClass('btn-primary');
        $('#sort-filename-btn').attr('title', 'é»æ“ŠæŒ‰æª”æ¡ˆåç¨±æ’åº');
    }

    // æŒ‰ä¸Šå‚³æ™‚é–“æ’åºæ–‡ä»¶
    function sortDocumentsByTime(docs) {
        console.log('é–‹å§‹æ’åºï¼Œç•¶å‰é †åº:', sortOrder, 'æ–‡ä»¶æ•¸é‡:', docs.length);
        
        if (docs.length === 0) return docs;
        
        var sorted = docs.sort(function(a, b) {
            // ä½¿ç”¨åŸå§‹çš„ createdAt æ™‚é–“æˆ³é€²è¡Œæ’åº
            var timeA = a.createdAt ? new Date(a.createdAt) : new Date(0);
            var timeB = b.createdAt ? new Date(b.createdAt) : new Date(0);
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
            if (isNaN(timeA.getTime())) timeA = new Date(0);
            if (isNaN(timeB.getTime())) timeB = new Date(0);
            
            if (sortOrder === 'desc') {
                // æœ€æ–°åœ¨ä¸Šï¼šæ™‚é–“å¤§çš„åœ¨å‰
                return timeB - timeA;
            } else {
                // æœ€èˆŠåœ¨ä¸Šï¼šæ™‚é–“å°çš„åœ¨å‰
                return timeA - timeB;
            }
        });
        
        console.log('æ’åºå®Œæˆï¼Œç¬¬ä¸€å€‹æ–‡ä»¶:', {
            name: sorted[0]?.name,
            uploadedAt: sorted[0]?.uploadedAt,
            createdAt: sorted[0]?.createdAt
        });
        console.log('æœ€å¾Œä¸€å€‹æ–‡ä»¶:', {
            name: sorted[sorted.length-1]?.name,
            uploadedAt: sorted[sorted.length-1]?.uploadedAt,
            createdAt: sorted[sorted.length-1]?.createdAt
        });
        return sorted;
    }

    // æŒ‰æª”æ¡ˆåç¨±æ’åºæ–‡ä»¶
    function sortDocumentsByFilename(docs) {
        console.log('é–‹å§‹æŒ‰æª”æ¡ˆåç¨±æ’åºï¼Œç•¶å‰é †åº:', filenameSortOrder, 'æ–‡ä»¶æ•¸é‡:', docs.length);
        
        if (docs.length === 0) return docs;
        
        var sorted = docs.sort(function(a, b) {
            var nameA = (a.name || '').toLowerCase();
            var nameB = (b.name || '').toLowerCase();
            
            if (filenameSortOrder === 'asc') {
                // A-Zæ’åº
                return nameA.localeCompare(nameB, 'zh-TW', { numeric: true, sensitivity: 'base' });
            } else {
                // Z-Aæ’åº
                return nameB.localeCompare(nameA, 'zh-TW', { numeric: true, sensitivity: 'base' });
            }
        });
        
        console.log('æª”æ¡ˆåç¨±æ’åºå®Œæˆï¼Œç¬¬ä¸€å€‹æ–‡ä»¶:', sorted[0]?.name);
        console.log('æœ€å¾Œä¸€å€‹æ–‡ä»¶:', sorted[sorted.length-1]?.name);
        return sorted;
    }

    // çµ±ä¸€çš„æ’åºå‡½æ•¸
    function sortDocuments(docs) {
        if (currentSortBy === 'filename') {
            return sortDocumentsByFilename(docs);
        } else {
            return sortDocumentsByTime(docs);
        }
    }

    // å–å¾—å·²å®Œæˆæª”æ¡ˆçš„å”¯ä¸€é¡å‹åˆ—è¡¨
    function getUniqueCompletedTypes(completedDocs) {
        var typeMap = {};

        completedDocs.forEach(function(doc) {
            var typeKey;
            if (doc.type === '401' || doc.type === '403') {
                // 401/403 åªçœ‹ document_type
                typeKey = doc.type;
                typeMap[typeKey] = { type: doc.type, stream: null };
            } else {
                // æ‰£ç¹³æ†‘å–®é¡å‹éœ€è¦çœ‹ type + stream çµ„åˆ
                typeKey = doc.type + '-' + (doc.detected_stream || '');
                typeMap[typeKey] = { type: doc.type, stream: doc.detected_stream };
            }
        });

        return Object.values(typeMap);
    }

    // æ™ºèƒ½å…¨é¸åŠŸèƒ½
    function smartSelectAll() {
        var filteredDocs = getFilteredDocs();
        var completedDocs = filteredDocs.filter(function(d) {
            var statusUpper = (d.status || '').toUpperCase();
            return statusUpper === 'COMPLETED';
        });
        
        if (completedDocs.length === 0) {
            showNotification('æ²’æœ‰å·²å®Œæˆçš„æª”æ¡ˆå¯ä»¥é¸æ“‡', 'warning');
            return;
        }
        
        var targetType = null;
        var targetStream = null;
        
        // ğŸ†• å„ªå…ˆæª¢æŸ¥filteræ˜¯å¦æœ‰é¸æ“‡ç‰¹å®šé¡å‹
        var filterValue = $('#filter-type').val();
        
        if (filterValue && filterValue !== 'all') {
            // å¾filterç²å–é¡å‹å’Œæ”¶æ”¯æ–¹å‘
            if (filterValue === '401' || filterValue === '403') {
                targetType = filterValue;
                targetStream = null;
            } else if (filterValue === 'all-income') {
                // æ‰€æœ‰æ”¶å…¥é¡å‹
                targetType = 'all-income';
                targetStream = 'æ”¶å…¥';
            } else if (filterValue === 'all-expense') {
                // æ‰€æœ‰æ”¯å‡ºé¡å‹
                targetType = 'all-expense';
                targetStream = 'æ”¯å‡º';
            } else {
                // æ ¼å¼ï¼šwithholding-slip-æ”¯å‡º
                var parts = filterValue.split('-');
                if (parts.length >= 2) {
                    targetStream = parts[parts.length - 1]; // æœ€å¾Œä¸€éƒ¨åˆ†æ˜¯æ”¶æ”¯æ–¹å‘
                    targetType = parts.slice(0, -1).join('-'); // å‰é¢éƒ¨åˆ†æ˜¯é¡å‹
                }
            }
            console.log('å¾filterå…¨é¸ï¼Œé¡å‹:', targetType, 'æ”¶æ”¯:', targetStream);
        } else if (selectedDocs.length > 0) {
            // å¦‚æœfilteræ²’æœ‰é¸æ“‡ï¼Œä½†å·²ç¶“æœ‰é¸æ“‡çš„æª”æ¡ˆï¼Œæ ¹æ“šç¬¬ä¸€å€‹é¸æ“‡çš„æª”æ¡ˆæ±ºå®šé¡å‹
            var firstSelectedJob = allJobs.find(function(j) { return j.id === selectedDocs[0]; });
            if (firstSelectedJob) {
                targetType = firstSelectedJob.document_type;
                targetStream = firstSelectedJob.detected_stream;
                console.log('æ ¹æ“šå·²é¸æª”æ¡ˆå…¨é¸ï¼Œé¡å‹:', targetType, 'æ”¶æ”¯:', targetStream);
            }
        } else {
            // æ²’æœ‰filteré¸æ“‡ï¼Œä¹Ÿæ²’æœ‰é¸æ“‡æª”æ¡ˆï¼Œæª¢æŸ¥æ˜¯å¦æ‰€æœ‰å·²å®Œæˆæª”æ¡ˆéƒ½æ˜¯åŒä¸€é¡å‹
            var uniqueTypes = getUniqueCompletedTypes(completedDocs);

            if (uniqueTypes.length === 1) {
                // åªæœ‰ä¸€ç¨®é¡å‹ï¼Œç›´æ¥ä½¿ç”¨è©²é¡å‹
                targetType = uniqueTypes[0].type;
                targetStream = uniqueTypes[0].stream;
                console.log('è³‡æ–™åº«åªæœ‰ä¸€ç¨®é¡å‹ï¼Œè‡ªå‹•å…¨é¸ï¼Œé¡å‹:', targetType, 'æ”¶æ”¯:', targetStream);
            } else if (uniqueTypes.length > 1) {
                // æœ‰å¤šç¨®é¡å‹ï¼Œæç¤ºä½¿ç”¨è€…
                showNotification('è³‡æ–™åº«ä¸­æœ‰å¤šç¨®æª”æ¡ˆé¡å‹ï¼Œè«‹å…ˆä½¿ç”¨ç¯©é¸å™¨é¸æ“‡æª”æ¡ˆé¡å‹', 'info');
                return;
            } else {
                // æ²’æœ‰å·²å®Œæˆçš„æª”æ¡ˆ
                showNotification('æ²’æœ‰å·²å®Œæˆçš„æª”æ¡ˆå¯ä»¥é¸æ“‡', 'warning');
                return;
            }
        }
        
        // æ ¹æ“šç›®æ¨™é¡å‹ç¯©é¸å¯é¸æª”æ¡ˆ
        var selectableDocs = completedDocs.filter(function(doc) {
            if (targetType === '401' || targetType === '403') {
                // 401/403 åªé¸åŒé¡å‹
                return doc.type === targetType;
            } else if (targetType === 'all-income') {
                // æ‰€æœ‰æ”¶å…¥é¡å‹
                return (doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
                       doc.detected_stream === 'æ”¶å…¥';
            } else if (targetType === 'all-expense') {
                // æ‰€æœ‰æ”¯å‡ºé¡å‹
                return (doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
                       doc.detected_stream === 'æ”¯å‡º';
            } else {
                // æ‰£ç¹³æ†‘å–®ï¼ˆåŒ…æ‹¬è‚¡åˆ©æ†‘å–®ï¼‰éœ€è¦åŒé¡å‹ä¸”åŒæ”¶æ”¯æ–¹å‘
                return doc.type === targetType && doc.detected_stream === targetStream;
            }
        });
        
        if (selectableDocs.length === 0) {
            var typeLabel = targetType === '401' ? '401 ç”³å ±æ›¸' :
                           targetType === '403' ? '403 ç”³å ±æ›¸' :
                           targetType === 'all-income' ? 'æ‰€æœ‰æ”¶å…¥' :
                           targetType === 'all-expense' ? 'æ‰€æœ‰æ”¯å‡º' :
                           docTypeLabels[targetType] + '(' + targetStream + ')';
            showNotification('æ²’æœ‰å¯é¸æ“‡çš„ ' + typeLabel + ' æª”æ¡ˆ', 'warning');
            return;
        }
        
        // æ›´æ–°é¸æ“‡åˆ—è¡¨
        selectedDocs = selectableDocs.map(function(d) { return d.id; });
        
        var typeLabel = targetType === '401' ? '401 ç”³å ±æ›¸' :
                       targetType === '403' ? '403 ç”³å ±æ›¸' :
                       targetType === 'all-income' ? 'æ‰€æœ‰æ”¶å…¥' :
                       targetType === 'all-expense' ? 'æ‰€æœ‰æ”¯å‡º' :
                       docTypeLabels[targetType] + '(' + targetStream + ')';
        showNotification('å·²å…¨é¸ ' + selectableDocs.length + ' å€‹ ' + typeLabel + ' æª”æ¡ˆ', 'success');
        
        // ğŸ†• æ›´æ–°UI
        renderDocuments();
        updateSelectAllButtonState();
    }

    // æª”æ¡ˆé¸æ“‡è¦å‰‡ (ä½¿ç”¨ document_type)
    function isJobSelectable(job) {
        // è¦å‰‡ 0: æœªå®Œæˆçš„æª”æ¡ˆä¸å¯é¸ï¼ˆæ”¯æ´å¤§å°å¯«ï¼‰
        var statusUpper = (job.status || '').toUpperCase();
        if (statusUpper !== 'COMPLETED') return false;

        // è¦å‰‡ 1: ç¬¬ä¸€å€‹å‹¾é¸çš„æª”æ¡ˆï¼Œä»»ä½•å®Œæˆçš„æª”æ¡ˆéƒ½å¯é¸
        if (selectedDocs.length === 0) return true;

        // å–å¾—ç¬¬ä¸€å€‹å·²é¸æ“‡çš„æª”æ¡ˆ
        var firstSelectedJob = allJobs.find(function (j) { return j.id === selectedDocs[0]; });
        if (!firstSelectedJob) return true;

        // è¦å‰‡ 2: 401 åªèƒ½å’Œ 401 ä¸€èµ·é¸
        if (firstSelectedJob.document_type === "401") {
            return job.document_type === "401";
        }

        // è¦å‰‡ 3: 403 åªèƒ½å’Œ 403 ä¸€èµ·é¸
        if (firstSelectedJob.document_type === "403") {
            return job.document_type === "403";
        }

        // è¦å‰‡ 4: å¦‚æœç¬¬ä¸€å€‹æ˜¯ 401/403ï¼Œå…¶ä»–é 401/403 çš„æª”æ¡ˆä¸å¯é¸
        if (job.document_type === "401" || job.document_type === "403") {
            return false;
        }

        // è¦å‰‡ 5: å°å¼µ/å¤§å¼µ/è‚¡åˆ©æ†‘å–®åªèƒ½å’Œç›¸åŒ detected_stream çš„ä¸€èµ·é¸
        // (withholding-slipã€withholding-statement å’Œ dividend-slip å¯ä»¥æ··é¸ï¼Œä½†å¿…é ˆæ˜¯ç›¸åŒçš„ stream)
        return firstSelectedJob.detected_stream === job.detected_stream;
    }

    // è¼‰å…¥æ¡ˆä»¶è³‡è¨Š
    function loadCaseInfo() {
        if (currentCase) {
            showCaseInfo(currentCase);
            return;
        }

        $.ajax({
            url: API_BASE_URL + '/cases/' + caseId,
            method: 'GET',
            success: function (caseData) {
                currentCase = caseData;
                localStorage.setItem('selectedCase', JSON.stringify(caseData));
                showCaseInfo(caseData);
                // æ›´æ–°å°èˆªé€£çµ
                if (window.updateCurrentCase) {
                    window.updateCurrentCase(caseData);
                }
            },
            error: function (xhr, status, error) {
                console.error('è¼‰å…¥æ¡ˆä»¶å¤±æ•—:', error);
                showCaseWarning();
            }
        });
    }

    function showCaseInfo(caseData) {
        var html = '<div class="alert alert-info">' +
            '<div class="row">' +
            '<div class="col-md-4"><strong>ç•¶å‰æ¡ˆä»¶ï¼š</strong> ' + caseData.client_name + '</div>' +
            '<div class="col-md-4"><strong>å¹´åº¦ï¼š</strong> ' + caseData.year + '</div>' +
            '<div class="col-md-4"><strong>çµ±ç·¨ï¼š</strong> ' + caseData.tax_id + '</div>' +
            '</div></div>';
        $('#case-info-container').html(html);
    }

    function showCaseWarning() {
        var html = '<div class="alert alert-warning">' +
            '<i class="fa fa-exclamation-triangle"></i> è«‹å…ˆå¾æ¡ˆä»¶ç¸½è¦½é¸æ“‡ä¸€å€‹æ¡ˆä»¶' +
            '</div>';
        $('#case-info-container').html(html);
    }



    // è¼‰å…¥æ¡ˆä»¶çš„æ‰€æœ‰ Jobs
    function loadCaseJobs() {
        showLoading();
        $.ajax({
            url: API_BASE_URL + '/cases/' + caseId + '/jobs',
            method: 'GET',
            success: function (jobs) {
                hideLoading();
                allJobs = jobs;
                documents = jobs.map(function (job) {
                    return {
                        id: job.id,
                        name: job.original_filename,
                        type: job.document_type || 'UNKNOWN',
                        status: job.status,
                        uploadedAt: formatDate(job.created_at),
                        createdAt: job.created_at, // ä¿ç•™åŸå§‹æ™‚é–“æˆ³ç”¨æ–¼æ’åº
                        detected_stream: job.detected_stream
                    };
                });



                renderDocuments();

                // ğŸ†• è¼‰å…¥å®Œæˆå¾Œï¼Œå•Ÿå‹•ç‹€æ…‹è¼ªè©¢
                startStatusPolling();
            },
            error: function (xhr, status, error) {
                hideLoading();
                console.error('è¼‰å…¥æª”æ¡ˆåˆ—è¡¨å¤±æ•—:', error);
                showNotification('è¼‰å…¥æª”æ¡ˆåˆ—è¡¨å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'danger');
            }
        });
    }

    // å‰å¾€æ ¡å°é é¢
    function goToVerification() {
        var jobIds = selectedDocs.join(',');
        window.location.href = '/verification?jobIds=' + jobIds;
    }

    // æ‰¹é‡åˆªé™¤ Jobs
    function batchDeleteJobs(force) {
        if (!force) {
            // ç¬¬ä¸€æ¬¡å‘¼å«ï¼Œå…ˆé¡¯ç¤ºç¢ºèªæç¤º
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é¸æ“‡çš„ ' + selectedDocs.length + ' å€‹æª”æ¡ˆå—ï¼Ÿ')) {
                return;
            }
            
            showLoading();
            $.ajax({
                url: API_BASE_URL + '/jobs/batch-delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    job_ids: selectedDocs,
                    force: false
                }),
                success: function (response) {
                    hideLoading();
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰è­¦å‘Šï¼ˆéƒ¨åˆ†æª”æ¡ˆè¢«ç‰ˆæœ¬ä½¿ç”¨ï¼‰
                    if (response.warning && response.blocked_jobs) {
                        var blockedCount = Object.keys(response.blocked_jobs).length;
                        var warningMsg = 'å…¶ä¸­ ' + blockedCount + ' å€‹æª”æ¡ˆå·²å»ºç«‹éç‰ˆæœ¬ï¼š\n\n';
                        
                        for (var jobId in response.blocked_jobs) {
                            var info = response.blocked_jobs[jobId];
                            warningMsg += 'â€¢ ' + info.filename + '\n';
                            
                            // é¡¯ç¤ºç‰ˆæœ¬åç¨±å’Œå»ºç«‹è€…
                            var versionList = info.versions.map(function(v) {
                                return v.file_name + ' (å»ºç«‹è€…ï¼š' + v.creator_name + ')';
                            }).join('ã€');
                            
                            warningMsg += '  ç‰ˆæœ¬ï¼š' + versionList + '\n\n';
                        }
                        
                        warningMsg += 'åˆªé™¤å¾Œé€™äº›ç‰ˆæœ¬å°‡ç„¡æ³•é‡æ–°é–‹å•Ÿæ ¡å°é é¢ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒåˆªé™¤å—ï¼Ÿ';
                        
                        if (confirm(warningMsg)) {
                            // ä½¿ç”¨è€…ç¢ºèªå¾Œï¼Œå¼·åˆ¶åˆªé™¤
                            batchDeleteJobs(true);
                        }
                    } else if (response.ok) {
                        // æ²’æœ‰ç‰ˆæœ¬ä½¿ç”¨ï¼Œç›´æ¥åˆªé™¤æˆåŠŸ
                        showNotification('å·²åˆªé™¤ ' + response.deleted_count + ' å€‹æª”æ¡ˆ', 'success');
                        selectedDocs = [];
                        loadCaseJobs();
                    }
                },
                error: function (xhr, status, error) {
                    hideLoading();
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    
                    // å˜—è©¦è§£æéŒ¯èª¤è¨Šæ¯
                    var errorMsg = 'åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    showNotification(errorMsg, 'danger');
                }
            });
        } else {
            // å¼·åˆ¶åˆªé™¤
            showLoading();
            $.ajax({
                url: API_BASE_URL + '/jobs/batch-delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    job_ids: selectedDocs,
                    force: true
                }),
                success: function (response) {
                    hideLoading();
                    showNotification('å·²åˆªé™¤ ' + response.deleted_count + ' å€‹æª”æ¡ˆ', 'success');
                    selectedDocs = [];
                    loadCaseJobs();
                },
                error: function (xhr, status, error) {
                    hideLoading();
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    showNotification('åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
                }
            });
        }
    }

    // æ›´æ–°é¸æ“‡ UI
    function updateSelectionUI() {
        if (selectedDocs.length > 0) {
            $('#selected-count').show().text('å·²é¸æ“‡ ' + selectedDocs.length + ' å€‹æª”æ¡ˆ');
            $('#batch-delete-btn').show();
            $('#goto-verification-btn').prop('disabled', false).attr('title', 'å‰å¾€æ ¡å°é é¢');
        } else {
            $('#selected-count').hide();
            $('#batch-delete-btn').hide();
            $('#goto-verification-btn').prop('disabled', true).attr('title', 'è¦å‹¾é¸æª”æ¡ˆå¾Œæ‰å¯ä»¥å‰å¾€æ ¡å°é é¢');
        }

        // æª¢æŸ¥é¸æ“‡çš„æª”æ¡ˆæ˜¯å¦ç¬¦åˆè¦å‰‡
        var allSelectableWithCurrentSelection = true;
        if (selectedDocs.length > 0) {
            allJobs.forEach(function (job) {
                var statusUpper = (job.status || '').toUpperCase();
                if (statusUpper === 'COMPLETED' && !isJobSelectable(job)) {
                    allSelectableWithCurrentSelection = false;
                }
            });
        }

        // é¡¯ç¤ºè­¦å‘Š
        if (!allSelectableWithCurrentSelection && selectedDocs.length > 0) {
            $('#type-mismatch-alert').show();
        } else {
            $('#type-mismatch-alert').hide();
        }
        
        // æ›´æ–°å…¨é¸æŒ‰éˆ•ç‹€æ…‹
        updateSelectAllButtonState();
    }

    // æ›´æ–°å…¨é¸æŒ‰éˆ•ç‹€æ…‹
    function updateSelectAllButtonState() {
        var filteredDocs = getFilteredDocs();
        var completedDocs = filteredDocs.filter(function(d) {
            var statusUpper = (d.status || '').toUpperCase();
            return statusUpper === 'COMPLETED';
        });
        
        if (completedDocs.length === 0) {
            // æ²’æœ‰å·²å®Œæˆçš„æª”æ¡ˆï¼Œç¦ç”¨å…¨é¸æŒ‰éˆ•
            $('#select-all').prop('disabled', true).prop('checked', false);
            return;
        }
        
        $('#select-all').prop('disabled', false);
        
        // è¨ˆç®—ç•¶å‰é¡å‹ä¸‹å¯é¸æ“‡çš„æª”æ¡ˆæ•¸é‡
        var selectableCount = 0;
        var selectedCount = 0;
        
        // ğŸ†• å„ªå…ˆæª¢æŸ¥filteræ˜¯å¦æœ‰é¸æ“‡ç‰¹å®šé¡å‹
        var filterValue = $('#filter-type').val();
        var targetType = null;
        var targetStream = null;
        
        if (filterValue && filterValue !== 'all') {
            // å¾filterç²å–é¡å‹å’Œæ”¶æ”¯æ–¹å‘
            if (filterValue === '401' || filterValue === '403') {
                targetType = filterValue;
                targetStream = null;
            } else if (filterValue === 'all-income') {
                targetType = 'all-income';
                targetStream = 'æ”¶å…¥';
            } else if (filterValue === 'all-expense') {
                targetType = 'all-expense';
                targetStream = 'æ”¯å‡º';
            } else {
                var parts = filterValue.split('-');
                if (parts.length >= 2) {
                    targetStream = parts[parts.length - 1];
                    targetType = parts.slice(0, -1).join('-');
                }
            }
        } else if (selectedDocs.length > 0) {
            // å¦‚æœfilteræ²’æœ‰é¸æ“‡ï¼Œä½†æœ‰é¸æ“‡æª”æ¡ˆï¼Œæ ¹æ“šç¬¬ä¸€å€‹é¸æ“‡çš„æª”æ¡ˆæ±ºå®šé¡å‹
            var firstSelectedJob = allJobs.find(function(j) { return j.id === selectedDocs[0]; });
            if (firstSelectedJob) {
                targetType = firstSelectedJob.document_type;
                targetStream = firstSelectedJob.detected_stream;
            }
        }
        
        if (targetType) {
            // æœ‰æ˜ç¢ºçš„ç›®æ¨™é¡å‹ï¼Œè¨ˆç®—å¯é¸æª”æ¡ˆ
            completedDocs.forEach(function(doc) {
                var isSelectable = false;
                if (targetType === '401' || targetType === '403') {
                    isSelectable = doc.type === targetType;
                } else if (targetType === 'all-income') {
                    isSelectable = (doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
                                 doc.detected_stream === 'æ”¶å…¥';
                } else if (targetType === 'all-expense') {
                    isSelectable = (doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
                                 doc.detected_stream === 'æ”¯å‡º';
                } else {
                    isSelectable = doc.type === targetType && doc.detected_stream === targetStream;
                }
                
                if (isSelectable) {
                    selectableCount++;
                    if (selectedDocs.includes(doc.id)) {
                        selectedCount++;
                    }
                }
            });
        } else {
            // æ²’æœ‰æ˜ç¢ºçš„ç›®æ¨™é¡å‹ï¼Œä¸è¨ˆç®—ä»»ä½•æª”æ¡ˆç‚ºå¯é¸
            selectableCount = 0;
        }
        
        // è¨­å®šå…¨é¸æŒ‰éˆ•ç‹€æ…‹
        if (selectableCount === 0) {
            $('#select-all').prop('checked', false);
        } else if (selectedCount === selectableCount && selectedCount > 0) {
            $('#select-all').prop('checked', true);
        } else {
            $('#select-all').prop('checked', false);
        }
    }

    // ç²å–æ–‡ä»¶é¡å‹é¡¯ç¤ºæ–‡å­—ï¼ˆåŠ å…¥ detected_streamï¼‰
    function getDocTypeDisplay(doc) {
        var baseType = docTypeLabels[doc.type] || doc.type;

        // å¦‚æœæ˜¯ withholding é¡å‹ï¼ˆåŒ…æ‹¬è‚¡åˆ©æ†‘å–®ï¼‰ä¸”å·²å®Œæˆè¾¨è­˜ï¼ˆæœ‰ detected_streamï¼‰ï¼ŒåŠ ä¸Šæ”¶å…¥/æ”¯å‡ºæ¨™ç±¤
        var statusUpper = (doc.status || '').toUpperCase();
        if ((doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
            doc.detected_stream &&
            statusUpper === 'COMPLETED') {
            return baseType + (streamLabels[doc.detected_stream] || '');
        }

        return baseType;
    }

    // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç·¨è¼¯æ”¶æ”¯æ–¹å‘
    function canEditStream(doc) {
        var statusUpper = (doc.status || '').toUpperCase();
        return (doc.type === 'withholding-slip' || doc.type === 'withholding-statement' || doc.type === 'dividend-slip') &&
            statusUpper === 'COMPLETED' &&
            doc.detected_stream;
    }

    // æª¢æ¸¬é‡è¤‡æª”æ¡ˆåç¨±
    function findDuplicateFiles(docs) {
        var fileNameCounts = {};
        var duplicates = new Set();

        // è¨ˆç®—æ¯å€‹æª”æ¡ˆåç¨±çš„å‡ºç¾æ¬¡æ•¸
        docs.forEach(function (doc) {
            var fileName = doc.name;
            if (fileNameCounts[fileName]) {
                fileNameCounts[fileName]++;
            } else {
                fileNameCounts[fileName] = 1;
            }
        });

        // æ‰¾å‡ºé‡è¤‡çš„æª”æ¡ˆåç¨±
        Object.keys(fileNameCounts).forEach(function (fileName) {
            if (fileNameCounts[fileName] > 1) {
                docs.forEach(function (doc) {
                    if (doc.name === fileName) {
                        duplicates.add(doc.id);
                    }
                });
            }
        });

        return duplicates;
    }

    // æ›´æ–° Job çš„æ”¶æ”¯æ–¹å‘
    function updateJobStream(jobId, newStream) {
        showLoading();
        $.ajax({
            url: API_BASE_URL + '/jobs/' + jobId + '/stream',
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({
                detected_stream: newStream
            }),
            success: function (response) {
                hideLoading();
                showNotification('å·²æ›´æ–°æ”¶æ”¯æ–¹å‘ç‚ºã€Œ' + newStream + 'ã€', 'success');

                // æ›´æ–°æœ¬åœ°è³‡æ–™
                var doc = documents.find(function (d) { return d.id === jobId; });
                if (doc) {
                    doc.detected_stream = newStream;
                }

                var job = allJobs.find(function (j) { return j.id === jobId; });
                if (job) {
                    job.detected_stream = newStream;
                }

                // é‡æ–°æ¸²æŸ“
                renderDocuments();
            },
            error: function (xhr, status, error) {
                hideLoading();
                console.error('æ›´æ–°æ”¶æ”¯æ–¹å‘å¤±æ•—:', error);
                var errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                showNotification(errorMsg, 'danger');
            }
        });
    }

    // é¡¯ç¤ºç·¨è¼¯æ”¶æ”¯æ–¹å‘çš„å°è©±æ¡†
    function showEditStreamDialog(jobId, currentStream) {
        var newStream = currentStream === 'æ”¯å‡º' ? 'æ”¶å…¥' : 'æ”¯å‡º';
        var message = 'ç¢ºå®šè¦å°‡æ”¶æ”¯æ–¹å‘å¾ã€Œ' + currentStream + 'ã€æ”¹ç‚ºã€Œ' + newStream + 'ã€å—ï¼Ÿ';

        if (confirm(message)) {
            updateJobStream(jobId, newStream);
        }
    }

    function getFilteredDocs() {
        var typeFilter = $('#filter-type').val();
        var statusFilter = $('#filter-status').val();

        return documents.filter(function (d) {
            // é¡å‹ç¯©é¸ï¼ˆåˆä½µ document_type å’Œ detected_streamï¼‰
            var matchType = true;
            if (typeFilter !== 'all') {
                if (typeFilter === 'all-income') {
                    // æ‰€æœ‰æ”¶å…¥ï¼šå°å¼µæ”¶å…¥ + å¤§å¼µæ”¶å…¥ + è‚¡åˆ©æ†‘å–®æ”¶å…¥
                    matchType = (d.type === 'withholding-slip' || d.type === 'withholding-statement' || d.type === 'dividend-slip') &&
                        d.detected_stream === 'æ”¶å…¥';
                } else if (typeFilter === 'all-expense') {
                    // æ‰€æœ‰æ”¯å‡ºï¼šå°å¼µæ”¯å‡º + å¤§å¼µæ”¯å‡º + è‚¡åˆ©æ†‘å–®æ”¯å‡º
                    matchType = (d.type === 'withholding-slip' || d.type === 'withholding-statement' || d.type === 'dividend-slip') &&
                        d.detected_stream === 'æ”¯å‡º';
                } else if (typeFilter === '401' || typeFilter === '403') {
                    // 401/403 ç›´æ¥æ¯”å°
                    matchType = d.type === typeFilter;
                } else {
                    // å¤§å¼µ/å°å¼µéœ€è¦æ¯”å° type å’Œ stream
                    // æ³¨æ„ï¼šwithholding-slip-æ”¯å‡º æœƒè¢«åˆ†å‰²æˆ ['withholding', 'slip', 'æ”¯å‡º']
                    // æ‰€ä»¥æˆ‘å€‘éœ€è¦æ‰¾åˆ°æœ€å¾Œä¸€å€‹ '-' çš„ä½ç½®
                    var lastDashIndex = typeFilter.lastIndexOf('-');
                    var filterType = typeFilter.substring(0, lastDashIndex);  // 'withholding-slip'ã€'withholding-statement' æˆ– 'dividend-slip'
                    var filterStream = typeFilter.substring(lastDashIndex + 1); // 'æ”¯å‡º' æˆ– 'æ”¶å…¥'
                    matchType = (d.type === filterType && d.detected_stream === filterStream);

                    // Debug: é¡¯ç¤ºç¯©é¸æ¢ä»¶
                    if (window.DEBUG_FILTER) {
                        console.log('ç¯©é¸æ¢ä»¶:', {
                            typeFilter: typeFilter,
                            filterType: filterType,
                            filterStream: filterStream,
                            docType: d.type,
                            docStream: d.detected_stream,
                            match: matchType
                        });
                    }
                }
            }

            // ç‹€æ…‹ç¯©é¸ï¼ˆæ”¯æ´å¤§å°å¯«ï¼‰
            var statusUpper = (d.status || '').toUpperCase();
            var matchStatus = statusFilter === 'all' ||
                (statusFilter === 'completed' && statusUpper === 'COMPLETED') ||
                (statusFilter === 'processing' && statusUpper === 'PROCESSING') ||
                (statusFilter === 'error' && statusUpper === 'FAILED') ||
                (statusFilter === 'pending' && (statusUpper === 'PENDING' || statusUpper === 'WAITING_CLASSIFICATION' || statusUpper === 'WAITING_CONFIRMATION'));

            return matchType && matchStatus;
        });
    }

    function renderDocuments() {
        var filtered = getFilteredDocs();

        // æŒ‰ç•¶å‰é¸æ“‡çš„æ–¹å¼æ’åº
        filtered = sortDocuments(filtered);

        // Update UI
        updateSelectionUI();

        if (filtered.length === 0) {
            $('#documents-table').html(
                '<tr><td colspan="6" class="text-center" style="padding: 60px 0;">' +
                '<i class="fa fa-file-o" style="font-size: 48px; color: #ccc;"></i>' +
                '<p class="text-muted" style="margin-top: 15px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æª”æ¡ˆ</p>' +
                '</td></tr>'
            );
            return;
        }

        // æª¢æ¸¬é‡è¤‡æª”æ¡ˆåç¨±
        var duplicateFiles = findDuplicateFiles(filtered);

        var html = '';
        filtered.forEach(function (doc) {
            // æ‰¾åˆ°å°æ‡‰çš„å®Œæ•´ Job è³‡æ–™
            var job = allJobs.find(function (j) { return j.id === doc.id; });
            var canSelect = job ? isJobSelectable(job) : false;

            var statusUpper = (doc.status || '').toUpperCase();
            var statusClass = statusUpper === 'COMPLETED' ? 'success' :
                statusUpper === 'PROCESSING' ? 'warning' :
                    statusUpper === 'FAILED' ? 'danger' : 'default';
            var statusLabel = statusUpper === 'COMPLETED' ? 'è¾¨è­˜å®Œæˆ' :
                statusUpper === 'PROCESSING' ? 'è¾¨è­˜ä¸­' :
                    statusUpper === 'FAILED' ? 'è¾¨è­˜å¤±æ•—' : 'å¾…è¾¨è­˜';
            var isSelected = selectedDocs.includes(doc.id);

            // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç·¨è¼¯æ”¶æ”¯æ–¹å‘
            var canEdit = canEditStream(doc);
            var editButton = canEdit ?
                '<button class="btn btn-default btn-xs stream-edit-btn" onclick="showEditStreamDialog(' + doc.id + ', \'' + doc.detected_stream + '\')" ' +
                'title="åˆ‡æ›æ”¶æ”¯æ–¹å‘" style="margin-left: 5px; padding: 2px 6px; font-size: 11px;">' +
                '<i class="fa fa-exchange"></i>' +
                '</button>' : '';

            // æª”æ¡ˆåç¨±é€£çµï¼ˆå·²å®Œæˆè¾¨è­˜çš„æª”æ¡ˆéƒ½å¯é»æ“Šï¼‰
            var fileNameHtml = '';
            if (statusUpper === 'COMPLETED') {
                // æ‰€æœ‰å·²å®Œæˆè¾¨è­˜çš„æª”æ¡ˆéƒ½å¯ä»¥é»æ“Šé€²å…¥æ ¡å°é é¢
                fileNameHtml = '<i class="fa fa-file-text-o" style="margin-right: 8px; color: #3498db;"></i>' +
                    '<a href="/verification?jobIds=' + doc.id + '&view_mode=single" ' +
                    'style="color: #3498db; text-decoration: underline;" ' +
                    'title="' + doc.name + '">' +  // é¡¯ç¤ºå®Œæ•´æª”æ¡ˆåç¨±
                    doc.name +
                    '</a>';
            } else {
                fileNameHtml = '<i class="fa fa-file-text-o" style="margin-right: 8px; color: #3498db;"></i>' +
                    '<span title="' + doc.name + '">' + doc.name + '</span>';  // é¡¯ç¤ºå®Œæ•´æª”æ¡ˆåç¨±
            }

            html += '<tr>' +
                '<td class="text-center">' +
                '<input type="checkbox" class="doc-checkbox" data-id="' + doc.id + '" ' +
                (isSelected ? 'checked' : '') + ' ' +
                (canSelect ? '' : 'disabled') + '>' +
                '</td>' +
                '<td class="text-center" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + doc.name + '">' +
                fileNameHtml +
                '</td>' +
                '<td class="text-center">' +
                '<div style="display: inline-flex; align-items: center; gap: 5px; white-space: nowrap;">' +
                '<span class="badge badge-default">' + getDocTypeDisplay(doc) + '</span>' +
                editButton +
                '</div>' +
                '</td>' +
                '<td class="text-center text-muted">' + doc.uploadedAt + '</td>' +
                '<td class="text-center">' +
                '<span class="badge badge-' + statusClass + '">' + statusLabel + '</span>' +
                (duplicateFiles.has(doc.id) ?
                    '<i class="fa fa-exclamation-triangle" style="color: #f39c12; margin-left: 8px; cursor: help;" ' +
                    'title="è©²æª”æ¡ˆé‡è¤‡ä¸Šå‚³" data-toggle="tooltip" data-placement="top"></i>' : '') +
                '</td>' +
                '<td class="text-center">' +
                '<div class="btn-group btn-group-xs" role="group">' +
                '<button class="btn btn-info" onclick="showEditHistory(' + doc.id + ')" title="æŸ¥çœ‹ç·¨è¼¯è»Œè·¡" ' +
                'style="padding: 3px 8px; font-size: 12px; border-radius: 3px 0 0 3px;">' +
                '<i class="fa fa-history"></i>' +
                '</button>' +
                '<button class="btn btn-danger" onclick="deleteDoc(' + doc.id + ')" title="åˆªé™¤æª”æ¡ˆ" ' +
                'style="padding: 3px 8px; font-size: 12px; border-radius: 0 3px 3px 0;">' +
                '<i class="fa fa-trash"></i>' +
                '</button>' +
                '</div>' +
                '</td>' +
                '</tr>';
            
            // ğŸ†• å¦‚æœæ˜¯å¤±æ•—ç‹€æ…‹ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯è¡Œ
            if (statusUpper === 'FAILED' && job && job.error_message) {
                var errorInfo = parseErrorMessage(job.error_message);
                // ä½¿ç”¨ data å±¬æ€§ä¾†é¿å…å­—ä¸²è½‰ç¾©å•é¡Œ
                var errorDataId = 'error-data-' + doc.id;
                html += '<tr class="error-row" style="background-color: #f2dede;">' +
                    '<td></td>' +
                    '<td colspan="5" style="padding: 10px 15px;">' +
                    '<div style="display: flex; align-items: start; gap: 10px;">' +
                    '<i class="fa fa-exclamation-circle" style="color: #a94442; font-size: 18px; margin-top: 2px; flex-shrink: 0;"></i>' +
                    '<div style="flex: 1; min-width: 0; overflow: hidden;">' +
                    '<div><strong style="color: #a94442;">éŒ¯èª¤é¡å‹ï¼š</strong> <span id="' + errorDataId + '-type">' + escapeHtml(errorInfo.error_type) + '</span></div>' +
                    '<div style="margin-top: 4px;"><strong style="color: #a94442;">éŒ¯èª¤è¨Šæ¯ï¼š</strong></div>' +
                    '<div class="error-message-text" id="' + errorDataId + '-msg" style="margin-top: 2px; padding: 8px; background: #fff; border: 1px solid #ebccd1; border-radius: 4px;">' + escapeHtml(errorInfo.error_message) + '</div>' +
                    '<div style="margin-top: 8px;">' +
                    '<button class="btn btn-xs btn-info" onclick="copyErrorMessageById(' + doc.id + ')">' +
                    '<i class="fa fa-copy"></i> è¤‡è£½éŒ¯èª¤è¨Šæ¯' +
                    '</button>' +
                    // éš±è—çš„ data å®¹å™¨
                    '<div id="' + errorDataId + '" style="display: none;" ' +
                    'data-job-id="' + doc.id + '" ' +
                    'data-file-name="' + escapeHtml(errorInfo.file_name) + '" ' +
                    'data-error-type="' + escapeHtml(errorInfo.error_type) + '" ' +
                    'data-error-message="' + escapeHtml(errorInfo.error_message) + '">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';
            }
        });

        $('#documents-table').html(html);

        // åˆå§‹åŒ– tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // Bind checkbox events
        $('.doc-checkbox').change(function () {
            var id = parseInt($(this).data('id'));
            if ($(this).prop('checked')) {
                if (!selectedDocs.includes(id)) {
                    selectedDocs.push(id);
                }
            } else {
                selectedDocs = selectedDocs.filter(function (docId) { return docId !== id; });
            }
            renderDocuments();
        });
    }

    function deleteDoc(id, force) {
        // ç¬¬ä¸€æ¬¡å‘¼å«æ™‚å…ˆé¡¯ç¤ºç¢ºèªæç¤º
        if (!force) {
            // å…ˆè©¢å•ä½¿ç”¨è€…æ˜¯å¦ç¢ºå®šè¦åˆªé™¤
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
                return;
            }
            
            showLoading();
            $.ajax({
                url: API_BASE_URL + '/jobs/' + id,
                method: 'DELETE',
                success: function (response) {
                    hideLoading();
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰è­¦å‘Šï¼ˆæª”æ¡ˆè¢«ç‰ˆæœ¬ä½¿ç”¨ï¼‰
                    if (response.warning && response.versions) {
                        var versionList = response.versions.map(function(v) {
                            return v.file_name + ' (å»ºç«‹è€…ï¼š' + v.creator_name + ')';
                        }).join('\n');
                        
                        var confirmMsg = 'æ­¤æª”æ¡ˆå·²å»ºç«‹éä»¥ä¸‹ç‰ˆæœ¬ï¼š\n' + versionList + '\n\n' +
                                       'åˆªé™¤å¾Œé€™äº›ç‰ˆæœ¬å°‡ç„¡æ³•é‡æ–°é–‹å•Ÿæ ¡å°é é¢ã€‚\n\n' +
                                       'ç¢ºå®šè¦ç¹¼çºŒåˆªé™¤å—ï¼Ÿ';
                        
                        if (confirm(confirmMsg)) {
                            // ä½¿ç”¨è€…ç¢ºèªå¾Œï¼Œå¼·åˆ¶åˆªé™¤
                            deleteDoc(id, true);
                        }
                    } else if (response.ok) {
                        // æ²’æœ‰ç‰ˆæœ¬ä½¿ç”¨ï¼Œç›´æ¥åˆªé™¤æˆåŠŸ
                        showNotification('å·²åˆªé™¤æª”æ¡ˆ', 'success');
                        selectedDocs = selectedDocs.filter(function (docId) { return docId !== id; });
                        loadCaseJobs();
                    }
                },
                error: function (xhr, status, error) {
                    hideLoading();
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    showNotification('åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
                }
            });
        } else {
            // å¼·åˆ¶åˆªé™¤
            showLoading();
            $.ajax({
                url: API_BASE_URL + '/jobs/' + id + '?force=true',
                method: 'DELETE',
                success: function (response) {
                    hideLoading();
                    showNotification('å·²åˆªé™¤æª”æ¡ˆ', 'success');
                    selectedDocs = selectedDocs.filter(function (docId) { return docId !== id; });
                    loadCaseJobs();
                },
                error: function (xhr, status, error) {
                    hideLoading();
                    console.error('åˆªé™¤å¤±æ•—:', error);
                    showNotification('åˆªé™¤æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'danger');
                }
            });
        }
    }

    // é¡¯ç¤ºç·¨è¼¯è»Œè·¡
    function showEditHistory(jobId) {
        // æ‰¾åˆ°å°æ‡‰çš„ Job
        var job = allJobs.find(function(j) { return j.id === jobId; });
        if (!job) {
            showNotification('æ‰¾ä¸åˆ°æª”æ¡ˆè³‡è¨Š', 'danger');
            return;
        }

        // é¡¯ç¤º Modal
        $('#editHistoryModal').modal('show');
        $('#history-filename').text(job.original_filename);
        $('#history-loading').show();
        $('#history-content').hide();
        $('#history-empty').hide();

        // è¼‰å…¥ç·¨è¼¯è»Œè·¡
        $.ajax({
            url: API_BASE_URL + '/jobs/' + jobId + '/logs',
            method: 'GET',
            success: function(logs) {
                $('#history-loading').hide();
                
                if (logs.length === 0) {
                    $('#history-empty').show();
                    return;
                }

                // æ¸²æŸ“è»Œè·¡åˆ—è¡¨
                var html = '';
                logs.forEach(function(log) {
                    var actionLabel = log.action_type === 'edit' ? 'ç·¨è¼¯è³‡æ–™' : 
                                     log.action_type === 'delete' ? 'åˆªé™¤æª”æ¡ˆ' : 'å»ºç«‹ç‰ˆæœ¬';
                    var actionIcon = log.action_type === 'edit' ? 'fa-edit' : 
                                    log.action_type === 'delete' ? 'fa-trash' : 'fa-file-archive-o';
                    var actionClass = log.action_type === 'edit' ? 'text-primary' : 
                                     log.action_type === 'delete' ? 'text-danger' : 'text-success';
                    
                    html += '<tr>' +
                        '<td class="text-center">' + formatDateTime(log.created_at) + '</td>' +
                        '<td class="text-center">' +
                        '<strong>' + (log.user_name || 'N/A') + '</strong><br>' +
                        '<small class="text-muted">' + (log.user_email || '') + '</small>' +
                        '</td>' +
                        '<td>' +
                        '<i class="fa ' + actionIcon + ' ' + actionClass + '"></i> ' +
                        '<strong>' + actionLabel + '</strong><br>' +
                        '<small class="text-muted">' + (log.change_summary || '') + '</small>' +
                        '</td>' +
                        '</tr>';
                });

                $('#history-table-body').html(html);
                $('#history-content').show();
            },
            error: function(xhr, status, error) {
                $('#history-loading').hide();
                console.error('è¼‰å…¥ç·¨è¼¯è»Œè·¡å¤±æ•—:', error);
                showNotification('è¼‰å…¥ç·¨è¼¯è»Œè·¡å¤±æ•—', 'danger');
                $('#editHistoryModal').modal('hide');
            }
        });
    }

    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ï¼ˆæ›´è©³ç´°ï¼‰
    function formatDateTime(dateStr) {
        if (!dateStr) return 'N/A';
        var date = new Date(dateStr);
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        var seconds = String(date.getSeconds()).padStart(2, '0');
        return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }

    // ============ ğŸ†• éŒ¯èª¤è™•ç†å‡½æ•¸ ============

    function escapeHtml(text) {
        /**
         * è½‰ç¾©HTMLç‰¹æ®Šå­—å…ƒï¼Œé˜²æ­¢XSSæ”»æ“Š
         */
        if (!text) return '';
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function parseErrorMessage(errorMessage) {
        /**
         * è§£æéŒ¯èª¤è¨Šæ¯ï¼Œæ”¯æ´æ–°èˆŠæ ¼å¼
         */
        if (!errorMessage) {
            return {
                file_name: 'Unknown',
                error_type: 'Unknown',
                error_message: 'æœªçŸ¥éŒ¯èª¤'
            };
        }

        try {
            // å˜—è©¦è§£ææ–°æ ¼å¼ï¼ˆJSONï¼‰
            var errorInfo = JSON.parse(errorMessage);
            return {
                file_name: errorInfo.file_name || 'Unknown',
                error_type: errorInfo.error_type || 'Unknown',
                error_message: errorInfo.error_message || errorMessage
            };
        } catch (e) {
            // èˆŠæ ¼å¼ï¼ˆç´”æ–‡å­—ï¼‰
            return {
                file_name: 'Unknown',
                error_type: 'ProcessingError',
                error_message: errorMessage
            };
        }
    }

    function copyErrorMessageById(jobId) {
        /**
         * å¾dataå±¬æ€§è®€å–éŒ¯èª¤è¨Šæ¯ä¸¦è¤‡è£½åˆ°å‰ªè²¼ç°¿
         */
        console.log('ğŸ” é–‹å§‹è¤‡è£½éŒ¯èª¤è¨Šæ¯ï¼ŒJob ID:', jobId);
        
        var errorDataId = 'error-data-' + jobId;
        var errorDataEl = document.getElementById(errorDataId);
        
        if (!errorDataEl) {
            console.error('âŒ æ‰¾ä¸åˆ°éŒ¯èª¤è³‡æ–™å…ƒç´ :', errorDataId);
            showNotification('ç„¡æ³•æ‰¾åˆ°éŒ¯èª¤è³‡æ–™', 'warning');
            return;
        }
        
        console.log('âœ… æ‰¾åˆ°éŒ¯èª¤è³‡æ–™å…ƒç´ ');
        
        var fileName = errorDataEl.getAttribute('data-file-name');
        var errorType = errorDataEl.getAttribute('data-error-type');
        var errorMessage = errorDataEl.getAttribute('data-error-message');
        
        console.log('ğŸ“‹ éŒ¯èª¤è³‡æ–™:', {
            fileName: fileName,
            errorType: errorType,
            errorMessage: errorMessage ? errorMessage.substring(0, 50) + '...' : null
        });
        
        var errorText = 'Tax-OCR éŒ¯èª¤å ±å‘Š\n' +
            'Job ID: ' + jobId + '\n' +
            'æª”æ¡ˆåç¨±: ' + fileName + '\n' +
            'éŒ¯èª¤é¡å‹: ' + errorType + '\n' +
            'éŒ¯èª¤è¨Šæ¯: ' + errorMessage + '\n' +
            'æ™‚é–“: ' + new Date().toLocaleString();

        console.log('ğŸ“ æº–å‚™è¤‡è£½çš„æ–‡å­—é•·åº¦:', errorText.length);

        // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            console.log('âœ… ä½¿ç”¨ Clipboard API');
            navigator.clipboard.writeText(errorText).then(function() {
                console.log('âœ… è¤‡è£½æˆåŠŸ');
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(function(err) {
                console.error('âŒ Clipboard API è¤‡è£½å¤±æ•—:', err);
                fallbackCopyTextToClipboard(errorText);
            });
        } else {
            // èˆŠç€è¦½å™¨çš„ fallback æ–¹æ³•
            console.log('âš ï¸ Clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ fallback æ–¹æ³•');
            fallbackCopyTextToClipboard(errorText);
        }
    }

    function copyErrorMessage(jobId, fileName, errorType, errorMessage) {
        /**
         * è¤‡è£½éŒ¯èª¤è¨Šæ¯åˆ°å‰ªè²¼ç°¿ï¼ˆèˆŠç‰ˆæœ¬ï¼Œä¿ç•™ä»¥ä¾¿ç›¸å®¹ï¼‰
         */
        var errorText = 'Tax-OCR éŒ¯èª¤å ±å‘Š\n' +
            'Job ID: ' + jobId + '\n' +
            'æª”æ¡ˆåç¨±: ' + fileName + '\n' +
            'éŒ¯èª¤é¡å‹: ' + errorType + '\n' +
            'éŒ¯èª¤è¨Šæ¯: ' + errorMessage + '\n' +
            'æ™‚é–“: ' + new Date().toLocaleString();

        // ä½¿ç”¨ç¾ä»£ç€è¦½å™¨çš„ Clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(errorText).then(function() {
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            }).catch(function(err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                fallbackCopyTextToClipboard(errorText);
            });
        } else {
            // èˆŠç€è¦½å™¨çš„ fallback æ–¹æ³•
            fallbackCopyTextToClipboard(errorText);
        }
    }

    function fallbackCopyTextToClipboard(text) {
        /**
         * èˆŠç€è¦½å™¨çš„è¤‡è£½æ–¹æ³•
         */
        console.log('ğŸ”„ ä½¿ç”¨ fallback è¤‡è£½æ–¹æ³•');
        
        var textArea = document.createElement("textarea");
        textArea.value = text;
        
        // é¿å…åœ¨ iOS ä¸Šå‡ºç¾ç¸®æ”¾
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            var successful = document.execCommand('copy');
            console.log('ğŸ“‹ execCommand çµæœ:', successful);
            
            if (successful) {
                showNotification('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
            } else {
                showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'warning');
            }
        } catch (err) {
            console.error('âŒ Fallback è¤‡è£½å¤±æ•—:', err);
            showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'warning');
        }

        document.body.removeChild(textArea);
    }

    // ============ ğŸ†• ç‹€æ…‹è‡ªå‹•è¼ªè©¢åŠŸèƒ½ ============

    var statusPollingInterval = null;
    var isPollingActive = false;
    var POLLING_INTERVAL_MS = 1000;  // 1 ç§’è¼ªè©¢ä¸€æ¬¡

    /**
     * æª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦è¼ªè©¢çš„æª”æ¡ˆï¼ˆè¾¨è­˜ä¸­æˆ–å¾…è¾¨è­˜ï¼‰
     */
    function hasActiveJobs() {
        return documents.some(function(doc) {
            var statusUpper = (doc.status || '').toUpperCase();
            return statusUpper === 'PROCESSING' || statusUpper === 'PENDING' ||
                   statusUpper === 'WAITING_CLASSIFICATION' || statusUpper === 'WAITING_CONFIRMATION';
        });
    }

    /**
     * è¼•é‡ç´šç‹€æ…‹æ›´æ–°ï¼šåªæ›´æ–°ç‹€æ…‹ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹è¡¨æ ¼
     */
    function pollJobStatuses() {
        // å¦‚æœæ²’æœ‰éœ€è¦æ›´æ–°çš„æª”æ¡ˆï¼Œåœæ­¢è¼ªè©¢
        if (!hasActiveJobs()) {
            console.log('âœ… æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œæˆï¼Œåœæ­¢è¼ªè©¢');
            stopStatusPolling();
            return;
        }

        // ç™¼é€è«‹æ±‚å–å¾—æœ€æ–°ç‹€æ…‹
        $.ajax({
            url: API_BASE_URL + '/cases/' + caseId + '/jobs',
            method: 'GET',
            success: function(jobs) {
                var hasChanges = false;

                jobs.forEach(function(job) {
                    // æ‰¾åˆ°å°æ‡‰çš„æœ¬åœ°è³‡æ–™
                    var localDoc = documents.find(function(d) { return d.id === job.id; });
                    var localJob = allJobs.find(function(j) { return j.id === job.id; });

                    if (localDoc && localDoc.status !== job.status) {
                        console.log('ğŸ”„ ç‹€æ…‹è®Šæ›´:', job.original_filename, localDoc.status, '->', job.status);
                        hasChanges = true;

                        // æ›´æ–°æœ¬åœ°è³‡æ–™
                        localDoc.status = job.status;
                        localDoc.detected_stream = job.detected_stream;

                        if (localJob) {
                            localJob.status = job.status;
                            localJob.detected_stream = job.detected_stream;
                            localJob.error_message = job.error_message;
                        }

                        // ğŸ†• ç›´æ¥æ›´æ–° DOM ä¸­çš„ç‹€æ…‹ badgeï¼ˆé¿å…é‡æ–°æ¸²æŸ“æ•´å€‹è¡¨æ ¼ï¼‰
                        updateStatusBadgeInDOM(job.id, job.status, job.error_message);
                    }
                });

                // å¦‚æœæœ‰è®Šæ›´ï¼Œæ›´æ–°ç›¸é—œ UIï¼ˆä½†ä¸é‡æ–°æ¸²æŸ“è¡¨æ ¼ï¼‰
                if (hasChanges) {
                    updateSelectionUI();
                    updateSelectAllButtonState();
                }

                // æª¢æŸ¥æ˜¯å¦é‚„éœ€è¦ç¹¼çºŒè¼ªè©¢
                if (!hasActiveJobs()) {
                    console.log('âœ… æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œæˆï¼Œåœæ­¢è¼ªè©¢');
                    stopStatusPolling();
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ ç‹€æ…‹è¼ªè©¢å¤±æ•—:', error);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¸åœæ­¢è¼ªè©¢ï¼Œä¸‹æ¬¡æœƒé‡è©¦
            }
        });
    }

    /**
     * ç›´æ¥æ›´æ–° DOM ä¸­çš„ç‹€æ…‹ badgeï¼Œé¿å…é‡æ–°æ¸²æŸ“æ•´å€‹è¡¨æ ¼
     */
    function updateStatusBadgeInDOM(jobId, newStatus, errorMessage) {
        var statusUpper = (newStatus || '').toUpperCase();
        var statusClass = statusUpper === 'COMPLETED' ? 'success' :
            statusUpper === 'PROCESSING' ? 'warning' :
            statusUpper === 'FAILED' ? 'danger' : 'default';
        var statusLabel = statusUpper === 'COMPLETED' ? 'è¾¨è­˜å®Œæˆ' :
            statusUpper === 'PROCESSING' ? 'è¾¨è­˜ä¸­' :
            statusUpper === 'FAILED' ? 'è¾¨è­˜å¤±æ•—' : 'å¾…è¾¨è­˜';

        // æ‰¾åˆ°è©²æª”æ¡ˆçš„ checkbox æ‰€åœ¨çš„ row
        var $checkbox = $('.doc-checkbox[data-id="' + jobId + '"]');
        if ($checkbox.length === 0) return;

        var $row = $checkbox.closest('tr');

        // æ›´æ–°ç‹€æ…‹æ¬„ä½ï¼ˆç¬¬ 5 å€‹ tdï¼‰
        var $statusCell = $row.find('td').eq(4);

        // ä¿ç•™é‡è¤‡æª”æ¡ˆè­¦å‘Šåœ–ç¤ºï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        var $warningIcon = $statusCell.find('.fa-exclamation-triangle').clone();

        // æ›´æ–°ç‹€æ…‹ badge
        $statusCell.html('<span class="badge badge-' + statusClass + '">' + statusLabel + '</span>');

        // å¦‚æœæœ‰è­¦å‘Šåœ–ç¤ºï¼ŒåŠ å›å»
        if ($warningIcon.length > 0) {
            $statusCell.append($warningIcon);
        }

        // ğŸ†• å¦‚æœè®Šæˆå®Œæˆç‹€æ…‹ï¼Œæ›´æ–° checkbox ç‚ºå¯é¸
        if (statusUpper === 'COMPLETED') {
            $checkbox.prop('disabled', false);

            // æ›´æ–°æª”æ¡ˆåç¨±ç‚ºå¯é»æ“Šé€£çµ
            var doc = documents.find(function(d) { return d.id === jobId; });
            if (doc) {
                var $nameCell = $row.find('td').eq(1);
                var currentHtml = $nameCell.html();

                // å¦‚æœé‚„ä¸æ˜¯é€£çµï¼Œè½‰æ›ç‚ºé€£çµ
                if (currentHtml.indexOf('<a ') === -1) {
                    $nameCell.html(
                        '<i class="fa fa-file-text-o" style="margin-right: 8px; color: #3498db;"></i>' +
                        '<a href="/verification?jobIds=' + doc.id + '&view_mode=single" ' +
                        'style="color: #3498db; text-decoration: underline;" ' +
                        'title="' + doc.name + '">' + doc.name + '</a>'
                    );
                }
            }
        }

        // ğŸ†• å¦‚æœè®Šæˆå¤±æ•—ç‹€æ…‹ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯è¡Œ
        if (statusUpper === 'FAILED' && errorMessage) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰éŒ¯èª¤è¡Œ
            var $nextRow = $row.next('tr.error-row');
            if ($nextRow.length === 0) {
                // æ²’æœ‰éŒ¯èª¤è¡Œï¼Œéœ€è¦æ–°å¢
                var errorInfo = parseErrorMessage(errorMessage);
                var errorDataId = 'error-data-' + jobId;
                var errorRowHtml = '<tr class="error-row" style="background-color: #f2dede;">' +
                    '<td></td>' +
                    '<td colspan="5" style="padding: 10px 15px;">' +
                    '<div style="display: flex; align-items: start; gap: 10px;">' +
                    '<i class="fa fa-exclamation-circle" style="color: #a94442; font-size: 18px; margin-top: 2px; flex-shrink: 0;"></i>' +
                    '<div style="flex: 1; min-width: 0; overflow: hidden;">' +
                    '<div><strong style="color: #a94442;">éŒ¯èª¤é¡å‹ï¼š</strong> <span>' + escapeHtml(errorInfo.error_type) + '</span></div>' +
                    '<div style="margin-top: 4px;"><strong style="color: #a94442;">éŒ¯èª¤è¨Šæ¯ï¼š</strong></div>' +
                    '<div class="error-message-text" style="margin-top: 2px; padding: 8px; background: #fff; border: 1px solid #ebccd1; border-radius: 4px;">' + escapeHtml(errorInfo.error_message) + '</div>' +
                    '<div style="margin-top: 8px;">' +
                    '<button class="btn btn-xs btn-info" onclick="copyErrorMessageById(' + jobId + ')">' +
                    '<i class="fa fa-copy"></i> è¤‡è£½éŒ¯èª¤è¨Šæ¯' +
                    '</button>' +
                    '<div id="' + errorDataId + '" style="display: none;" ' +
                    'data-job-id="' + jobId + '" ' +
                    'data-file-name="' + escapeHtml(errorInfo.file_name) + '" ' +
                    'data-error-type="' + escapeHtml(errorInfo.error_type) + '" ' +
                    'data-error-message="' + escapeHtml(errorInfo.error_message) + '">' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '</tr>';

                $row.after(errorRowHtml);
            }
        }
    }

    /**
     * å•Ÿå‹•ç‹€æ…‹è¼ªè©¢
     */
    function startStatusPolling() {
        if (isPollingActive) return;

        // æª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦è¼ªè©¢çš„æª”æ¡ˆ
        if (!hasActiveJobs()) {
            console.log('ğŸ’¤ æ²’æœ‰éœ€è¦è¼ªè©¢çš„æª”æ¡ˆ');
            return;
        }

        console.log('ğŸš€ å•Ÿå‹•ç‹€æ…‹è¼ªè©¢ï¼ˆæ¯ ' + (POLLING_INTERVAL_MS / 1000) + ' ç§’ï¼‰');
        isPollingActive = true;

        statusPollingInterval = setInterval(pollJobStatuses, POLLING_INTERVAL_MS);
    }

    /**
     * åœæ­¢ç‹€æ…‹è¼ªè©¢
     */
    function stopStatusPolling() {
        if (!isPollingActive) return;

        console.log('â¹ï¸ åœæ­¢ç‹€æ…‹è¼ªè©¢');
        isPollingActive = false;

        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
    }

    // é é¢é›¢é–‹æ™‚åœæ­¢è¼ªè©¢
    $(window).on('beforeunload', function() {
        stopStatusPolling();
    });
</script>
{% endblock %}