# KK-1 扣繳申報書解析器

## 簡介

此工具用於解析「扣繳單位稅籍編號扣繳暨免扣繳憑單申報書」（KK-1 表單）的 PDF 文件，並將其轉換為結構化的 JSON 格式。

## 表單說明

KK-1 表單是財政部臺北國稅局用於扣繳憑單申報的表格，主要包含：

- **基本資訊**：扣繳單位統一編號、稅籍編號、名稱、地址、扣繳義務人等
- **所得項目**：各類所得的給付金額和扣繳稅額，分為「個人」和「非個人」兩類
  - 薪資（代號 3）
  - 機關團體補助費（代號 21）
  - 執行機關等獎給（代號 22）
  - 國內利息（代號 4）
  - 租金（代號 51）
  - 權利金（代號 52）
  - 股利或盈餘（代號 11、12）
  - 其他所得（代號 A）
  - 等
- **合計**：總份數、給付總額、扣繳稅額

## 版本說明

此項目提供三個版本的解析器，各有特色：

| 版本 | 檔案名稱 | OCR 支援 | 解析準確度 | 適用場景 |
|------|---------|---------|-----------|---------|
| **V3** ✨ | `parse_kk1_v3.py` | ✅ 是 | ⭐⭐⭐ 高 | **推薦**，支援所有 PDF 類型 |
| **V2** | `parse_kk1_v2.py` | ❌ 否 | ⭐⭐⭐ 高 | 僅文本型 PDF，解析邏輯改進 |
| **V1** | `parse_kk1.py` | ✅ 是 | ⭐⭐ 中 | 基礎版，OCR 支援 |

### 版本特點

**V3（推薦）**：
- ✅ 結合 V1 的 OCR 支援 + V2 的改進解析邏輯
- ✅ 自動檢測 PDF 類型（文本型 vs 掃描版）
- ✅ 更好的容錯能力，處理 OCR 識別錯誤
- ✅ 支援寬鬆匹配模式，提高提取成功率

**V2**：
- ✅ 改進的正則表達式，更準確的數據提取
- ✅ 完整的所得項目解析（個人 + 非個人）
- ❌ 不支援掃描版 PDF

**V1**：
- ✅ 基礎 OCR 支援
- ⚠️ 解析邏輯較簡單，可能遺漏部分數據

## 使用方法

### V3 版本（推薦）

```bash
# 基本用法
python parse_kk1_v3.py <PDF檔案路徑> [輸出JSON路徑]

# 範例
python parse_kk1_v3.py KK-1.pdf
python parse_kk1_v3.py T107掃描版.pdf output.json
```

### V2 版本（僅文本型 PDF）

```bash
python parse_kk1_v2.py <PDF檔案路徑> [輸出JSON路徑]
```

### V1 版本（基礎版）

```bash
python parse_kk1.py <PDF檔案路徑> [輸出JSON路徑]
```

## 輸出格式

### V3 版本輸出格式（推薦）

V3 版本輸出更完整的 JSON 結構，包含個人/非個人分類和總計：

```json
{
  "表單類型": "各類所得扣繳暨免扣繳憑單申報書",
  "表單編號": "KK-1",
  "基本資訊": {
    "統一編號": "04701378",
    "扣繳單位稅籍編號": "0204357",
    "房屋稅籍編號": "A17190837010",
    "名稱": "台灣科思創股份有限公司",
    "地址": "台北市信義區信義路五段二號十樓",
    "扣繳義務人": "",
    "申報期間": "113年01月01日至113年12月31日止"
  },
  "所得項目": [
    {
      "所得類別": "薪資",
      "代號": "3",
      "個人": {
        "份數": 363,
        "起迄號碼": "01000000-A0000355",
        "給付總額": 457747443,
        "扣繳稅額": 13538697
      },
      "非個人": {
        "份數": 0,
        "起迄號碼": "",
        "給付總額": 0,
        "扣繳稅額": 0
      }
    },
    {
      "所得類別": "稿費等項",
      "代號": "21",
      "個人": {
        "份數": 12,
        "起迄號碼": "0B000000-0B000011",
        "給付總額": 5204247,
        "扣繳稅額": 515670
      },
      "非個人": {
        "份數": 0,
        "起迄號碼": "",
        "給付總額": 0,
        "扣繳稅額": 0
      }
    }
  ],
  "合計": {
    "個人": {
      "份數": 368,
      "給付總額": 467189348,
      "扣繳稅額": 14204711
    },
    "非個人": {
      "份數": 19,
      "給付總額": 6842884,
      "扣繳稅額": 515670
    },
    "總計": {
      "份數": 387,
      "給付總額": 474032232,
      "扣繳稅額": 14720381
    }
  },
  "其他資訊": {
    "聯絡電話": "02-87262640",
    "聯絡人": "陳潔盈",
    "印表日期": "114年01月08日",
    "收件編號": "4A030086",
    "申報次數": "001",
    "申報時間": "2025/01/08 15:53:30",
    "稽徵所": "信義分局",
    "退撫金額_不計入薪資收入課稅": 6884219
  }
}
```

### V1/V2 版本輸出格式

較簡化的結構（詳見各版本輸出示例）。

## 重要說明

### PDF 格式限制

如果您的 PDF 是**圖像格式**（掃描件），需要使用 OCR 技術來提取文本。請安裝以下依賴：

```bash
# 安裝 OCR 相關套件
pip install pdf2image pytesseract

# macOS 安裝 Tesseract OCR 引擎
brew install tesseract tesseract-lang

# Ubuntu/Debian
sudo apt-get install tesseract-ocr tesseract-ocr-chi-tra

# Windows
# 從 https://github.com/UB-Mannheim/tesseract/wiki 下載安裝
```

### V3 版本已實現的功能

✅ **自動 OCR 檢測**：自動識別掃描版 PDF 並使用 OCR
✅ **基本資訊解析**：統一編號、名稱、地址、扣繳義務人等
✅ **完整所得項目解析**：支援所有所得類別（薪資、稿費、租賃、退職所得等）
✅ **個人/非個人分類**：正確區分個人與非個人所得
✅ **合計數據解析**：個人合計、非個人合計、總計
✅ **其他資訊提取**：退撫金額、聯絡人、申報時間等
✅ **容錯處理**：處理 OCR 識別錯誤（如 `|`、全角符號等）
✅ **起迄號碼提取**：完整提取憑單起迄號碼

### 範例數據

以下是使用 V3 版本解析實際掃描版 PDF 的結果（T107 表單）：

**扣繳單位**：台灣科思創股份有限公司

**合計數據**：
- **個人**：368 份，給付總額 467,189,348 元，扣繳稅額 14,204,711 元
- **非個人**：19 份，給付總額 6,842,884 元，扣繳稅額 515,670 元
- **總計**：387 份，給付總額 474,032,232 元，扣繳稅額 14,720,381 元

**主要所得項目**：
- **薪資（代號 3）**：363 份，給付總額 457,747,443 元
- **稿費等項（代號 21）**：12 份，給付總額 5,204,247 元
- **租賃（代號 51）**：1 份，給付總額 2,487,624 元

**其他資訊**：
- 退撫金額（不計入薪資收入課稅）：6,884,219 元
- 聯絡人：陳潔盈
- 申報時間：2025/01/08 15:53:30

## 與 401 表單的差異

| 項目 | 401 表單 | KK-1 表單 |
|------|---------|-----------|
| 用途 | 營業稅申報 | 扣繳憑單申報 |
| 主要內容 | 銷項、進項、稅額計算 | 各類所得、給付金額、扣繳稅額 |
| 分類方式 | 應稅/零稅率銷售額 | 個人/非個人所得 |
| 解析器 | `parse_401.py` | `parse_kk1.py` |

## 技術架構

- **PDF 處理**：pdfplumber（主要）、pdf2image（OCR）
- **OCR 引擎**：pytesseract + Tesseract
- **語言支援**：繁體中文
- **輸出格式**：JSON（UTF-8 編碼）

## 故障排除

### 問題：PDF 無法提取文本

**原因**：PDF 可能是圖像格式
**解決方案**：安裝 OCR 依賴（見上方說明）

### 問題：OCR 辨識率低

**原因**：PDF 解析度不足或圖像品質差
**解決方案**：
1. 使用更高解析度的 PDF
2. 調整 OCR 參數
3. 手動校對 JSON 輸出

### 問題：某些欄位無法解析

**原因**：表單格式變化或特殊情況
**解決方案**：檢查 JSON 輸出，手動補充缺失欄位

## 授權

此工具僅供學習和研究使用，請遵守相關法律法規。

## 在 Python 程式中使用

### V3 版本範例

```python
from parse_kk1_v3 import FormKK1ParserV3

# 創建解析器
parser = FormKK1ParserV3("T107.pdf", use_ocr=True)

# 解析 PDF
data = parser.parse()

# 訪問基本資訊
print(f"扣繳單位: {data['基本資訊']['名稱']}")
print(f"統一編號: {data['基本資訊']['統一編號']}")

# 訪問合計數據
print(f"\n個人合計:")
print(f"  份數: {data['合計']['個人']['份數']:,}")
print(f"  給付總額: {data['合計']['個人']['給付總額']:,} 元")
print(f"  扣繳稅額: {data['合計']['個人']['扣繳稅額']:,} 元")

print(f"\n非個人合計:")
print(f"  份數: {data['合計']['非個人']['份數']:,}")
print(f"  給付總額: {data['合計']['非個人']['給付總額']:,} 元")

# 遍歷所得項目
print(f"\n所得項目明細:")
for item in data['所得項目']:
    if item['個人']['給付總額'] > 0:
        print(f"  {item['所得類別']} (個人): {item['個人']['給付總額']:,} 元")
    if item['非個人']['給付總額'] > 0:
        print(f"  {item['所得類別']} (非個人): {item['非個人']['給付總額']:,} 元")

# 保存為 JSON
parser.save_json("output.json")
```

## 更新日誌

- **2025-12-22**：新增 V3 版本，結合 OCR 支援和改進解析邏輯
- **2024-12-19**：新增 V2 版本，改進解析邏輯
- **2024-12-19**：初始版本（V1），支援基本解析功能和 OCR
